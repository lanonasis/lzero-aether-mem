"use strict";var se=Object.create;var I=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var de=Object.getPrototypeOf,le=Object.prototype.hasOwnProperty;var pe=(n,e)=>{for(var t in e)I(n,t,{get:e[t],enumerable:!0})},B=(n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of ce(e))!le.call(n,r)&&r!==t&&I(n,r,{get:()=>e[r],enumerable:!(o=ae(e,r))||o.enumerable});return n};var C=(n,e,t)=>(t=n!=null?se(de(n)):{},B(e||!n||!n.__esModule?I(t,"default",{value:n,enumerable:!0}):t,n)),ue=n=>B(I({},"__esModule",{value:!0}),n);var je={};pe(je,{activate:()=>Ke,deactivate:()=>Me});module.exports=ue(je);var a=C(require("vscode"));var T={MEMORIES:"lzero.memories.cache",PENDING_QUEUE:"lzero.memories.pending",LAST_SYNC:"lzero.memories.lastSync"},K=class{constructor(e,t,o="https://api.lanonasis.com/api/v1"){this.context=e;this.output=t;this.apiUrl=o;this.memories=[];this.pendingQueue=[];this.lastSyncAt=null;this.isSyncing=!1;this.isOnline=!0;this.connectivityCheckInterval=null;this.loadFromStorage(),this.setupNetworkListener()}loadFromStorage(){try{let e=this.context.globalState.get(T.MEMORIES,[]),t=this.context.globalState.get(T.PENDING_QUEUE,[]),o=this.context.globalState.get(T.LAST_SYNC,null);this.memories=e,this.pendingQueue=t,this.lastSyncAt=o,this.output.appendLine(`[MemoryCache] Loaded ${this.memories.length} cached memories, ${this.pendingQueue.length} pending`)}catch(e){this.output.appendLine(`[MemoryCache] Load error: ${e}`)}}async saveToStorage(){try{await this.context.globalState.update(T.MEMORIES,this.memories),await this.context.globalState.update(T.PENDING_QUEUE,this.pendingQueue),await this.context.globalState.update(T.LAST_SYNC,this.lastSyncAt)}catch(e){this.output.appendLine(`[MemoryCache] Save error: ${e}`)}}setupNetworkListener(){this.isOnline=!0,this.startConnectivityCheck()}startConnectivityCheck(){this.connectivityCheckInterval||(this.connectivityCheckInterval=setInterval(async()=>{try{let e=new AbortController,t=setTimeout(()=>e.abort(),5e3),o=`${this.apiUrl}/health`,r=await fetch(o,{method:"GET",signal:e.signal});clearTimeout(t);let i=!this.isOnline;this.isOnline=r.ok,i&&this.isOnline&&this.output.appendLine("[MemoryCache] Network restored - online")}catch{this.isOnline&&this.output.appendLine("[MemoryCache] Network check failed - marking offline"),this.isOnline=!1}},3e4))}stopConnectivityCheck(){this.connectivityCheckInterval&&(clearInterval(this.connectivityCheckInterval),this.connectivityCheckInterval=null)}getStatus(){return{isOnline:this.isOnline,lastSyncAt:this.lastSyncAt,pendingCount:this.pendingQueue.length,isSyncing:this.isSyncing}}getMemories(){return[...this.memories]}getPendingQueue(){return[...this.pendingQueue]}getMemoryById(e){return this.memories.find(t=>t.id===e||t._localId===e)}async clearAll(){this.memories=[],this.pendingQueue=[],this.lastSyncAt=null,await this.saveToStorage()}async updateFromApi(e){this.memories=e.map(t=>({...t,_cachedAt:Date.now()})),this.lastSyncAt=Date.now(),this.isOnline=!0,await this.saveToStorage(),this.output.appendLine(`[MemoryCache] Updated cache with ${e.length} memories from API`)}async addLocal(e){let t=`local_${Date.now()}_${Math.random().toString(36).slice(2)}`,o=new Date().toISOString(),r={...e,id:t,created_at:o,updated_at:o,_pending:"create",_localId:t,_cachedAt:Date.now()};return this.memories.unshift(r),this.pendingQueue.push(r),await this.saveToStorage(),this.output.appendLine(`[MemoryCache] Added local memory: ${r.title}`),r}async markSynced(e,t){let o=this.memories.findIndex(r=>r.id===e||r._localId===e);o!==-1&&(this.memories[o]={...t,_pending:void 0,_localId:void 0,_cachedAt:Date.now()}),this.pendingQueue=this.pendingQueue.filter(r=>r._localId!==e&&r.id!==e),await this.saveToStorage()}async removePending(e){this.pendingQueue=this.pendingQueue.filter(t=>t.id!==e&&t._localId!==e),this.memories=this.memories.filter(t=>t.id!==e),await this.saveToStorage()}async queueUpdate(e,t){let o=this.memories.findIndex(s=>s.id===e);if(o===-1){this.output.appendLine(`[MemoryCache] queueUpdate: memory not found for id ${e}`);return}let r=this.memories[o]._pending;this.memories[o]={...this.memories[o],...t,updated_at:new Date().toISOString(),_pending:r==="create"?"create":"update",_cachedAt:Date.now()};let i=this.pendingQueue.findIndex(s=>s.id===e);i!==-1?this.pendingQueue[i]=this.memories[o]:this.pendingQueue.push(this.memories[o]),await this.saveToStorage()}async queueDelete(e){let t=this.memories.find(o=>o.id===e);if(t){if(t._localId&&t._pending==="create")this.memories=this.memories.filter(o=>o.id!==e),this.pendingQueue=this.pendingQueue.filter(o=>o.id!==e);else{let o={...t,_pending:"delete"};this.memories=this.memories.filter(i=>i.id!==e);let r=this.pendingQueue.findIndex(i=>i.id===e);r!==-1?this.pendingQueue[r]=o:this.pendingQueue.push(o)}await this.saveToStorage()}}searchLocal(e){let t=e.toLowerCase();return this.memories.filter(o=>o.title.toLowerCase().includes(t)||o.content.toLowerCase().includes(t)||o.tags.some(r=>r.toLowerCase().includes(t)))}semanticSearchLocal(e){let t=e.toLowerCase(),o=[/find\s+(?:my\s+)?(.+)/i,/search\s+(?:for\s+)?(.+)/i,/show\s+(?:me\s+)?(.+)/i,/get\s+(?:my\s+)?(.+)/i,/recall\s+(.+)/i,/what\s+(?:was|were|is|are)\s+(?:my\s+)?(.+)/i,/where\s+(?:is|are|did)\s+(?:my\s+)?(.+)/i],r=t;for(let d of o){let p=t.match(d);if(p){r=p[1]||p[2]||t;break}}let i=["the","a","an","my","that","this","about","notes","note","memory","memories"],s=r.split(/\s+/).filter(d=>d.length>2&&!i.includes(d));return s.length===0?this.memories.slice(0,5):this.memories.map(d=>{let p=0,h=d.title.toLowerCase(),A=d.content.toLowerCase(),f=d.tags.map(m=>m.toLowerCase());for(let m of s)h.includes(m)&&(p+=3),A.includes(m)&&(p+=1),f.some(k=>k.includes(m))&&(p+=2);return{memory:d,score:p}}).filter(d=>d.score>0).sort((d,p)=>p.score-d.score).slice(0,10).map(d=>d.memory)}setOnline(e){this.isOnline=e}setSyncing(e){this.isSyncing=e}};var b=C(require("vscode")),he="lanonasis.memory",M=class{constructor(e,t,o,r,i){this.context=e;this.output=t;this.cache=o;this.apiUrl=r;this.getApiKey=i}register(){if(!b.chat?.createChatParticipant){this.output.appendLine("[ChatParticipant] Chat API not available in this VS Code version");return}try{this.participant=b.chat.createChatParticipant(he,this.handleRequest.bind(this)),this.participant.iconPath=b.Uri.joinPath(this.context.extensionUri,"media","icon.png"),this.participant.followupProvider={provideFollowups:this.provideFollowups.bind(this)},this.context.subscriptions.push(this.participant),this.output.appendLine("[ChatParticipant] Registered @memory chat participant")}catch(e){this.output.appendLine(`[ChatParticipant] Registration failed: ${e}`)}}async handleRequest(e,t,o,r){let i=e.prompt.trim(),s=e.command;if(this.output.appendLine(`[ChatParticipant] Request: "${i}", command: "${s||"none"}"`),s)switch(s){case"save":return this.handleCreate(i||"Untitled memory",o);case"find":let d=await this.parseIntent(i||"");return this.handleSearch({...d,query:i},o,r);case"list":return this.handleList(o);default:break}let l=await this.parseIntent(i);switch(l.action){case"search":return this.handleSearch(l,o,r);case"create":return this.handleCreate(i,o);case"list":return this.handleList(o);default:return this.handleHelp(o)}}async parseIntent(e){let t=e.toLowerCase().trim();if(t==="help"||t==="?"||t.includes("how do i")||t.includes("what can you"))return{memories:[],action:"help"};if(t==="list"||t==="show all"||t==="all memories"||/^(list|show)\s*(all|my)?\s*memories?$/i.test(t))return{memories:this.cache.getMemories().slice(0,10),action:"list"};let o=[/^save\s+(.+)/i,/^create\s+(?:a\s+)?(?:memory|note)\s*:?\s*(.+)/i,/^remember\s+(.+)/i,/^store\s+(.+)/i,/^\/save\s+(.+)/i];for(let i of o){let s=e.match(i);if(s&&s[1])return this.output.appendLine(`[ChatParticipant] Detected create intent: "${s[1]}"`),{memories:[],action:"create",query:e}}let r=this.cache.semanticSearchLocal(e);return r.length===0?{memories:await this.searchApi(e),action:"search",query:e}:{memories:r,action:"search",query:e}}async searchApi(e){try{let t=await this.getApiKey();if(!t)return[];let o=await fetch(`${this.apiUrl}/memories/search`,{method:"POST",headers:{"X-API-Key":t,"Content-Type":"application/json"},body:JSON.stringify({query:e,limit:5,threshold:.7})});if(!o.ok)return[];let r=await o.json();return r.data?.results||r.results||r.data||r||[]}catch(t){return this.output.appendLine(`[ChatParticipant] API search error: ${t}`),[]}}async handleSearch(e,t,o){if(o.isCancellationRequested)return{metadata:{action:"cancelled"}};if(e.memories.length===0)return t.markdown(`No memories found for "${e.query}".

`),t.markdown("\u{1F4A1} *Try creating a new memory with:* `@memory save [your content]`"),{metadata:{action:"search",found:0}};t.markdown(`## \u{1F9E0} Found ${e.memories.length} relevant memories

`);for(let r of e.memories){let i=r._pending?" *(pending sync)*":"";t.markdown(`### ${r.title}${i}
`),t.markdown(`${r.content.slice(0,200)}${r.content.length>200?"...":""}

`),r.tags.length>0&&t.markdown(`\u{1F3F7}\uFE0F ${r.tags.map(s=>`\`${s}\``).join(" ")}

`),t.markdown(`---

`)}return{metadata:{action:"search",found:e.memories.length}}}async handleCreate(e,t){let o=e.replace(/^(save|create|remember|store)\s*(a\s+)?(memory|note)?\s*:?\s*/i,"").trim();if(!o)return t.markdown(`Please provide content to save. Example:

`),t.markdown("`@memory save OAuth uses PKCE flow for mobile apps`"),{metadata:{action:"create",success:!1}};let r=o.slice(0,50)+(o.length>50?"...":""),i=await this.cache.addLocal({title:r,content:o,memory_type:"knowledge",tags:[]});return t.markdown(`## \u2705 Memory saved

`),t.markdown(`**${i.title}**

`),t.markdown(`${i.content}

`),t.markdown("*Memory will sync when online.*"),this.syncToApi(i),{metadata:{action:"create",success:!0,id:i.id}}}async syncToApi(e){try{let t=await this.getApiKey();if(!t)return;let o=await fetch(`${this.apiUrl}/memories`,{method:"POST",headers:{"X-API-Key":t,"Content-Type":"application/json"},body:JSON.stringify({title:e.title,content:e.content,memory_type:e.memory_type,tags:e.tags})});if(o.ok){let r=await o.json(),i=r.data||r.memory||r;await this.cache.markSynced(e.id,i),this.output.appendLine(`[ChatParticipant] Memory synced: ${e.title}`)}}catch(t){this.output.appendLine(`[ChatParticipant] Sync error: ${t}`)}}handleList(e){let t=this.cache.getMemories().slice(0,10),o=this.cache.getStatus();if(e.markdown(`## \u{1F9E0} Your Memories

`),o.pendingCount>0&&e.markdown(`\u23F3 *${o.pendingCount} memories pending sync*

`),t.length===0)return e.markdown(`No memories yet. Create one with:

`),e.markdown("`@memory save [your content]`"),{metadata:{action:"list",count:0}};for(let r of t){let i=r._pending?" \u{1F504}":"";e.markdown(`- **${r.title}**${i}
`)}return e.markdown(`
*Showing ${t.length} most recent memories*`),{metadata:{action:"list",count:t.length}}}handleHelp(e){return e.markdown(`## \u{1F9E0} L0 Memory Assistant

`),e.markdown(`I help you store and recall your development context.

`),e.markdown(`### Commands

`),e.markdown(`| Command | Description |
`),e.markdown(`|---------|-------------|
`),e.markdown("| `@memory find [query]` | Search your memories |\n"),e.markdown("| `@memory save [content]` | Save a new memory |\n"),e.markdown("| `@memory list` | Show recent memories |\n"),e.markdown("| `@memory help` | Show this help |\n\n"),e.markdown(`### Examples

`),e.markdown("- `@memory find OAuth implementation`\n"),e.markdown("- `@memory what was that regex pattern?`\n"),e.markdown("- `@memory save Use PKCE flow for mobile OAuth`\n"),{metadata:{action:"help"}}}provideFollowups(e,t,o){switch(e.metadata?.action){case"search":return[{prompt:"list",label:"\u{1F4CB} Show all memories"},{prompt:"save ",label:"\u{1F4BE} Save a new memory"}];case"create":return[{prompt:"list",label:"\u{1F4CB} Show all memories"},{prompt:"find ",label:"\u{1F50D} Search memories"}];case"list":return[{prompt:"find ",label:"\u{1F50D} Search memories"},{prompt:"save ",label:"\u{1F4BE} Save a new memory"}];default:return[{prompt:"find ",label:"\u{1F50D} Search memories"},{prompt:"list",label:"\u{1F4CB} Show all memories"}]}}};var y=C(require("vscode")),_=class n{constructor(e,t){this.context=e;this.outputChannel=t;this.migrationCompleted=!1}static{this.API_KEY_KEY="lzero.apiKey"}static{this.API_KEY_RAW_KEY="lzero.apiKey.raw"}static{this.AUTH_TOKEN_KEY="lzero.authToken"}static{this.REFRESH_TOKEN_KEY="lzero.refreshToken"}static{this.CREDENTIAL_TYPE_KEY="lzero.credentialType"}static{this.CALLBACK_PORTS=[8080,8081,8082,8083,3e3,3001]}static{this.OAUTH_TIMEOUT_MS=300*1e3}async initialize(){await this.migrateLegacySecrets()}async getApiKeyOrPrompt(){let e=await this.getApiKey();if(e)return e;let t=await this.getStoredCredentials();return t?.type==="oauth"?t.token:await this.promptForAuthentication()}async getApiKey(){try{let e=await this.context.secrets.get(n.API_KEY_RAW_KEY);if(e)return e;let t=await this.context.secrets.get(n.API_KEY_KEY);return t?await this.context.secrets.get(n.CREDENTIAL_TYPE_KEY)==="oauth"||this.looksLikeJwt(t)?(this.log("Retrieved OAuth token from secure storage (unhashed)"),t):(await this.context.secrets.store(n.API_KEY_RAW_KEY,t),this.log("Migrated plaintext API key to raw storage"),t):null}catch(e){return this.logError("Failed to retrieve API key from secure storage",e),null}}async hasApiKey(){return await this.getApiKey()?!0:await this.getAuthenticationHeader()!==null}async promptForAuthentication(){let e=await y.window.showQuickPick([{label:"$(key) OAuth (Browser)",description:"Authenticate using OAuth2 with browser (Recommended)",value:"oauth"},{label:"$(key) API Key",description:"Enter API key directly",value:"apikey"},{label:"$(circle-slash) Cancel",description:"Cancel authentication",value:"cancel"}],{placeHolder:"Choose authentication method"});return!e||e.value==="cancel"?null:e.value==="oauth"?await this.authenticateWithOAuthFlow():await this.promptForApiKeyEntry()}async authenticateWithOAuthFlow(){if(!await this.authenticateOAuth())return null;let t=await this.getApiKey();if(t)return t;let o=await this.getAuthenticationHeader();return o?.startsWith("Bearer ")?o.replace("Bearer ",""):null}async promptForApiKeyEntry(){let e=await y.window.showInputBox({prompt:"Enter your L0 Memory API Key",placeHolder:"Get your API key from api.lanonasis.com",password:!0,ignoreFocusOut:!0,validateInput:t=>!t||t.trim().length===0?"API key is required":t.length<20?"API key seems too short":null});return e?(await this.storeApiKey(e,"apiKey"),await this.context.secrets.delete(n.AUTH_TOKEN_KEY),await this.context.secrets.delete(n.REFRESH_TOKEN_KEY),this.log("API key stored securely"),e):null}async storeApiKeyDirect(e){await this.storeApiKey(e,"apiKey"),await this.context.secrets.delete(n.AUTH_TOKEN_KEY),await this.context.secrets.delete(n.REFRESH_TOKEN_KEY),this.log("API key stored from webview")}async authenticateOAuth(){try{let t=y.workspace.getConfiguration("lzero").get("authUrl")||"https://auth.lanonasis.com",o="vscode-extension";this.log("Starting Device Code authentication flow...");let r=await fetch(`${t}/oauth/device`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({client_id:o,scope:"memories:read memories:write memories:delete profile"})});if(!r.ok){let f=await r.text();throw new Error(`Failed to request device code: ${r.status} ${f}`)}let i=await r.json();this.log(`Device code received. User code: ${i.user_code}`);let s=await y.window.showInformationMessage(`Enter this code in your browser: ${i.user_code}`,{modal:!0},"Open Browser","Copy Code");if(s==="Open Browser")await y.env.openExternal(y.Uri.parse(i.verification_uri_complete));else if(s==="Copy Code")await y.env.clipboard.writeText(i.user_code),await y.env.openExternal(y.Uri.parse(i.verification_uri)),y.window.showInformationMessage("Code copied! Paste it in the browser window.");else return this.log("User cancelled device code flow"),!1;let l=Math.max((i.interval||5)*1e3,1e3),d=l,p=3e4,h=Date.now()+i.expires_in*1e3,A="urn:ietf:params:oauth:grant-type:device_code";return await y.window.withProgress({location:y.ProgressLocation.Notification,title:"Waiting for authorization...",cancellable:!0},async(f,m)=>{for(;Date.now()<h;){if(m.isCancellationRequested)return this.log("User cancelled device code polling"),!1;await new Promise(k=>setTimeout(k,d));try{let c=await(await fetch(`${t}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:new URLSearchParams({grant_type:A,device_code:i.device_code,client_id:o}).toString()})).json();if(c.error==="authorization_pending"){f.report({message:"Waiting for you to authorize in browser..."}),d=l;continue}if(c.error==="slow_down"){d=Math.min(d*2,p),await new Promise(u=>setTimeout(u,d));continue}if(c.error==="access_denied")return this.log("User denied authorization"),y.window.showWarningMessage("Authorization was denied."),!1;if(c.error==="expired_token")return this.log("Device code expired"),y.window.showWarningMessage("Authorization timed out. Please try again."),!1;if(c.error)throw new Error(c.error_description||c.error);if(c.access_token){await this.storeApiKey(c.access_token,"oauth"),c.refresh_token&&await this.context.secrets.store(n.REFRESH_TOKEN_KEY,c.refresh_token);let u={access_token:c.access_token,expires_at:Date.now()+(c.expires_in?c.expires_in*1e3:36e5)};return await this.context.secrets.store(n.AUTH_TOKEN_KEY,JSON.stringify(u)),this.log("Device code authentication successful!"),y.window.showInformationMessage("\u2713 Authentication successful!"),!0}}catch(k){this.logError("Token polling error",k),d=Math.min(d*2,p)}}return this.log("Device code expired"),y.window.showWarningMessage("Authorization timed out. Please try again."),!1})}catch(e){return this.logError("Device code authentication failed",e),y.env.uiKind===y.UIKind.Web?!1:(this.log("Falling back to PKCE redirect flow..."),await this.authenticateOAuthPKCE())}}async authenticateOAuthPKCE(){if(y.env.uiKind===y.UIKind.Web)return this.log("PKCE flow not supported in web environment"),!1;for(let e of n.CALLBACK_PORTS)try{return await this.tryPKCEWithPort(e)}catch(t){let o=t instanceof Error?t.message:String(t);if(o.includes("EADDRINUSE")||o.includes("already in use")){this.log(`Port ${e} is in use, trying next port...`);continue}throw t}throw this.log("All callback ports are in use"),new Error("Unable to start OAuth callback server - all ports are in use. Please close some applications and try again.")}async tryPKCEWithPort(e){return new Promise((t,o)=>{let r;try{let s=y.workspace.getConfiguration("lzero").get("authUrl")||"https://auth.lanonasis.com",l="vscode-extension",d=`http://localhost:${e}/callback`,p=this.generateCodeVerifier(),h=this.generateState();(async()=>{let f=await this.generateCodeChallenge(p);await this.context.secrets.store("lzero.oauth_code_verifier",p),await this.context.secrets.store("lzero.oauth_state",h);let m=new URL("/oauth/authorize",s);m.searchParams.set("client_id",l),m.searchParams.set("response_type","code"),m.searchParams.set("redirect_uri",d),m.searchParams.set("scope","memories:read memories:write memories:delete profile"),m.searchParams.set("code_challenge",f),m.searchParams.set("code_challenge_method","S256"),m.searchParams.set("state",h);let c=this.getNodeHttp().createServer(async(u,w)=>{try{if(!u.url){w.writeHead(400,{"Content-Type":"text/plain"}),w.end("Missing URL");return}let P=new URL(u.url,`http://localhost:${e}`);if(P.pathname==="/callback"){let S=P.searchParams.get("code"),ne=P.searchParams.get("state"),z=P.searchParams.get("error"),ie=await this.context.secrets.get("lzero.oauth_state");if(ne!==ie){w.writeHead(400,{"Content-Type":"text/html"}),w.end("<h1>Invalid state parameter</h1>"),c.close(),r&&clearTimeout(r),o(new Error("Invalid state parameter"));return}if(z){w.writeHead(400,{"Content-Type":"text/html"}),w.end(`<h1>OAuth Error: ${z}</h1>`),c.close(),r&&clearTimeout(r),o(new Error(`OAuth error: ${z}`));return}if(S){let F=await this.exchangeCodeForToken(S,p,d,s);await this.storeApiKey(F.access_token,"oauth"),F.refresh_token&&await this.context.secrets.store(n.REFRESH_TOKEN_KEY,F.refresh_token),w.writeHead(200,{"Content-Type":"text/html"}),w.end(`
                                  <html>
                                    <head><title>Authentication Success</title></head>
                                    <body>
                                      <h1 style="color: green;">\u2713 Authentication Successful!</h1>
                                      <p>You can close this window and return to VS Code.</p>
                                      <script>setTimeout(() => window.close(), 2000);</script>
                                    </body>
                                  </html>
                                `),await this.context.secrets.delete("lzero.oauth_code_verifier"),await this.context.secrets.delete("lzero.oauth_state"),c.close(),r&&clearTimeout(r),t(!0)}}else w.writeHead(404,{"Content-Type":"text/plain"}),w.end("Not found")}catch(P){w.writeHead(500,{"Content-Type":"text/html"}),w.end(`<h1>Error: ${P instanceof Error?P.message:"Unknown error"}</h1>`),c.close(),r&&clearTimeout(r),o(P)}});c.on("error",u=>{r&&clearTimeout(r),u.code==="EADDRINUSE"?o(new Error(`Port ${e} is already in use. Please close any applications using this port and try again.`)):o(new Error(`Failed to start OAuth callback server: ${u.message}`))}),c.listen(e,"localhost",()=>{this.outputChannel.appendLine(`OAuth callback server listening on port ${e}`),y.env.openExternal(y.Uri.parse(m.toString()))}),r=setTimeout(()=>{c.close(),o(new Error("OAuth authentication timeout"))},n.OAUTH_TIMEOUT_MS)})().catch(f=>{r&&clearTimeout(r),o(f)})}catch(i){r&&clearTimeout(r),o(i)}})}async getAuthenticationHeader(){let e=await this.getStoredCredentials();return e?.type==="oauth"?`Bearer ${e.token}`:null}async getStoredCredentials(){let e=await this.context.secrets.get(n.AUTH_TOKEN_KEY);if(e)try{let o=JSON.parse(e);if(o?.access_token){if(this.isTokenValid(o))return{type:"oauth",token:o.access_token};this.log("Access token expired, attempting refresh...");let r=await this.refreshAccessToken();return r?{type:"oauth",token:r}:(this.log("Token refresh failed, clearing expired credentials"),await this.deleteApiKey(),null)}}catch(o){this.logError("Failed to parse stored OAuth token",o)}let t=await this.getApiKey();if(t){let o=await this.context.secrets.get(n.CREDENTIAL_TYPE_KEY);return{type:o==="oauth"||o==="apiKey"?o:this.looksLikeJwt(t)?"oauth":"apiKey",token:t}}return null}async refreshAccessToken(){try{let e=await this.context.secrets.get(n.REFRESH_TOKEN_KEY);if(!e)return this.log("No refresh token available"),null;let o=y.workspace.getConfiguration("lzero").get("authUrl")||"https://auth.lanonasis.com",r=new URL("/oauth/token",o);this.log(`Refreshing token via ${r.toString()}`);let i=new URLSearchParams({grant_type:"refresh_token",client_id:"vscode-extension",refresh_token:e}),s=await fetch(r.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:i.toString()});if(!s.ok){let p=await s.text();return this.logError(`Token refresh failed: ${s.status}`,p),(s.status===400||s.status===401)&&await this.context.secrets.delete(n.REFRESH_TOKEN_KEY),null}let l=await s.json(),d={access_token:l.access_token,expires_at:Date.now()+(l.expires_in?l.expires_in*1e3:36e5)};return await this.context.secrets.store(n.AUTH_TOKEN_KEY,JSON.stringify(d)),await this.storeApiKey(l.access_token,"oauth"),l.refresh_token&&(await this.context.secrets.store(n.REFRESH_TOKEN_KEY,l.refresh_token),this.log("Refresh token rotated")),this.log("Access token refreshed successfully"),l.access_token}catch(e){return this.logError("Token refresh error",e),null}}async deleteApiKey(){await this.context.secrets.delete(n.API_KEY_KEY),await this.context.secrets.delete(n.API_KEY_RAW_KEY),await this.context.secrets.delete(n.AUTH_TOKEN_KEY),await this.context.secrets.delete(n.REFRESH_TOKEN_KEY),await this.context.secrets.delete(n.CREDENTIAL_TYPE_KEY),this.log("API key removed from secure storage")}async storeApiKey(e,t){if(t==="oauth"){await this.context.secrets.store(n.API_KEY_RAW_KEY,e),await this.context.secrets.store(n.API_KEY_KEY,e),await this.context.secrets.store(n.CREDENTIAL_TYPE_KEY,t);return}await this.context.secrets.store(n.API_KEY_RAW_KEY,e),await this.context.secrets.store(n.API_KEY_KEY,e),await this.context.secrets.store(n.CREDENTIAL_TYPE_KEY,t)}async migrateLegacySecrets(){if(this.migrationCompleted)return;if(await this.hasApiKey()){this.migrationCompleted=!0;return}let t=await this.context.secrets.get("lanonasis.apiKey"),o=await this.context.secrets.get("lanonasis.tokens");if(o)try{let r=JSON.parse(o);r.access_token&&(await this.storeApiKey(r.access_token,"oauth"),this.log("Migrated OAuth token from legacy storage"))}catch(r){this.logError("Failed to migrate legacy tokens",r)}else t&&(await this.storeApiKey(t,"apiKey"),this.log("Migrated API key from legacy storage"));this.migrationCompleted=!0}async exchangeCodeForToken(e,t,o,r){let i=new URL("/oauth/token",r),s=new URLSearchParams({grant_type:"authorization_code",client_id:"vscode-extension",code:e,redirect_uri:o,code_verifier:t}),l=await fetch(i.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:s.toString()});if(!l.ok){let h=await l.text();throw new Error(`Token exchange failed: ${l.status} ${h}`)}let d=await l.json(),p={access_token:d.access_token,expires_at:Date.now()+(d.expires_in?d.expires_in*1e3:36e5)};return await this.context.secrets.store(n.AUTH_TOKEN_KEY,JSON.stringify(p)),{access_token:d.access_token,refresh_token:d.refresh_token}}isTokenValid(e){return e.expires_at?Date.now()<e.expires_at-6e4:!0}looksLikeJwt(e){let t=e.split(".");if(t.length!==3)return!1;let o=/^[A-Za-z0-9-_]+$/;return t.every(r=>o.test(r))}generateCodeVerifier(){let e=this.getRandomBytes(32);return this.base64UrlEncode(e)}async generateCodeChallenge(e){let t=this.getWebCrypto(),o=new TextEncoder().encode(e),r=await t.subtle.digest("SHA-256",o);return this.base64UrlEncode(new Uint8Array(r))}generateState(){let e=this.getRandomBytes(16);return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}getWebCrypto(){if(globalThis.crypto)return globalThis.crypto;throw new Error("WebCrypto is not available in this environment")}getRandomBytes(e){let t=this.getWebCrypto(),o=new Uint8Array(e);return t.getRandomValues(o),o}base64UrlEncode(e){let t;if(typeof Buffer<"u")t=Buffer.from(e).toString("base64");else{let o="";for(let r of e)o+=String.fromCharCode(r);t=btoa(o)}return t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}getNodeHttp(){return this.getNodeRequire()("http")}getNodeRequire(){if(typeof __non_webpack_require__=="function")return __non_webpack_require__;if(typeof require<"u")return require;if(typeof module<"u"&&typeof module.require=="function")return module.require.bind(module);throw new Error("Node require not available in this environment")}log(e){let t=new Date().toISOString();this.outputChannel.appendLine(`[${t}] [SecureApiKeyService] ${e}`)}logError(e,t){let o=t instanceof Error?t.message:String(t);this.log(`${e}: ${o}`),console.error(e,t)}};var me=3e4,x=class{constructor(e,t,o){this.secureApiKeyService=e;this.output=t;this.apiUrl=o}async fetchWithTimeout(e,t,o=me){let r=new AbortController,i=setTimeout(()=>r.abort(),o);try{return await fetch(e,{...t,signal:r.signal})}catch(s){throw s instanceof Error&&s.name==="AbortError"?new Error(`Request timed out after ${o}ms`):s}finally{clearTimeout(i)}}async isAuthenticated(){return await this.secureApiKeyService.hasApiKey()}async getAuthHeaders(){let e=await this.secureApiKeyService.getStoredCredentials();if(!e)throw new Error("Not authenticated");return{"Content-Type":"application/json",Authorization:`Bearer ${e.token}`}}async testConnection(){let e=await this.getAuthHeaders(),t=await this.fetchWithTimeout(`${this.apiUrl}/health`,{method:"GET",headers:e},1e4);if(!t.ok){let o=await t.text();throw new Error(`Health check failed (${t.status}): ${o}`)}}async listMemories(e=100){let t=await this.getAuthHeaders(),o=await this.fetchWithTimeout(`${this.apiUrl}/memories/list?limit=${e}`,{method:"GET",headers:t});if(!o.ok){let s=await o.text();throw new Error(`List memories failed (${o.status}): ${s}`)}let r=await o.json(),i=r.data||r.memories||r||[];return Array.isArray(i)?i:[]}async searchMemories(e,t={}){let o=await this.getAuthHeaders(),r=await this.fetchWithTimeout(`${this.apiUrl}/memories/search`,{method:"POST",headers:o,body:JSON.stringify({query:e,limit:t.limit??10,threshold:t.threshold??.7})});if(!r.ok){let l=await r.text();throw new Error(`Search memories failed (${r.status}): ${l}`)}let i=await r.json(),s=i.data?.results||i.results||i.data||[];return Array.isArray(s)?s:[]}async createMemory(e){let t=await this.getAuthHeaders(),o=await this.fetchWithTimeout(`${this.apiUrl}/memories`,{method:"POST",headers:t,body:JSON.stringify(e)});if(!o.ok){let i=await o.text();throw new Error(`Create memory failed (${o.status}): ${i}`)}let r=await o.json();return r.data||r.memory||r}async updateMemory(e,t){let o=await this.getAuthHeaders(),r=await this.fetchWithTimeout(`${this.apiUrl}/memory/update`,{method:"POST",headers:o,body:JSON.stringify({id:e,...t})});if(!r.ok){let s=await r.text();throw new Error(`Update memory failed (${r.status}): ${s}`)}let i=await r.json();return i.data||i.memory||i}async deleteMemory(e){let t=await this.getAuthHeaders(),o=await this.fetchWithTimeout(`${this.apiUrl}/memory/delete`,{method:"POST",headers:t,body:JSON.stringify({id:e})});if(!o.ok){let r=await o.text();throw new Error(`Delete memory failed (${o.status}): ${r}`)}}async getMemory(e){let t=await this.getAuthHeaders(),o=await this.fetchWithTimeout(`${this.apiUrl}/memory/${encodeURIComponent(e)}`,{method:"GET",headers:t});if(!o.ok){let i=await o.text();throw new Error(`Get memory failed (${o.status}): ${i}`)}let r=await o.json();return r.data||r.memory||r}};var H=C(require("vscode")),Q=3e4,$=class{constructor(e,t){this.secureApiKeyService=e;this.output=t;this.baseUrl="https://api.lanonasis.com";this.userInfoCache=null;this.userInfoCacheExpiry=0;this.config=H.workspace.getConfiguration("lzero"),this.updateConfig()}async fetchWithTimeout(e,t,o=Q){let r=new AbortController,i=setTimeout(()=>r.abort(),o);try{return await fetch(e,{...t,signal:r.signal})}catch(s){throw s instanceof Error&&s.name==="AbortError"?new Error(`Request timed out after ${o}ms`):s}finally{clearTimeout(i)}}updateConfig(){let e=this.config.get("useGateway",!1),t=this.config.get("apiUrl","https://api.lanonasis.com"),o=this.config.get("gatewayUrl","https://api.lanonasis.com");this.baseUrl=this.sanitizeBaseUrl(e?o:t)}refreshConfig(){this.config=H.workspace.getConfiguration("lzero"),this.updateConfig()}async makeRequest(e,t={},o=Q){let r=await this.resolveCredentials(),i=e.startsWith("/")?e:`/${e}`,s=`${this.baseUrl}${i}`,l=r.type==="oauth"?{Authorization:`Bearer ${r.token}`}:{"X-API-Key":r.token},d=await this.fetchWithTimeout(s,{...t,headers:{"Content-Type":"application/json",...l,...t.headers}},o);if(!d.ok){let p=await d.text();throw new Error(`API request failed: ${d.status} ${d.statusText} - ${p}`)}return d.json()}sanitizeBaseUrl(e){if(!e)return"https://api.lanonasis.com";let t=e.trim();return t=t.replace(/\/+$/,""),t=t.replace(/\/api\/v1$/i,"").replace(/\/api$/i,""),t||"https://api.lanonasis.com"}async resolveCredentials(){let e=await this.secureApiKeyService.getStoredCredentials();if(!e){let t=await this.secureApiKeyService.getApiKeyOrPrompt();if(!t)throw new Error("API key not configured. Please configure your API key to use L0 Memory services.");e=await this.secureApiKeyService.getStoredCredentials(),e||(e={type:this.looksLikeJwt(t)?"oauth":"apiKey",token:t})}return e}looksLikeJwt(e){let t=e.split(".");if(t.length!==3)return!1;let o=/^[A-Za-z0-9-_]+$/;return t.every(r=>o.test(r))}async getProjects(){return this.makeRequest("/api/v1/projects")}async getProject(e){return this.makeRequest(`/api/v1/projects/${e}`)}async createProject(e){return this.makeRequest("/api/v1/projects",{method:"POST",body:JSON.stringify(e)})}async updateProject(e,t){return this.makeRequest(`/api/v1/projects/${e}`,{method:"PUT",body:JSON.stringify(t)})}async deleteProject(e){await this.makeRequest(`/api/v1/projects/${e}`,{method:"DELETE"})}async getApiKeys(e){let t=e?`/api/v1/projects/${e}/api-keys`:"/api/v1/auth/api-keys",o=await this.makeRequest(t);return o&&typeof o=="object"&&"data"in o&&Array.isArray(o.data)?o.data:Array.isArray(o)?o:[]}async getApiKey(e){return this.makeRequest(`/api/v1/auth/api-keys/${e}`)}async createApiKey(e){return this.makeRequest("/api/v1/auth/api-keys",{method:"POST",body:JSON.stringify(e)})}async updateApiKey(e,t){return this.makeRequest(`/api/v1/auth/api-keys/${e}`,{method:"PUT",body:JSON.stringify(t)})}async deleteApiKey(e){await this.makeRequest(`/api/v1/auth/api-keys/${e}`,{method:"DELETE"})}async rotateApiKey(e){return this.makeRequest(`/api/v1/auth/api-keys/${e}/rotate`,{method:"POST"})}async testConnection(){try{let e=await this.resolveCredentials();if(e.type==="oauth"){let t=await this.fetchWithTimeout(`${this.baseUrl}/oauth/introspect`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Bearer ${e.token}`},body:new URLSearchParams({token:e.token})},1e4);if(!t.ok){let r=await t.text();return this.log(`OAuth introspection failed: ${t.status} ${t.statusText} - ${r}`),!1}return(await t.json()).active===!0}return await this.makeRequest("/health",{},1e4),!0}catch(e){let t=e instanceof Error?e.message:String(e);return this.log(`Test connection failed: ${t}`),!1}}async getUserInfo(e=!1){let t=Date.now();if(!e&&this.userInfoCache&&this.userInfoCacheExpiry>t)return this.userInfoCache;let o=[{endpoint:"/api/v1/auth/me",method:"GET"},{endpoint:"/api/v1/auth/session",method:"GET"},{endpoint:"/v1/auth/me",method:"GET"},{endpoint:"/v1/auth/session",method:"GET"}],r;for(let{endpoint:i,method:s}of o)try{let l=await this.makeRequest(i,{method:s},1e4),d=this.normalizeUserInfo(l);if(d)return this.userInfoCache=d,this.userInfoCacheExpiry=t+300*1e3,this.log(`User info retrieved from ${i}`),d}catch(l){r=l;let d=String(l);if(!(d.includes("404")||d.includes("405")||d.includes("Method Not Allowed")))break}if(this.userInfoCache=null,this.userInfoCacheExpiry=0,r)throw r instanceof Error?r:new Error(String(r));return null}clearUserInfoCache(){this.userInfoCache=null,this.userInfoCacheExpiry=0}normalizeUserInfo(e){if(!e||typeof e!="object")return null;let t=e,o=this.readUserFields(t);if(o)return o;let r=t.data;if(r&&typeof r=="object"){let l=this.readUserFields(r);if(l)return l}let i=t.session;if(i&&typeof i=="object"){let l=this.readUserFields(i);if(l)return l;let d=i.user;if(d&&typeof d=="object"){let p=this.readUserFields(d);if(p)return p}}let s=t.user;if(s&&typeof s=="object"){let l=this.readUserFields(s);if(l)return l}return null}readUserFields(e){let t=typeof e.id=="string"?e.id:typeof e.user_id=="string"?e.user_id:void 0,o=typeof e.email=="string"?e.email:typeof e.user_email=="string"?e.user_email:void 0,r=typeof e.name=="string"?e.name:typeof e.full_name=="string"?e.full_name:typeof e.username=="string"?e.username:void 0;return!t&&!o&&!r?null:{id:t||"unknown",email:o||"unknown",name:r}}log(e){this.output&&this.output.appendLine(`[ApiKeyService] ${e}`)}};var v=C(require("vscode")),L=class extends v.TreeItem{constructor(t,o){super(t.title,o);this.memory=t;this.tooltip=`${t.title}

Type: ${t.memory_type}
Created: ${new Date(t.created_at).toLocaleDateString()}

${t.content.substring(0,200)}${t.content.length>200?"...":""}`,this.description=t.memory_type,this.contextValue="memory",this.iconPath=this.getIconForMemoryType(t.memory_type),this.command={command:"lzeroMemory.openMemory",title:"Open Memory",arguments:[t]}}getIconForMemoryType(t){switch(t){case"conversation":return new v.ThemeIcon("comment-discussion");case"knowledge":return new v.ThemeIcon("book");case"project":return new v.ThemeIcon("project");case"context":return new v.ThemeIcon("info");case"reference":return new v.ThemeIcon("references");case"personal":return new v.ThemeIcon("account");case"workflow":return new v.ThemeIcon("settings");default:return new v.ThemeIcon("file")}}},E=class extends v.TreeItem{constructor(t,o,r){super(t,r);this.memoryType=t;this.memories=o;this.tooltip=`${t} (${o.length} memories)`,this.description=`${o.length} memories`,this.contextValue="memoryType",this.iconPath=new v.ThemeIcon("folder")}},R=class{constructor(e){this.memoryService=e;this._onDidChangeTreeData=new v.EventEmitter;this.onDidChangeTreeData=this._onDidChangeTreeData.event;this.memories=[];this.loading=!1;this.authenticated=!1;this.setAuthenticated(!1)}async loadMemories(){if(!this.authenticated){this.memories=[],this.loading=!1,this._onDidChangeTreeData.fire();return}try{this.loading=!0,this.memories=await this.memoryService.listMemories(100)}catch(e){this.memories=[],e instanceof Error&&e.message.includes("Not authenticated")||v.window.showErrorMessage(`Failed to load memories: ${e instanceof Error?e.message:"Unknown error"}`)}finally{this.loading=!1,this._onDidChangeTreeData.fire()}}refresh(){if(!this.authenticated){this.clear();return}this.loadMemories()}async setAuthenticated(e){this.authenticated=e,e?this.loadMemories():this.clear()}clear(){this.loading=!1,this.memories=[],this._onDidChangeTreeData.fire()}getTreeItem(e){return e}getChildren(e){return this.authenticated?this.loading?Promise.resolve([]):e?e instanceof E?Promise.resolve(e.memories.map(t=>new L(t,v.TreeItemCollapsibleState.None))):Promise.resolve([]):Promise.resolve(this.getMemoryTypeGroups()):Promise.resolve([])}getMemoryTypeGroups(){let e=["conversation","knowledge","project","context","reference","personal","workflow"],t=[];for(let o of e){let r=this.memories.filter(i=>i.memory_type===o);r.length>0&&t.push(new E(o,r,v.TreeItemCollapsibleState.Collapsed))}return t}getParent(e){if(!this.authenticated)return null;if(e instanceof L){let t=e.memory.memory_type,o=this.memories.filter(r=>r.memory_type===t);return new E(t,o,v.TreeItemCollapsibleState.Collapsed)}return null}};var g=C(require("vscode")),q=class extends g.TreeItem{constructor(e,t){if(super(e.name,t),this.apiKey=e,this.tooltip=`${e.name}
Type: ${e.keyType}
Environment: ${e.environment}
Access Level: ${e.accessLevel}`,this.description=`${e.environment} \u2022 ${e.keyType}`,this.contextValue="apiKey",this.iconPath=this.getIconForKeyType(e.keyType),e.expiresAt){let o=new Date(e.expiresAt),r=new Date,i=Math.floor((o.getTime()-r.getTime())/(1e3*60*60*24));i<=7&&(this.description+=` \u26A0\uFE0F Expires in ${i} days`)}}getIconForKeyType(e){let t={api_key:"key",database_url:"database",oauth_token:"account",certificate:"certificate",ssh_key:"terminal",webhook_secret:"webhook",encryption_key:"shield"};return new g.ThemeIcon(t[e]||"key")}},O=class extends g.TreeItem{constructor(e,t){super(e.name,t),this.project=e,this.tooltip=`${e.name}
${e.description||"No description"}
Organization: ${e.organizationId}`,this.description=e.description?e.description.substring(0,50)+"...":"No description",this.contextValue="project",this.iconPath=new g.ThemeIcon("folder")}},U=class{constructor(e,t){this.apiKeyService=e;this.output=t;this._onDidChangeTreeData=new g.EventEmitter;this.onDidChangeTreeData=this._onDidChangeTreeData.event;this.projects=[];this.apiKeys={};this.authenticated=!1}refresh(e=!1){e&&this.clearCache(),this._onDidChangeTreeData.fire()}setAuthenticated(e){this.authenticated=e,e?(this.clear(),this.refresh()):this.clear()}clear(){this.clearCache(),this._onDidChangeTreeData.fire()}getTreeItem(e){return e}async getChildren(e){if(!this.authenticated){let t=new g.TreeItem("Not authenticated",g.TreeItemCollapsibleState.None);return t.description="Click to authenticate",t.iconPath=new g.ThemeIcon("key"),t.contextValue="notAuthenticated",t.command={command:"lzeroMemory.authenticate",title:"Authenticate",arguments:["oauth"]},[t]}try{if(!e){if(this.projects=await this.apiKeyService.getProjects(),this.projects.length===0){let t=new g.TreeItem("No projects found",g.TreeItemCollapsibleState.None);return t.description="Click + to create a project",t.iconPath=new g.ThemeIcon("info"),t.contextValue="empty",[t]}return this.projects.map(t=>new O(t,g.TreeItemCollapsibleState.Collapsed))}if(e instanceof O){let t=e.project.id;if(this.apiKeys[t]||(this.apiKeys[t]=await this.apiKeyService.getApiKeys(t)),this.apiKeys[t].length===0){let o=new g.TreeItem("No API keys in this project",g.TreeItemCollapsibleState.None);return o.description="Right-click project to create a key",o.iconPath=new g.ThemeIcon("info"),o.contextValue="empty",[o]}return this.apiKeys[t].map(o=>new q(o,g.TreeItemCollapsibleState.None))}}catch(t){let o=t instanceof Error?t.message:String(t);this.output.appendLine(`[ApiKeyTreeProvider] Error loading API keys: ${o}`);let r=t instanceof Error?t.message:"Unknown error";if(r.includes("401")||r.includes("No token")||r.includes("AUTH_TOKEN_MISSING")){let s=new g.TreeItem("Authentication required",g.TreeItemCollapsibleState.None);return s.description="Click to authenticate",s.iconPath=new g.ThemeIcon("warning"),s.contextValue="authRequired",s.command={command:"lzeroMemory.authenticate",title:"Authenticate",arguments:["oauth"]},s.tooltip=`Authentication error: ${r}`,[s]}if(r.includes("405")||r.includes("404")||r.includes("Not Found")){let s=new g.TreeItem("API Key Management",g.TreeItemCollapsibleState.None);return s.description="Not available on this server",s.iconPath=new g.ThemeIcon("info"),s.contextValue="notAvailable",s.tooltip="The API key management endpoints are not available on the current server.",[s]}let i=new g.TreeItem("Error loading data",g.TreeItemCollapsibleState.None);return i.description=r.length>50?r.substring(0,50)+"...":r,i.iconPath=new g.ThemeIcon("error"),i.contextValue="error",i.tooltip=r,[i]}return[]}async addProject(e){this.projects.push(e),this.refresh()}async updateProject(e){let t=this.projects.findIndex(o=>o.id===e.id);t!==-1&&(this.projects[t]=e,this.refresh())}async removeProject(e){this.projects=this.projects.filter(t=>t.id!==e),delete this.apiKeys[e],this.refresh()}async addApiKey(e,t){this.apiKeys[e]||(this.apiKeys[e]=[]),this.apiKeys[e].push(t),this.refresh()}async updateApiKey(e,t){if(this.apiKeys[e]){let o=this.apiKeys[e].findIndex(r=>r.id===t.id);o!==-1&&(this.apiKeys[e][o]=t,this.refresh())}}async removeApiKey(e,t){this.apiKeys[e]&&(this.apiKeys[e]=this.apiKeys[e].filter(o=>o.id!==t),this.refresh())}clearCache(){this.projects=[],this.apiKeys={}}};var j=C(require("vscode"));async function J(n,e,t,o){let r=[];o.appendLine("=================================================="),o.appendLine("Starting L0 Memory Extension Diagnostics"),o.appendLine(`Timestamp: ${new Date().toISOString()}`),o.appendLine(`==================================================
`),r.push(await ye(n,o)),r.push(await ge(o)),r.push(await fe(o)),r.push(await we(e,o)),r.push(await ve(t,o)),r.push(await Ae(n,o));let i=ke(r);return o.appendLine(`
==================================================`),o.appendLine(`Overall Health: ${i.toUpperCase()}`),o.appendLine("=================================================="),{overall:i,results:r,timestamp:new Date}}async function ye(n,e){e.appendLine("[1/6] Checking Extension Context...");try{if(!n)return{category:"Extension Context",status:"error",message:"Extension context is not available",action:"Reload VS Code"};let t=n.globalStorageUri?.fsPath,o=n.storageUri?.fsPath;return e.appendLine(`  \u2713 Extension ID: ${n.extension.id}`),e.appendLine(`  \u2713 Extension Path: ${n.extensionPath}`),e.appendLine(`  \u2713 Global Storage: ${t||"N/A"}`),e.appendLine(`  \u2713 Workspace Storage: ${o||"N/A"}`),{category:"Extension Context",status:"success",message:"Extension context is properly initialized"}}catch(t){return e.appendLine(`  \u2717 Error: ${t instanceof Error?t.message:String(t)}`),{category:"Extension Context",status:"error",message:"Failed to check extension context",details:t instanceof Error?t.message:String(t)}}}async function ge(n){n.appendLine(`
[2/6] Checking VS Code Version...`);try{let e=j.version,t="1.93.0";n.appendLine(`  \u2713 Current Version: ${e}`),n.appendLine(`  \u2713 Required Version: ${t}+`);let[o,r]=e.split(".").map(Number),[i,s]=t.split(".").map(Number);return o>i||o===i&&r>=s?{category:"VS Code Version",status:"success",message:`VS Code ${e} meets minimum requirements`}:{category:"VS Code Version",status:"warning",message:`VS Code ${e} is below recommended version ${t}`,action:"Update VS Code"}}catch(e){return n.appendLine(`  \u2717 Error: ${e instanceof Error?e.message:String(e)}`),{category:"VS Code Version",status:"error",message:"Failed to check VS Code version",details:e instanceof Error?e.message:String(e)}}}async function fe(n){n.appendLine(`
[3/6] Checking Configuration...`);try{let e=j.workspace.getConfiguration("lzero"),t=e.get("apiUrl"),o=e.get("gatewayUrl"),r=e.get("useGateway"),i=e.get("enableApiKeyManagement");n.appendLine(`  \u2713 API URL: ${t}`),n.appendLine(`  \u2713 Gateway URL: ${o}`),n.appendLine(`  \u2713 Use Gateway: ${r}`),n.appendLine(`  \u2713 API Key Mgmt: ${i}`);let s=[];return t||s.push("API URL not configured"),r&&!o&&s.push("Gateway mode enabled but Gateway URL not configured"),s.length>0?{category:"Configuration",status:"warning",message:"Configuration issues detected",details:s.join("; "),action:"Check Settings"}:{category:"Configuration",status:"success",message:"Configuration is valid"}}catch(e){return n.appendLine(`  \u2717 Error: ${e instanceof Error?e.message:String(e)}`),{category:"Configuration",status:"error",message:"Failed to check configuration",details:e instanceof Error?e.message:String(e)}}}async function we(n,e){e.appendLine(`
[4/6] Checking Authentication...`);try{if(await n.hasApiKey()){e.appendLine("  \u2713 API key is stored securely");try{let o=await n.getApiKey();return o&&o.length>0?(e.appendLine(`  \u2713 API key length: ${o.length} characters`),e.appendLine(`  \u2713 API key prefix: ${o.substring(0,8)}...`),{category:"Authentication",status:"success",message:"Authenticated with valid API key"}):{category:"Authentication",status:"warning",message:"API key exists but appears empty",action:"Re-authenticate"}}catch(o){return{category:"Authentication",status:"warning",message:"API key exists but could not be retrieved",details:o instanceof Error?o.message:String(o),action:"Re-authenticate"}}}return e.appendLine("  \u2139 No API key configured"),{category:"Authentication",status:"info",message:"Not authenticated",action:"Authenticate"}}catch(t){return e.appendLine(`  \u2717 Error: ${t instanceof Error?t.message:String(t)}`),{category:"Authentication",status:"error",message:"Failed to check authentication status",details:t instanceof Error?t.message:String(t)}}}async function ve(n,e){e.appendLine(`
[5/6] Checking Network Connectivity...`);try{if(!await n.isAuthenticated())return e.appendLine("  \u2139 Skipping (not authenticated)"),{category:"Network Connectivity",status:"info",message:"Skipped - not authenticated"};e.appendLine("  \u23F3 Testing connection...");let o=Date.now();await n.testConnection();let r=Date.now()-o;return e.appendLine(`  \u2713 Connection successful (${r}ms)`),{category:"Network Connectivity",status:"success",message:`Connected successfully in ${r}ms`}}catch(t){return e.appendLine(`  \u2717 Connection failed: ${t instanceof Error?t.message:String(t)}`),{category:"Network Connectivity",status:"error",message:"Unable to connect to L0 Memory services",details:t instanceof Error?t.message:String(t),action:"Check internet connection"}}}async function Ae(n,e){e.appendLine(`
[6/6] Checking Storage...`);try{if(await n.globalState.update("lzero.diagnosticTest",Date.now()),!n.globalState.get("lzero.diagnosticTest"))return e.appendLine("  \u2717 Global state write/read failed"),{category:"Storage",status:"error",message:"Storage system is not working properly",action:"Reload VS Code"};e.appendLine("  \u2713 Global state is accessible");let o=n.globalState.keys();e.appendLine(`  \u2713 Stored keys: ${o.length}`);let r=n.globalState.get("lzero.firstTime");return e.appendLine(`  \u2713 First time flag: ${r}`),{category:"Storage",status:"success",message:"Storage system is working properly"}}catch(t){return e.appendLine(`  \u2717 Error: ${t instanceof Error?t.message:String(t)}`),{category:"Storage",status:"error",message:"Storage system check failed",details:t instanceof Error?t.message:String(t)}}}function ke(n){let e=n.some(o=>o.status==="error"),t=n.some(o=>o.status==="warning");return e?"critical":t?"degraded":"healthy"}function G(n){let e={healthy:"\u2705",degraded:"\u26A0\uFE0F",critical:"\u274C"},t={success:"\u2705",warning:"\u26A0\uFE0F",error:"\u274C",info:"\u2139\uFE0F"},o=`# L0 Memory Extension Diagnostics

`;o+=`**Overall Health:** ${e[n.overall]} ${n.overall.toUpperCase()}
`,o+=`**Timestamp:** ${n.timestamp.toLocaleString()}

`,o+=`---

`;for(let r of n.results)o+=`## ${t[r.status]} ${r.category}

`,o+=`**Status:** ${r.status.toUpperCase()}

`,o+=`**Message:** ${r.message}

`,r.details&&(o+=`**Details:** ${r.details}

`),r.action&&(o+=`**Recommended Action:** ${r.action}

`),o+=`---

`;return o}var Y="https://api.lanonasis.com",Pe=()=>a.workspace.getConfiguration("lzero").get("apiUrl")||Y,D=()=>{let e=a.workspace.getConfiguration("lzero").get("apiUrl")||Y;return e.endsWith("/api/v1")?e:`${e.replace(/\/$/,"")}/api/v1`},Se=()=>a.workspace.getConfiguration("lzero").get("dashboardUrl")||"https://lanonasis.com/dashboard",Ce=()=>(a.workspace.getConfiguration("lzero").get("apiUrl")||Y).replace(/\/api\/v1\/?$/,""),Te=["lano_","lns_"];function be(n){return Te.some(e=>n.startsWith(e))}function Ee(n){let e=n.split(".");if(e.length<2)return null;let t=e[1].replace(/-/g,"+").replace(/_/g,"/"),o=t+"=".repeat((4-t.length%4)%4);try{let r="";if(typeof Buffer<"u")r=Buffer.from(o,"base64").toString("utf8");else if(typeof atob=="function"){let i=atob(o);if(typeof TextDecoder<"u"){let s=Uint8Array.from(i,l=>l.charCodeAt(0));r=new TextDecoder().decode(s)}else r=i}else return null;return JSON.parse(r)}catch{return null}}function X(n){if(!n||!n.includes("."))return null;let e=Ee(n);if(!e)return null;let t=typeof e.email=="string"?e.email:typeof e.user_email=="string"?e.user_email:typeof e.upn=="string"?e.upn:void 0,o=typeof e.given_name=="string"?e.given_name:void 0,r=typeof e.family_name=="string"?e.family_name:void 0,i=[o,r].filter(Boolean).join(" "),s=typeof e.name=="string"?e.name:typeof e.preferred_username=="string"?e.preferred_username:typeof e.nickname=="string"?e.nickname:i||void 0,l=typeof e.sub=="string"?e.sub:void 0;return!t&&!s&&!l?null:{id:l,name:s,email:t}}var W=null,N=class{constructor(e,t,o,r,i){this.context=e;this.output=t;this.secureApiKeyService=o;this.apiKeyService=r;this.cache=i}static{this.viewType="lzero.memorySidebar"}resolveWebviewView(e,t,o){this.view=e;let r=e.webview;r.options={enableScripts:!0,localResourceRoots:[a.Uri.joinPath(this.context.extensionUri,"media")]},this.output.appendLine("[LanOnasis] Initializing sidebar webview"),r.html=this.getWebviewHtml(r),r.onDidReceiveMessage(i=>{if(!(!i||typeof i!="object")){if(i.type==="lanonasis:webview-ready"){this.output.appendLine("[LanOnasis] Webview ready"),r.postMessage({type:"lanonasis:host-ready"});let s=this.cache.getMemories(),l=this.cache.getStatus();r.postMessage({type:"lanonasis:cache:data",payload:{memories:s,status:l}}),this.sendConfigToWebview(r);return}if(i.type==="lanonasis:request-auth"){this.handleOAuthLogin(r);return}if(i.type==="lanonasis:submit-api-key"){let s=i.payload?.apiKey;s&&this.handleApiKeySubmit(r,s);return}if(i.type==="lanonasis:logout"){this.handleLogout(r);return}if(i.type==="lanonasis:open-settings"){a.commands.executeCommand("workbench.action.openSettings","lzero");return}if(i.type==="lanonasis:open-dashboard"){let s=i.payload?.section,l=Se(),d=s?`${l}#${s}`:l;a.env.openExternal(a.Uri.parse(d));return}if(i.type==="lanonasis:clipboard:read"){a.env.clipboard.readText().then(s=>{r.postMessage({type:"lanonasis:clipboard:read:result",payload:{text:s}})});return}if(i.type==="lanonasis:clipboard:write"){let s=i.payload?.text;typeof s=="string"&&a.env.clipboard.writeText(s);return}if(i.type==="lanonasis:cache:get"){let s=this.cache.getMemories(),l=this.cache.getStatus();r.postMessage({type:"lanonasis:cache:data",payload:{memories:s,status:l}});return}if(i.type==="lanonasis:cache:search"){let s=i.payload?.query;if(s){let l=this.cache.semanticSearchLocal(s);r.postMessage({type:"lanonasis:cache:search:result",payload:{results:l,query:s}})}return}if(i.type==="lanonasis:cache:add"){let s=i.payload?.memory;s&&this.cache.addLocal(s).then(l=>{r.postMessage({type:"lanonasis:cache:added",payload:{memory:l}})});return}if(i.type==="lanonasis:cache:update"){let s=i.payload?.id,l=i.payload?.updates;s&&l&&this.cache.queueUpdate(s,l).then(()=>{let d=this.cache.getMemoryById(s);r.postMessage({type:"lanonasis:cache:updated",payload:{memory:d,status:this.cache.getStatus()}})});return}if(i.type==="lanonasis:cache:delete"){let s=i.payload?.id;s&&this.cache.queueDelete(s).then(()=>{r.postMessage({type:"lanonasis:cache:deleted",payload:{id:s,status:this.cache.getStatus()}})});return}if(i.type==="lanonasis:cache:clear"){this.cache.clearAll().then(()=>{r.postMessage({type:"lanonasis:cache:cleared",payload:{status:this.cache.getStatus()}})});return}if(i.type==="lanonasis:cache:sync"){this.syncMemories(r);return}if(i.type==="lanonasis:ai:search"){let s=i.payload?.query;s&&this.handleAISearch(r,s);return}}})}async syncMemories(e){this.cache.setSyncing(!0),e.postMessage({type:"lanonasis:sync:start"});let t=setTimeout(()=>{this.cache.setSyncing(!1),this.output.appendLine("[LanOnasis] Sync timed out after 60 seconds"),e.postMessage({type:"lanonasis:sync:error",payload:{error:"Sync timed out after 60 seconds",isNetworkError:!0}})},6e4);try{let o=await this.getEdgeAuthHeaders();if(!o){clearTimeout(t),this.cache.setSyncing(!1),e.postMessage({type:"lanonasis:sync:error",payload:{error:"Not authenticated"}});return}let r=D(),i=this.cache.getPendingQueue(),s={success:0,failed:0};for(let p of i)try{if(p._pending==="create"){let h=new AbortController,A=setTimeout(()=>h.abort(),3e4);try{let f=await fetch(`${r}/memories`,{method:"POST",headers:o,signal:h.signal,body:JSON.stringify({title:p.title,content:p.content,memory_type:p.memory_type,tags:p.tags})});if(f.ok){let m=await f.json(),k=m.data||m.memory||m;await this.cache.markSynced(p._localId||p.id,k),s.success++,this.output.appendLine(`[LanOnasis] Synced new memory: ${p.title}`)}else s.failed++,this.output.appendLine(`[LanOnasis] Failed to sync memory: ${p.title} (${f.status})`)}finally{clearTimeout(A)}}else if(p._pending==="update"){let h=new AbortController,A=setTimeout(()=>h.abort(),3e4);try{let f=await fetch(`${r}/memory/update`,{method:"POST",headers:o,signal:h.signal,body:JSON.stringify({id:p.id,title:p.title,content:p.content,memory_type:p.memory_type,tags:p.tags})});if(f.ok){let m=await f.json(),k=m.data||m.memory||m;await this.cache.markSynced(p.id,k),s.success++}else s.failed++}finally{clearTimeout(A)}}else if(p._pending==="delete"){let h=new AbortController,A=setTimeout(()=>h.abort(),3e4);try{(await fetch(`${r}/memory/delete`,{method:"POST",headers:o,signal:h.signal,body:JSON.stringify({id:p.id})})).ok?(await this.cache.removePending(p.id),s.success++):s.failed++}finally{clearTimeout(A)}}}catch(h){s.failed++,this.output.appendLine(`[LanOnasis] Error syncing pending item: ${h}`)}i.length>0&&this.output.appendLine(`[LanOnasis] Sync results: ${s.success} succeeded, ${s.failed} failed`);let l=new AbortController,d=setTimeout(()=>l.abort(),3e4);try{let p=await fetch(`${r}/memories/list?limit=100`,{headers:o,signal:l.signal});if(!p.ok)throw new Error(`API error: ${p.status}`);let h=await p.json(),A=h.data?.memories||h.memories||h.data||h||[];await this.cache.updateFromApi(A),this.cache.setOnline(!0),clearTimeout(t),e.postMessage({type:"lanonasis:sync:complete",payload:{memories:A,status:this.cache.getStatus(),syncResults:s}})}finally{clearTimeout(d)}}catch(o){clearTimeout(t);let r=String(o),i=r.includes("fetch")||r.includes("network")||r.includes("ECONNREFUSED")||r.includes("ETIMEDOUT")||r.includes("AbortError")||r.includes("aborted");i&&this.cache.setOnline(!1),this.output.appendLine(`[LanOnasis] Sync error: ${o}`),e.postMessage({type:"lanonasis:sync:error",payload:{error:r,isNetworkError:i}})}finally{clearTimeout(t),this.cache.setSyncing(!1)}}async handleAISearch(e,t){try{let o=this.cache.semanticSearchLocal(t);e.postMessage({type:"lanonasis:ai:search:local",payload:{results:o,query:t}});let r=await this.getStoredApiKey(),i=await this.getEdgeAuthHeaders();if(i){let s=D(),l=await fetch(`${s}/memories/search`,{method:"POST",headers:i,body:JSON.stringify({query:t,limit:10,threshold:.7})});if(l.ok){let d=await l.json(),p=d.data?.results||d.results||d.data||[];e.postMessage({type:"lanonasis:ai:search:api",payload:{results:p,query:t}})}}}catch(o){this.output.appendLine(`[LanOnasis] AI search error: ${o}`)}}async getStoredApiKey(){try{return(await this.secureApiKeyService.getStoredCredentials())?.token}catch(e){this.output.appendLine(`[LanOnasis] Failed to get credentials: ${e}`);return}}async getEdgeAuthHeaders(){try{let e=await this.secureApiKeyService.getStoredCredentials();return e?e.type==="oauth"?{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}:{"X-API-Key":e.token,"Content-Type":"application/json"}:null}catch(e){return this.output.appendLine(`[LanOnasis] Failed to build auth headers: ${e}`),null}}async sendConfigToWebview(e){let t=a.workspace.getConfiguration("lzero"),o=a.workspace.getConfiguration("lanonasis"),r=Ce(),i,s=null;try{let l=await this.secureApiKeyService.getStoredCredentials();if(l?.token){if(i=l.token,s=X(l.token),!s)try{let d=await this.apiKeyService.getUserInfo();d&&(s={id:d.id,name:d.name,email:d.email})}catch(d){this.output.appendLine("[LanOnasis] Failed to load user profile: "+String(d))}this.output.appendLine("[LanOnasis] Found stored credentials")}}catch(l){this.output.appendLine("[LanOnasis] Token error: "+String(l))}e.postMessage({type:"lanonasis:config:init",payload:{apiUrl:r,apiKey:i,user:s}})}async handleOAuthLogin(e){try{let t=await this.secureApiKeyService.authenticateWithOAuthFlow();if(!t)throw new Error("No tokens received");let o=X(t);if(!o)try{let r=await this.apiKeyService.getUserInfo();r&&(o={id:r.id,name:r.name,email:r.email})}catch(r){this.output.appendLine("[LanOnasis] Failed to load user profile: "+String(r))}e.postMessage({type:"lanonasis:auth:result",payload:{success:!0}}),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:t,user:o}}),await a.window.showInformationMessage("LanOnasis: Connected via OAuth!")}catch(t){let o=t instanceof Error?t.message:String(t);this.output.appendLine("[LanOnasis] OAuth error: "+o),e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:o}})}}async handleApiKeySubmit(e,t){try{if(!t||!be(t)){e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:"Invalid API key format"}});return}await this.secureApiKeyService.storeApiKeyDirect(t);let o=null;try{let r=await this.apiKeyService.getUserInfo();r&&(o={id:r.id,name:r.name,email:r.email})}catch(r){this.output.appendLine("[LanOnasis] Failed to load user profile: "+String(r))}e.postMessage({type:"lanonasis:auth:result",payload:{success:!0}}),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:t,user:o}}),await a.window.showInformationMessage("LanOnasis: Connected!")}catch(o){let r=o instanceof Error?o.message:String(o);e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:r}})}}async handleLogout(e){try{await this.secureApiKeyService.deleteApiKey(),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:null,user:null}}),await a.window.showInformationMessage("LanOnasis: Logged out")}catch(t){this.output.appendLine("[LanOnasis] Logout error: "+String(t))}}postMessage(e){this.view&&this.view.webview.postMessage(e)}getWebviewHtml(e){let t=Ie(),o=e.asWebviewUri(a.Uri.joinPath(this.context.extensionUri,"media","sidebar-react.js")),r=e.asWebviewUri(a.Uri.joinPath(this.context.extensionUri,"media","lzero-memory.css"));return'<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta http-equiv="Content-Security-Policy" content="'+["default-src 'none'","img-src "+e.cspSource+" https: data:","style-src "+e.cspSource+" 'unsafe-inline'","font-src "+e.cspSource+" https: data:","script-src 'nonce-"+t+"' 'wasm-unsafe-eval'","connect-src https: wss: http://localhost:*"].join("; ")+'"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="stylesheet" href="'+r+'"/><title>LanOnasis Memory</title><style>body{background:var(--vscode-sideBar-background,#252526);color:var(--vscode-sideBar-foreground,#ccc);font-family:var(--vscode-font-family,sans-serif);margin:0;padding:0}#loading{padding:20px;text-align:center}#error{padding:20px;color:#f48771;display:none;white-space:pre-wrap;font-size:12px}</style></head><body><div id="loading">Loading L0 Memory...</div><div id="error"></div><div id="root"></div><script nonce="'+t+'">var errors=[];window.onerror=function(m,u,l){errors.push(m+" at "+u+":"+l);document.getElementById("error").style.display="block";document.getElementById("error").textContent="JS Error:\\n"+errors.join("\\n");document.getElementById("loading").style.display="none";return false};window.addEventListener("unhandledrejection",function(e){errors.push("Promise: "+(e.reason?.message||e.reason||"Unknown"));document.getElementById("error").style.display="block";document.getElementById("error").textContent="Promise Error:\\n"+errors.join("\\n");document.getElementById("loading").style.display="none"});</script><script nonce="'+t+'" type="module" src="'+o+`" onerror="document.getElementById('error').textContent='Failed to load script';document.getElementById('error').style.display='block';document.getElementById('loading').style.display='none';"></script><script nonce="`+t+'">var observer=new MutationObserver(function(){if(document.getElementById("root").children.length>0){document.getElementById("loading").style.display="none";observer.disconnect()}});observer.observe(document.getElementById("root"),{childList:true});setTimeout(function(){if(document.getElementById("root").children.length===0){document.getElementById("error").textContent="React failed to mount";document.getElementById("error").style.display="block";document.getElementById("loading").style.display="none"}},5000);</script></body></html>'}};function Ie(){let n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(let t=0;t<32;t++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}function Z(n,e){let t=n.extension?.packageJSON?.contributes?.views;return!t||typeof t!="object"?!1:Object.values(t).some(o=>Array.isArray(o)&&o.some(r=>r?.id===e))}async function Ke(n){let e=a.window.createOutputChannel("LanOnasis Memory");e.appendLine("[LanOnasis] Extension activating...");let t=new _(n,e);try{await t.initialize(),e.appendLine("[LanOnasis] SecureApiKeyService initialized successfully")}catch(c){e.appendLine(`[LanOnasis] SecureApiKeyService initialization warning: ${c}`)}let o=new x(t,e,D()),r=new $(t,e),i=a.workspace.getConfiguration("lzero").get("retainContextWhenHidden",!1),s=new K(n,e,D());W=s;let l=new N(n,e,t,r,s),d=new R(o),p=new U(r,e),h=Z(n,"lzeroMemories"),A=Z(n,"lzeroApiKeys");h?n.subscriptions.push(a.window.registerTreeDataProvider("lzeroMemories",d)):e.appendLine("[LanOnasis] View id lzeroMemories is not registered. Skipping tree provider."),A?n.subscriptions.push(a.window.registerTreeDataProvider("lzeroApiKeys",p)):e.appendLine("[LanOnasis] View id lzeroApiKeys is not registered. Skipping tree provider."),a.commands.executeCommand("setContext","lzero.enableApiKeyManagement",a.workspace.getConfiguration("lzero").get("enableApiKeyManagement",!0)),a.commands.executeCommand("setContext","lzero.authenticated",!1);let f=async c=>{await a.commands.executeCommand("setContext","lzero.authenticated",c),await d.setAuthenticated(c),p.setAuthenticated(c)},m=async()=>{try{return(await t.getStoredCredentials())?.token}catch(c){e.appendLine(`[LanOnasis] Chat: Failed to get credentials: ${c}`);return}};new M(n,e,s,Pe(),m).register(),n.subscriptions.push(a.window.registerWebviewViewProvider(N.viewType,l,{webviewOptions:{retainContextWhenHidden:i}})),n.subscriptions.push(a.commands.registerCommand("lzeroMemory.authenticate",async c=>{try{let u=null;c==="oauth"?u=await t.authenticateWithOAuthFlow():c==="apikey"?u=await t.promptForApiKeyEntry():u=await t.promptForAuthentication(),u&&(await f(!0),await a.window.showInformationMessage("L0 Memory: Authenticated!"))}catch(u){let w=u instanceof Error?u.message:String(u);await a.window.showErrorMessage("L0 Memory: Auth failed - "+w)}})),n.subscriptions.push(a.commands.registerCommand("lzeroMemory.createMemoryFromSelection",async()=>{let c=a.window.activeTextEditor;if(!c){await a.window.showInformationMessage("No active editor");return}let u=c.document.getText(c.selection);if(!u){await a.window.showInformationMessage("No text selected");return}l.postMessage({type:"lanonasis:inject-chat",payload:{text:u}}),await a.commands.executeCommand("lzero.memorySidebar.focus")})),n.subscriptions.push(a.commands.registerCommand("lzeroMemory.syncMemories",async()=>{l.postMessage({type:"lanonasis:cache:sync"}),await a.window.showInformationMessage("LanOnasis: Syncing memories...")})),n.subscriptions.push(a.commands.registerCommand("lzeroMemory.searchMemories",async()=>{let c=await a.window.showInputBox({prompt:"Search your memories",placeHolder:"e.g., OAuth implementation, regex pattern..."});if(c){let u=s.semanticSearchLocal(c);if(u.length===0){await a.window.showInformationMessage(`No memories found for "${c}"`);return}let w=u.map(S=>({label:S.title,description:S.memory_type,detail:S.content.slice(0,100)+(S.content.length>100?"...":""),memory:S})),P=await a.window.showQuickPick(w,{placeHolder:`Found ${u.length} memories`,matchOnDescription:!0,matchOnDetail:!0});P&&(await a.env.clipboard.writeText(P.memory.content),await a.window.showInformationMessage(`Copied "${P.label}" to clipboard`))}})),n.subscriptions.push(a.commands.registerCommand("lzeroMemory.openMemory",c=>{Ue(c)})),n.subscriptions.push(a.commands.registerCommand("lzeroMemory.manageApiKeys",async()=>{await _e(r)}),a.commands.registerCommand("lzeroMemory.createProject",async()=>{await V(r,p)}),a.commands.registerCommand("lzeroMemory.viewProjects",async()=>{await te(r)}),a.commands.registerCommand("lzeroMemory.refreshApiKeys",async()=>{p.refresh(!0)}),a.commands.registerCommand("lzeroMemory.viewProjectDetails",async c=>{c&&c.project&&await re(c.project,r)}),a.commands.registerCommand("lzeroMemory.viewApiKeyDetails",async c=>{c&&c.apiKey&&await oe(c.apiKey)}),a.commands.registerCommand("lzeroMemory.createApiKey",async c=>{c&&c.project?await $e(c.project,r,p):await ee(r,p)}),a.commands.registerCommand("lzeroMemory.rotateApiKey",async c=>{c&&c.apiKey&&await Le(c.apiKey,r,p)}),a.commands.registerCommand("lzeroMemory.deleteApiKey",async c=>{c&&c.apiKey&&await Re(c.apiKey,r,p)}),a.commands.registerCommand("lzeroMemory.deleteProject",async c=>{c&&c.project&&await Oe(c.project,r,p)})),n.subscriptions.push(a.commands.registerCommand("lzeroMemory.checkApiKeyStatus",async()=>{try{let c=await t.hasApiKey(),u=c?"\u2705 Configured and stored securely":"\u274C Not configured";c?a.window.showInformationMessage(`API Key Status: ${u}`,"Test Connection","View Security Info").then(async w=>{w==="Test Connection"?a.commands.executeCommand("lzeroMemory.testConnection"):w==="View Security Info"&&a.env.openExternal(a.Uri.parse("https://docs.lanonasis.com/security/api-keys"))}):a.window.showInformationMessage(`API Key Status: ${u}`,"Connect in Browser","Enter API Key").then(w=>{w==="Connect in Browser"?a.commands.executeCommand("lzeroMemory.authenticate","oauth"):w==="Enter API Key"&&a.commands.executeCommand("lzeroMemory.authenticate","apikey")})}catch(c){let u=c instanceof Error?c.message:String(c);a.window.showErrorMessage(`Failed to check API key status: ${u}`)}}),a.commands.registerCommand("lzeroMemory.clearApiKey",async()=>{try{if(!await t.hasApiKey()){a.window.showInformationMessage("No API key is currently configured.");return}await a.window.showWarningMessage("Are you sure you want to clear your API key? This will require re-authentication.",{modal:!0},"Clear API Key")==="Clear API Key"&&(await t.deleteApiKey(),await f(!1),a.window.showInformationMessage("API key cleared successfully."))}catch(c){let u=c instanceof Error?c.message:String(c);a.window.showErrorMessage(`Failed to clear API key: ${u}`)}}),a.commands.registerCommand("lzeroMemory.testConnection",async()=>{try{if(!await t.hasApiKey()){a.window.showWarningMessage("\u274C No API key configured.");return}await o.testConnection(),a.window.showInformationMessage("\u2705 Connection test successful!")}catch(c){let u=c instanceof Error?c.message:String(c);a.window.showErrorMessage(`Connection test failed: ${u}`)}}),a.commands.registerCommand("lzeroMemory.runDiagnostics",async()=>{try{e.show(),e.appendLine(`Running comprehensive diagnostics...
`);let c=await J(n,t,o,e),u=G(c),w=await a.workspace.openTextDocument({content:u,language:"markdown"});await a.window.showTextDocument(w)}catch(c){let u=c instanceof Error?c.message:String(c);a.window.showErrorMessage(`Diagnostics failed: ${u}`),e.appendLine(`[Diagnostics] Fatal error: ${u}`)}}),a.commands.registerCommand("lzeroMemory.showLogs",()=>{e.show()})),n.subscriptions.push({dispose:()=>s.stopConnectivityCheck()});try{let c=await t.hasApiKey();await f(c)}catch(c){e.appendLine(`[LanOnasis] Failed to check auth state: ${c instanceof Error?c.message:String(c)}`)}e.appendLine("[LanOnasis] Extension activated")}function Me(){W?.stopConnectivityCheck(),W=null}async function _e(n){let e=[{label:"$(key) View API Keys",description:"View all API keys across projects",command:"view"},{label:"$(add) Create API Key",description:"Create a new API key",command:"create"},{label:"$(folder) Manage Projects",description:"Create and manage API key projects",command:"projects"},{label:"$(refresh) Refresh",description:"Refresh API key data",command:"refresh"}],t=await a.window.showQuickPick(e,{placeHolder:"Choose an API key management action"});if(t)switch(t.command){case"view":await xe(n);break;case"create":await ee(n);break;case"projects":await te(n);break;case"refresh":a.commands.executeCommand("lzeroMemory.refreshApiKeys");break}}async function xe(n){try{a.window.withProgress({location:a.ProgressLocation.Notification,title:"Loading API keys...",cancellable:!1},async()=>{let e=await n.getApiKeys();if(e.length===0){a.window.showInformationMessage("No API keys found. Create your first API key to get started.");return}let t=e.map(r=>({label:r.name,description:`${r.environment} \u2022 ${r.keyType} \u2022 ${r.accessLevel}`,detail:`Project: ${r.projectId} | Created: ${new Date(r.createdAt).toLocaleDateString()}`,apiKey:r})),o=await a.window.showQuickPick(t,{placeHolder:`Select an API key (${e.length} found)`});o&&await oe(o.apiKey)})}catch(e){a.window.showErrorMessage(`Failed to load API keys: ${e instanceof Error?e.message:"Unknown error"}`)}}async function ee(n,e){try{let t=await n.getProjects();if(t.length===0){await a.window.showInformationMessage("No projects found. You need to create a project first.","Create Project","Cancel")==="Create Project"&&await V(n,void 0);return}let o=t.map(m=>({label:m.name,description:m.description||"No description",project:m})),r=await a.window.showQuickPick(o,{placeHolder:"Select a project for the API key"});if(!r)return;let i=await a.window.showInputBox({prompt:"API Key Name",placeHolder:"Enter a name for your API key"});if(!i)return;let s=await a.window.showInputBox({prompt:"API Key Value",placeHolder:"Enter the API key value",password:!0});if(!s)return;let l=[{label:"API Key",value:"api_key"},{label:"Database URL",value:"database_url"},{label:"OAuth Token",value:"oauth_token"},{label:"Certificate",value:"certificate"},{label:"SSH Key",value:"ssh_key"},{label:"Webhook Secret",value:"webhook_secret"},{label:"Encryption Key",value:"encryption_key"}],d=await a.window.showQuickPick(l,{placeHolder:"Select key type"});if(!d)return;let h=a.workspace.getConfiguration("lzero").get("defaultEnvironment","development"),A=[{label:"Development",value:"development",picked:h==="development"},{label:"Staging",value:"staging",picked:h==="staging"},{label:"Production",value:"production",picked:h==="production"}],f=await a.window.showQuickPick(A,{placeHolder:"Select environment"});if(!f)return;await a.window.withProgress({location:a.ProgressLocation.Notification,title:"Creating API key...",cancellable:!1},async()=>{await n.createApiKey({name:i,value:s,keyType:d.value,environment:f.value,accessLevel:"team",projectId:r.project.id})}),a.window.showInformationMessage(`API key "${i}" created successfully`),a.commands.executeCommand("lzeroMemory.refreshApiKeys")}catch(t){a.window.showErrorMessage(`Failed to create API key: ${t instanceof Error?t.message:"Unknown error"}`)}}async function V(n,e){try{let t=await a.window.showInputBox({prompt:"Project Name",placeHolder:"Enter a name for your project"});if(!t)return;let o=await a.window.showInputBox({prompt:"Project Description (optional)",placeHolder:"Enter a description for your project"}),r=a.workspace.getConfiguration("lzero"),i=r.get("organizationId");if(!i){let s=await a.window.showInputBox({prompt:"Organization ID",placeHolder:"Enter your organization ID"});if(!s)return;await r.update("organizationId",s,a.ConfigurationTarget.Global),i=s}await a.window.withProgress({location:a.ProgressLocation.Notification,title:"Creating project...",cancellable:!1},async()=>{let s=await n.createProject({name:t,description:o,organizationId:i});e&&await e.addProject(s)}),a.window.showInformationMessage(`Project "${t}" created successfully`),a.commands.executeCommand("lzeroMemory.refreshApiKeys")}catch(t){a.window.showErrorMessage(`Failed to create project: ${t instanceof Error?t.message:"Unknown error"}`)}}async function te(n){try{a.window.withProgress({location:a.ProgressLocation.Notification,title:"Loading projects...",cancellable:!1},async()=>{let e=await n.getProjects();if(e.length===0){await a.window.showInformationMessage("No projects found. Create your first project to get started.","Create Project","Cancel")==="Create Project"&&await V(n,void 0);return}let t=e.map(r=>({label:r.name,description:r.description||"No description",detail:`Organization: ${r.organizationId} | Created: ${new Date(r.createdAt).toLocaleDateString()}`,project:r})),o=await a.window.showQuickPick(t,{placeHolder:`Select a project (${e.length} found)`});o&&await re(o.project,n)})}catch(e){a.window.showErrorMessage(`Failed to load projects: ${e instanceof Error?e.message:"Unknown error"}`)}}async function oe(n){let e=`# API Key: ${n.name}

**Type:** ${n.keyType}
**Environment:** ${n.environment}
**Access Level:** ${n.accessLevel}
**Project ID:** ${n.projectId}
**Created:** ${new Date(n.createdAt).toLocaleString()}
${n.expiresAt?`**Expires:** ${new Date(n.expiresAt).toLocaleString()}`:"**Expires:** Never"}

## Tags
${n.tags.length>0?n.tags.map(t=>`- ${t}`).join(`
`):"No tags"}

## Metadata

\`\`\`json
${JSON.stringify(n.metadata,null,2)}
\`\`\`
`;a.workspace.openTextDocument({content:e,language:"markdown"}).then(t=>{a.window.showTextDocument(t)})}async function re(n,e){try{let t=await e.getApiKeys(n.id),o=`# Project: ${n.name}

**Description:** ${n.description||"No description"}
**Organization ID:** ${n.organizationId}
**Created:** ${new Date(n.createdAt).toLocaleString()}
**Team Members:** ${n.teamMembers.length}

## API Keys (${t.length})
${t.length>0?t.map(r=>`- **${r.name}** (${r.keyType}, ${r.environment})`).join(`
`):"No API keys found in this project"}

## Settings

\`\`\`json
${JSON.stringify(n.settings,null,2)}
\`\`\`
`;a.workspace.openTextDocument({content:o,language:"markdown"}).then(r=>{a.window.showTextDocument(r)})}catch(t){a.window.showErrorMessage(`Failed to load project details: ${t instanceof Error?t.message:"Unknown error"}`)}}async function $e(n,e,t){try{let o=await a.window.showInputBox({prompt:"API Key Name",placeHolder:"Enter a name for your API key"});if(!o)return;let r=await a.window.showInputBox({prompt:"API Key Value",placeHolder:"Enter the API key value",password:!0});if(!r)return;let i=[{label:"API Key",value:"api_key"},{label:"Database URL",value:"database_url"},{label:"OAuth Token",value:"oauth_token"},{label:"Certificate",value:"certificate"},{label:"SSH Key",value:"ssh_key"},{label:"Webhook Secret",value:"webhook_secret"},{label:"Encryption Key",value:"encryption_key"}],s=await a.window.showQuickPick(i,{placeHolder:"Select key type"});if(!s)return;let l=[{label:"Development",description:"For development use"},{label:"Staging",description:"For staging/testing"},{label:"Production",description:"For production use"}],d=await a.window.showQuickPick(l,{placeHolder:"Select environment"});if(!d)return;let p=[{label:"Public",description:"Publicly accessible"},{label:"Authenticated",description:"Requires authentication"},{label:"Team",description:"Team members only"},{label:"Admin",description:"Administrators only"},{label:"Enterprise",description:"Enterprise level access"}],h=await a.window.showQuickPick(p,{placeHolder:"Select access level"});if(!h)return;let A={name:o,value:r,keyType:s.value,environment:d.label.toLowerCase(),accessLevel:h.label.toLowerCase(),projectId:n.id};await a.window.withProgress({location:a.ProgressLocation.Notification,title:"Creating API key...",cancellable:!1},async()=>{let f=await e.createApiKey(A);a.window.showInformationMessage(`API key "${f.name}" created successfully!`),t&&await t.addApiKey(n.id,f)})}catch(o){a.window.showErrorMessage(`Failed to create API key: ${o instanceof Error?o.message:"Unknown error"}`)}}async function Le(n,e,t){try{if(await a.window.showWarningMessage(`Are you sure you want to rotate API key "${n.name}"? The old key will be invalidated.`,{modal:!0},"Rotate Key")!=="Rotate Key")return;await a.window.withProgress({location:a.ProgressLocation.Notification,title:"Rotating API key...",cancellable:!1},async()=>{let r=await e.rotateApiKey(n.id);a.window.showInformationMessage(`API key "${r.name}" rotated successfully!`),t&&await t.updateApiKey(n.projectId,r)})}catch(o){a.window.showErrorMessage(`Failed to rotate API key: ${o instanceof Error?o.message:"Unknown error"}`)}}async function Re(n,e,t){try{if(await a.window.showWarningMessage(`Are you sure you want to delete API key "${n.name}"? This action cannot be undone.`,{modal:!0},"Delete")!=="Delete")return;await a.window.withProgress({location:a.ProgressLocation.Notification,title:"Deleting API key...",cancellable:!1},async()=>{await e.deleteApiKey(n.id),a.window.showInformationMessage(`API key "${n.name}" deleted successfully.`),t&&await t.removeApiKey(n.projectId,n.id)})}catch(o){a.window.showErrorMessage(`Failed to delete API key: ${o instanceof Error?o.message:"Unknown error"}`)}}async function Oe(n,e,t){try{if(await a.window.showWarningMessage(`Are you sure you want to delete project "${n.name}"? All API keys in this project will also be deleted. This action cannot be undone.`,{modal:!0},"Delete")!=="Delete")return;await a.window.withProgress({location:a.ProgressLocation.Notification,title:"Deleting project...",cancellable:!1},async()=>{await e.deleteProject(n.id),a.window.showInformationMessage(`Project "${n.name}" deleted successfully.`),t&&await t.removeProject(n.id)})}catch(o){a.window.showErrorMessage(`Failed to delete project: ${o instanceof Error?o.message:"Unknown error"}`)}}function Ue(n){let e=`# ${n.title}

**Type:** ${n.memory_type}
**Created:** ${new Date(n.created_at).toLocaleString()}

---

${n.content}`;a.workspace.openTextDocument({content:e,language:"markdown"}).then(t=>{a.window.showTextDocument(t)})}0&&(module.exports={activate,deactivate});
