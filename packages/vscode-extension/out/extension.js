"use strict";var b=Object.create;var p=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var L=(i,e)=>{for(var t in e)p(i,t,{get:e[t],enumerable:!0})},w=(i,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of E(e))!A.call(i,s)&&s!==t&&p(i,s,{get:()=>e[s],enumerable:!(o=O(e,s))||o.enumerable});return i};var f=(i,e,t)=>(t=i!=null?b(k(i)):{},w(e||!i||!i.__esModule?p(t,"default",{value:i,enumerable:!0}):t,i)),x=i=>w(p({},"__esModule",{value:!0}),i);var C={};L(C,{activate:()=>T,deactivate:()=>U});module.exports=x(C);var r=f(require("vscode")),h=f(require("crypto")),d={API_KEY:"lanonasis.apiKey",OAUTH_TOKENS:"lanonasis.tokens"},_=["lano_","lns_"];function S(i){return _.some(e=>i.startsWith(e))}var l={clientId:"vscode-extension",authBaseUrl:"https://auth.lanonasis.com",redirectUri:"vscode://lanonasis.lzero-memory/callback",scope:"memories:read memories:write memories:delete profile"},y=class{constructor(e){this.output=e;this.pendingAuth=null}generateRandomString(e=32){return h.randomBytes(e).toString("base64url").slice(0,e)}generateCodeChallenge(e){return h.createHash("sha256").update(e).digest().toString("base64url")}buildAuthorizationUrl(e,t){let o=new URLSearchParams({client_id:l.clientId,response_type:"code",redirect_uri:l.redirectUri,scope:l.scope,code_challenge:e,code_challenge_method:"S256",state:t});return l.authBaseUrl+"/oauth/authorize?"+o.toString()}async exchangeCodeForTokens(e,t){let o=await fetch(l.authBaseUrl+"/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({grant_type:"authorization_code",code:e,client_id:l.clientId,redirect_uri:l.redirectUri,code_verifier:t})}),s=await o.json();if(!o.ok)throw new Error(s.error_description||s.error||"Token exchange failed");return s}handleCallback(e){if(!this.pendingAuth){this.output.appendLine("[LanOnasis] Received OAuth callback but no pending auth");return}let t=new URLSearchParams(e.query),o=t.get("code"),s=t.get("state"),n=t.get("error");if(n){let a=t.get("error_description")||n;this.pendingAuth.reject(new Error(a)),this.pendingAuth=null;return}if(s!==this.pendingAuth.state){this.pendingAuth.reject(new Error("State mismatch")),this.pendingAuth=null;return}if(!o){this.pendingAuth.reject(new Error("No authorization code received")),this.pendingAuth=null;return}this.pendingAuth.resolve(o)}async authenticate(){let e=this.generateRandomString(43),t=this.generateCodeChallenge(e),o=this.generateRandomString(32),s=this.buildAuthorizationUrl(t,o),n=new Promise((v,g)=>{this.pendingAuth={codeVerifier:e,state:o,resolve:v,reject:g},setTimeout(()=>{this.pendingAuth&&(this.pendingAuth.reject(new Error("OAuth flow timed out")),this.pendingAuth=null)},300*1e3)});if(this.output.appendLine("[LanOnasis] Opening browser for OAuth..."),!await r.env.openExternal(r.Uri.parse(s)))throw this.pendingAuth=null,new Error("Failed to open browser");let c=await n;this.output.appendLine("[LanOnasis] Exchanging code for tokens...");let m=await this.exchangeCodeForTokens(c,e);return this.pendingAuth=null,m}},u=class{constructor(e,t,o){this.context=e;this.output=t;this.oauthFlow=o}static{this.viewType="lzero.memorySidebar"}resolveWebviewView(e,t,o){this.view=e;let s=e.webview;s.options={enableScripts:!0,localResourceRoots:[r.Uri.joinPath(this.context.extensionUri,"media")]},this.output.appendLine("[LanOnasis] Initializing sidebar webview"),s.html=this.getWebviewHtml(s),s.onDidReceiveMessage(n=>{if(!(!n||typeof n!="object")){if(n.type==="lanonasis:webview-ready"){this.output.appendLine("[LanOnasis] Webview ready"),s.postMessage({type:"lanonasis:host-ready"}),this.sendConfigToWebview(s);return}if(n.type==="lanonasis:request-auth"){this.handleOAuthLogin(s);return}if(n.type==="lanonasis:submit-api-key"){let a=n.payload?.apiKey;a&&this.handleApiKeySubmit(s,a);return}if(n.type==="lanonasis:logout"){this.handleLogout(s);return}if(n.type==="lanonasis:clipboard:read"){r.env.clipboard.readText().then(a=>{s.postMessage({type:"lanonasis:clipboard:read:result",payload:{text:a}})});return}if(n.type==="lanonasis:clipboard:write"){let a=n.payload?.text;typeof a=="string"&&r.env.clipboard.writeText(a);return}}})}async sendConfigToWebview(e){let t=r.workspace.getConfiguration("lzero"),o=r.workspace.getConfiguration("lanonasis"),s=t.get("apiUrl")||o.get("apiUrl")||"https://api.lanonasis.com/api/v1",n;try{let a=await this.context.secrets.get(d.OAUTH_TOKENS);if(a){let c=JSON.parse(a);if(c.scope&&(c.scope.includes("memory:")||c.scope.includes("api_keys:manage")))this.output.appendLine("[LanOnasis] Clearing cached tokens with old scopes"),await this.context.secrets.delete(d.OAUTH_TOKENS);else{let g=(c.issued_at??Date.now())+c.expires_in*1e3;Date.now()<=g-300*1e3&&(n=c.access_token,this.output.appendLine("[LanOnasis] Found valid OAuth token"))}}}catch(a){this.output.appendLine("[LanOnasis] Token error: "+String(a))}if(!n)try{let a=await this.context.secrets.get(d.API_KEY);a&&(n=a,this.output.appendLine("[LanOnasis] Found API key"))}catch(a){this.output.appendLine("[LanOnasis] API key error: "+String(a))}e.postMessage({type:"lanonasis:config:init",payload:{apiUrl:s,apiKey:n}})}async handleOAuthLogin(e){try{let t=await this.oauthFlow.authenticate();if(!t?.access_token)throw new Error("No tokens received");let o={...t,issued_at:Date.now()};await this.context.secrets.store(d.OAUTH_TOKENS,JSON.stringify(o)),e.postMessage({type:"lanonasis:auth:result",payload:{success:!0}}),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:t.access_token}}),await r.window.showInformationMessage("LanOnasis: Connected via OAuth!")}catch(t){let o=t instanceof Error?t.message:String(t);this.output.appendLine("[LanOnasis] OAuth error: "+o),e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:o}})}}async handleApiKeySubmit(e,t){try{if(!t||!S(t)){e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:"Invalid API key format"}});return}await this.context.secrets.store(d.API_KEY,t),e.postMessage({type:"lanonasis:auth:result",payload:{success:!0}}),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:t}}),await r.window.showInformationMessage("LanOnasis: Connected!")}catch(o){let s=o instanceof Error?o.message:String(o);e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:s}})}}async handleLogout(e){try{await this.context.secrets.delete(d.API_KEY),await this.context.secrets.delete(d.OAUTH_TOKENS),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:null}}),await r.window.showInformationMessage("LanOnasis: Logged out")}catch(t){this.output.appendLine("[LanOnasis] Logout error: "+String(t))}}postMessage(e){this.view&&this.view.webview.postMessage(e)}getWebviewHtml(e){let t=I(),o=e.asWebviewUri(r.Uri.joinPath(this.context.extensionUri,"media","sidebar-react.js")),s=e.asWebviewUri(r.Uri.joinPath(this.context.extensionUri,"media","lzero-memory.css"));return'<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta http-equiv="Content-Security-Policy" content="'+["default-src 'none'","img-src "+e.cspSource+" https: data:","style-src "+e.cspSource+" 'unsafe-inline'","font-src "+e.cspSource+" https: data:","script-src 'nonce-"+t+"' 'wasm-unsafe-eval'","connect-src https: wss: http://localhost:*"].join("; ")+'"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="stylesheet" href="'+s+'"/><title>LanOnasis Memory</title><style>body{background:var(--vscode-sideBar-background,#252526);color:var(--vscode-sideBar-foreground,#ccc);font-family:var(--vscode-font-family,sans-serif);margin:0;padding:0}#loading{padding:20px;text-align:center}#error{padding:20px;color:#f48771;display:none;white-space:pre-wrap;font-size:12px}</style></head><body><div id="loading">Loading L0 Memory...</div><div id="error"></div><div id="root"></div><script nonce="'+t+'">var errors=[];window.onerror=function(m,u,l){errors.push(m+" at "+u+":"+l);document.getElementById("error").style.display="block";document.getElementById("error").textContent="JS Error:\\n"+errors.join("\\n");document.getElementById("loading").style.display="none";return false};window.addEventListener("unhandledrejection",function(e){errors.push("Promise: "+(e.reason?.message||e.reason||"Unknown"));document.getElementById("error").style.display="block";document.getElementById("error").textContent="Promise Error:\\n"+errors.join("\\n");document.getElementById("loading").style.display="none"});</script><script nonce="'+t+'" type="module" src="'+o+`" onerror="document.getElementById('error').textContent='Failed to load script';document.getElementById('error').style.display='block';document.getElementById('loading').style.display='none';"></script><script nonce="`+t+'">var observer=new MutationObserver(function(){if(document.getElementById("root").children.length>0){document.getElementById("loading").style.display="none";observer.disconnect()}});observer.observe(document.getElementById("root"),{childList:true});setTimeout(function(){if(document.getElementById("root").children.length===0){document.getElementById("error").textContent="React failed to mount";document.getElementById("error").style.display="block";document.getElementById("loading").style.display="none"}},5000);</script></body></html>'}};function I(){let i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(let t=0;t<32;t++)e+=i.charAt(Math.floor(Math.random()*i.length));return e}function T(i){let e=r.window.createOutputChannel("LanOnasis Memory");e.appendLine("[LanOnasis] Extension activating...");let t=new y(e),o=r.window.registerUriHandler({handleUri(n){e.appendLine("[LanOnasis] URI callback: "+n.path),n.path==="/callback"&&t.handleCallback(n)}});i.subscriptions.push(o);let s=new u(i,e,t);i.subscriptions.push(r.window.registerWebviewViewProvider(u.viewType,s,{webviewOptions:{retainContextWhenHidden:!0}})),i.subscriptions.push(r.commands.registerCommand("lzeroMemory.authenticate",async()=>{try{let n=await t.authenticate();n.access_token&&(await i.secrets.store(d.OAUTH_TOKENS,JSON.stringify({...n,issued_at:Date.now()})),await r.window.showInformationMessage("LanOnasis: Authenticated!"))}catch(n){let a=n instanceof Error?n.message:String(n);await r.window.showErrorMessage("LanOnasis: Auth failed - "+a)}})),i.subscriptions.push(r.commands.registerCommand("lzeroMemory.createMemoryFromSelection",async()=>{let n=r.window.activeTextEditor;if(!n){await r.window.showInformationMessage("No active editor");return}let a=n.document.getText(n.selection);if(!a){await r.window.showInformationMessage("No text selected");return}s.postMessage({type:"lanonasis:inject-chat",payload:{text:a}}),await r.commands.executeCommand("lzero.memorySidebar.focus")})),e.appendLine("[LanOnasis] Extension activated")}function U(){}0&&(module.exports={activate,deactivate});
