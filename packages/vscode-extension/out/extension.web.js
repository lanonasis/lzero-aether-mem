"use strict";var se=Object.create;var I=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var de=Object.getPrototypeOf,le=Object.prototype.hasOwnProperty;var pe=(r,e)=>{for(var t in e)I(r,t,{get:e[t],enumerable:!0})},V=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ce(e))!le.call(r,n)&&n!==t&&I(r,n,{get:()=>e[n],enumerable:!(o=ae(e,n))||o.enumerable});return r};var C=(r,e,t)=>(t=r!=null?se(de(r)):{},V(e||!r||!r.__esModule?I(t,"default",{value:r,enumerable:!0}):t,r)),ue=r=>V(I({},"__esModule",{value:!0}),r);var Ne={};pe(Ne,{activate:()=>_e,deactivate:()=>xe});module.exports=ue(Ne);var s=C(require("vscode"));var he=process.env.SUPABASE_URL||"https://mxtsdgkwzjzlttpotole.supabase.co",me=`${he}/functions/v1/system-health`,T={MEMORIES:"lzero.memories.cache",PENDING_QUEUE:"lzero.memories.pending",LAST_SYNC:"lzero.memories.lastSync"},K=class{constructor(e,t){this.context=e;this.output=t;this.memories=[];this.pendingQueue=[];this.lastSyncAt=null;this.isSyncing=!1;this.isOnline=!0;this.connectivityCheckInterval=null;this.loadFromStorage(),this.setupNetworkListener()}loadFromStorage(){try{let e=this.context.globalState.get(T.MEMORIES,[]),t=this.context.globalState.get(T.PENDING_QUEUE,[]),o=this.context.globalState.get(T.LAST_SYNC,null);this.memories=e,this.pendingQueue=t,this.lastSyncAt=o,this.output.appendLine(`[MemoryCache] Loaded ${this.memories.length} cached memories, ${this.pendingQueue.length} pending`)}catch(e){this.output.appendLine(`[MemoryCache] Load error: ${e}`)}}async saveToStorage(){try{await this.context.globalState.update(T.MEMORIES,this.memories),await this.context.globalState.update(T.PENDING_QUEUE,this.pendingQueue),await this.context.globalState.update(T.LAST_SYNC,this.lastSyncAt)}catch(e){this.output.appendLine(`[MemoryCache] Save error: ${e}`)}}setupNetworkListener(){this.isOnline=!0,this.startConnectivityCheck()}startConnectivityCheck(){this.connectivityCheckInterval||(this.connectivityCheckInterval=setInterval(async()=>{try{let e=new AbortController,t=setTimeout(()=>e.abort(),5e3),o=await fetch(me,{method:"GET",signal:e.signal});clearTimeout(t);let n=!this.isOnline;this.isOnline=o.ok,n&&this.isOnline&&this.output.appendLine("[MemoryCache] Network restored - online")}catch{this.isOnline&&this.output.appendLine("[MemoryCache] Network check failed - marking offline"),this.isOnline=!1}},3e4))}stopConnectivityCheck(){this.connectivityCheckInterval&&(clearInterval(this.connectivityCheckInterval),this.connectivityCheckInterval=null)}getStatus(){return{isOnline:this.isOnline,lastSyncAt:this.lastSyncAt,pendingCount:this.pendingQueue.length,isSyncing:this.isSyncing}}getMemories(){return[...this.memories]}getPendingQueue(){return[...this.pendingQueue]}getMemoryById(e){return this.memories.find(t=>t.id===e||t._localId===e)}async clearAll(){this.memories=[],this.pendingQueue=[],this.lastSyncAt=null,await this.saveToStorage()}async updateFromApi(e){this.memories=e.map(t=>({...t,_cachedAt:Date.now()})),this.lastSyncAt=Date.now(),this.isOnline=!0,await this.saveToStorage(),this.output.appendLine(`[MemoryCache] Updated cache with ${e.length} memories from API`)}async addLocal(e){let t=`local_${Date.now()}_${Math.random().toString(36).slice(2)}`,o=new Date().toISOString(),n={...e,id:t,created_at:o,updated_at:o,_pending:"create",_localId:t,_cachedAt:Date.now()};return this.memories.unshift(n),this.pendingQueue.push(n),await this.saveToStorage(),this.output.appendLine(`[MemoryCache] Added local memory: ${n.title}`),n}async markSynced(e,t){let o=this.memories.findIndex(n=>n.id===e||n._localId===e);o!==-1&&(this.memories[o]={...t,_pending:void 0,_localId:void 0,_cachedAt:Date.now()}),this.pendingQueue=this.pendingQueue.filter(n=>n._localId!==e&&n.id!==e),await this.saveToStorage()}async removePending(e){this.pendingQueue=this.pendingQueue.filter(t=>t.id!==e&&t._localId!==e),this.memories=this.memories.filter(t=>t.id!==e),await this.saveToStorage()}async queueUpdate(e,t){let o=this.memories.findIndex(a=>a.id===e);if(o===-1){this.output.appendLine(`[MemoryCache] queueUpdate: memory not found for id ${e}`);return}let n=this.memories[o]._pending;this.memories[o]={...this.memories[o],...t,updated_at:new Date().toISOString(),_pending:n==="create"?"create":"update",_cachedAt:Date.now()};let i=this.pendingQueue.findIndex(a=>a.id===e);i!==-1?this.pendingQueue[i]=this.memories[o]:this.pendingQueue.push(this.memories[o]),await this.saveToStorage()}async queueDelete(e){let t=this.memories.find(o=>o.id===e);if(t){if(t._localId&&t._pending==="create")this.memories=this.memories.filter(o=>o.id!==e),this.pendingQueue=this.pendingQueue.filter(o=>o.id!==e);else{let o={...t,_pending:"delete"};this.memories=this.memories.filter(i=>i.id!==e);let n=this.pendingQueue.findIndex(i=>i.id===e);n!==-1?this.pendingQueue[n]=o:this.pendingQueue.push(o)}await this.saveToStorage()}}searchLocal(e){let t=e.toLowerCase();return this.memories.filter(o=>o.title.toLowerCase().includes(t)||o.content.toLowerCase().includes(t)||o.tags.some(n=>n.toLowerCase().includes(t)))}semanticSearchLocal(e){let t=e.toLowerCase(),o=[/find\s+(?:my\s+)?(.+)/i,/search\s+(?:for\s+)?(.+)/i,/show\s+(?:me\s+)?(.+)/i,/get\s+(?:my\s+)?(.+)/i,/recall\s+(.+)/i,/what\s+(?:was|were|is|are)\s+(?:my\s+)?(.+)/i,/where\s+(?:is|are|did)\s+(?:my\s+)?(.+)/i],n=t;for(let d of o){let p=t.match(d);if(p){n=p[1]||p[2]||t;break}}let i=["the","a","an","my","that","this","about","notes","note","memory","memories"],a=n.split(/\s+/).filter(d=>d.length>2&&!i.includes(d));return a.length===0?this.memories.slice(0,5):this.memories.map(d=>{let p=0,g=d.title.toLowerCase(),A=d.content.toLowerCase(),f=d.tags.map(h=>h.toLowerCase());for(let h of a)g.includes(h)&&(p+=3),A.includes(h)&&(p+=1),f.some(k=>k.includes(h))&&(p+=2);return{memory:d,score:p}}).filter(d=>d.score>0).sort((d,p)=>p.score-d.score).slice(0,10).map(d=>d.memory)}setOnline(e){this.isOnline=e}setSyncing(e){this.isSyncing=e}};var b=C(require("vscode")),ye="lanonasis.memory",M=class{constructor(e,t,o,n,i){this.context=e;this.output=t;this.cache=o;this.apiUrl=n;this.getApiKey=i}register(){if(!b.chat?.createChatParticipant){this.output.appendLine("[ChatParticipant] Chat API not available in this VS Code version");return}try{this.participant=b.chat.createChatParticipant(ye,this.handleRequest.bind(this)),this.participant.iconPath=b.Uri.joinPath(this.context.extensionUri,"media","icon.png"),this.participant.followupProvider={provideFollowups:this.provideFollowups.bind(this)},this.context.subscriptions.push(this.participant),this.output.appendLine("[ChatParticipant] Registered @memory chat participant")}catch(e){this.output.appendLine(`[ChatParticipant] Registration failed: ${e}`)}}async handleRequest(e,t,o,n){let i=e.prompt.trim(),a=e.command;if(this.output.appendLine(`[ChatParticipant] Request: "${i}", command: "${a||"none"}"`),a)switch(a){case"save":return this.handleCreate(i||"Untitled memory",o);case"find":let d=await this.parseIntent(i||"");return this.handleSearch({...d,query:i},o,n);case"list":return this.handleList(o);default:break}let l=await this.parseIntent(i);switch(l.action){case"search":return this.handleSearch(l,o,n);case"create":return this.handleCreate(i,o);case"list":return this.handleList(o);default:return this.handleHelp(o)}}async parseIntent(e){let t=e.toLowerCase().trim();if(t==="help"||t==="?"||t.includes("how do i")||t.includes("what can you"))return{memories:[],action:"help"};if(t==="list"||t==="show all"||t==="all memories"||/^(list|show)\s*(all|my)?\s*memories?$/i.test(t))return{memories:this.cache.getMemories().slice(0,10),action:"list"};let o=[/^save\s+(.+)/i,/^create\s+(?:a\s+)?(?:memory|note)\s*:?\s*(.+)/i,/^remember\s+(.+)/i,/^store\s+(.+)/i,/^\/save\s+(.+)/i];for(let i of o){let a=e.match(i);if(a&&a[1])return this.output.appendLine(`[ChatParticipant] Detected create intent: "${a[1]}"`),{memories:[],action:"create",query:e}}let n=this.cache.semanticSearchLocal(e);return n.length===0?{memories:await this.searchApi(e),action:"search",query:e}:{memories:n,action:"search",query:e}}async searchApi(e){try{let t=await this.getApiKey();if(!t)return[];let o=await fetch(`${this.apiUrl}/functions/v1/memory-search`,{method:"POST",headers:{"X-API-Key":t,"Content-Type":"application/json"},body:JSON.stringify({query:e,limit:5,threshold:.7})});if(!o.ok)return[];let n=await o.json();return n.data?.results||n.results||n.data||n||[]}catch(t){return this.output.appendLine(`[ChatParticipant] API search error: ${t}`),[]}}async handleSearch(e,t,o){if(o.isCancellationRequested)return{metadata:{action:"cancelled"}};if(e.memories.length===0)return t.markdown(`No memories found for "${e.query}".

`),t.markdown("\u{1F4A1} *Try creating a new memory with:* `@memory save [your content]`"),{metadata:{action:"search",found:0}};t.markdown(`## \u{1F9E0} Found ${e.memories.length} relevant memories

`);for(let n of e.memories){let i=n._pending?" *(pending sync)*":"";t.markdown(`### ${n.title}${i}
`),t.markdown(`${n.content.slice(0,200)}${n.content.length>200?"...":""}

`),n.tags.length>0&&t.markdown(`\u{1F3F7}\uFE0F ${n.tags.map(a=>`\`${a}\``).join(" ")}

`),t.markdown(`---

`)}return{metadata:{action:"search",found:e.memories.length}}}async handleCreate(e,t){let o=e.replace(/^(save|create|remember|store)\s*(a\s+)?(memory|note)?\s*:?\s*/i,"").trim();if(!o)return t.markdown(`Please provide content to save. Example:

`),t.markdown("`@memory save OAuth uses PKCE flow for mobile apps`"),{metadata:{action:"create",success:!1}};let n=o.slice(0,50)+(o.length>50?"...":""),i=await this.cache.addLocal({title:n,content:o,memory_type:"knowledge",tags:[]});return t.markdown(`## \u2705 Memory saved

`),t.markdown(`**${i.title}**

`),t.markdown(`${i.content}

`),t.markdown("*Memory will sync when online.*"),this.syncToApi(i),{metadata:{action:"create",success:!0,id:i.id}}}async syncToApi(e){try{let t=await this.getApiKey();if(!t)return;let o=await fetch(`${this.apiUrl}/functions/v1/memory-create`,{method:"POST",headers:{"X-API-Key":t,"Content-Type":"application/json"},body:JSON.stringify({title:e.title,content:e.content,memory_type:e.memory_type,tags:e.tags})});if(o.ok){let n=await o.json(),i=n.data||n.memory||n;await this.cache.markSynced(e.id,i),this.output.appendLine(`[ChatParticipant] Memory synced: ${e.title}`)}}catch(t){this.output.appendLine(`[ChatParticipant] Sync error: ${t}`)}}handleList(e){let t=this.cache.getMemories().slice(0,10),o=this.cache.getStatus();if(e.markdown(`## \u{1F9E0} Your Memories

`),o.pendingCount>0&&e.markdown(`\u23F3 *${o.pendingCount} memories pending sync*

`),t.length===0)return e.markdown(`No memories yet. Create one with:

`),e.markdown("`@memory save [your content]`"),{metadata:{action:"list",count:0}};for(let n of t){let i=n._pending?" \u{1F504}":"";e.markdown(`- **${n.title}**${i}
`)}return e.markdown(`
*Showing ${t.length} most recent memories*`),{metadata:{action:"list",count:t.length}}}handleHelp(e){return e.markdown(`## \u{1F9E0} L0 Memory Assistant

`),e.markdown(`I help you store and recall your development context.

`),e.markdown(`### Commands

`),e.markdown(`| Command | Description |
`),e.markdown(`|---------|-------------|
`),e.markdown("| `@memory find [query]` | Search your memories |\n"),e.markdown("| `@memory save [content]` | Save a new memory |\n"),e.markdown("| `@memory list` | Show recent memories |\n"),e.markdown("| `@memory help` | Show this help |\n\n"),e.markdown(`### Examples

`),e.markdown("- `@memory find OAuth implementation`\n"),e.markdown("- `@memory what was that regex pattern?`\n"),e.markdown("- `@memory save Use PKCE flow for mobile OAuth`\n"),{metadata:{action:"help"}}}provideFollowups(e,t,o){switch(e.metadata?.action){case"search":return[{prompt:"list",label:"\u{1F4CB} Show all memories"},{prompt:"save ",label:"\u{1F4BE} Save a new memory"}];case"create":return[{prompt:"list",label:"\u{1F4CB} Show all memories"},{prompt:"find ",label:"\u{1F50D} Search memories"}];case"list":return[{prompt:"find ",label:"\u{1F50D} Search memories"},{prompt:"save ",label:"\u{1F4BE} Save a new memory"}];default:return[{prompt:"find ",label:"\u{1F50D} Search memories"},{prompt:"list",label:"\u{1F4CB} Show all memories"}]}}};var m=C(require("vscode")),_=class r{constructor(e,t){this.context=e;this.outputChannel=t;this.migrationCompleted=!1}static{this.API_KEY_KEY="lzero.apiKey"}static{this.API_KEY_RAW_KEY="lzero.apiKey.raw"}static{this.AUTH_TOKEN_KEY="lzero.authToken"}static{this.REFRESH_TOKEN_KEY="lzero.refreshToken"}static{this.CREDENTIAL_TYPE_KEY="lzero.credentialType"}static{this.CALLBACK_PORTS=[8080,8081,8082,8083,3e3,3001]}static{this.OAUTH_TIMEOUT_MS=300*1e3}async initialize(){await this.migrateLegacySecrets()}async getApiKeyOrPrompt(){let e=await this.getApiKey();if(e)return e;let t=await this.getStoredCredentials();return t?.type==="oauth"?t.token:await this.promptForAuthentication()}async getApiKey(){try{let e=await this.context.secrets.get(r.API_KEY_RAW_KEY);if(e)return e;let t=await this.context.secrets.get(r.API_KEY_KEY);return t?await this.context.secrets.get(r.CREDENTIAL_TYPE_KEY)==="oauth"||this.looksLikeJwt(t)?(this.log("Retrieved OAuth token from secure storage (unhashed)"),t):(await this.context.secrets.store(r.API_KEY_RAW_KEY,t),this.log("Migrated plaintext API key to raw storage"),t):null}catch(e){return this.logError("Failed to retrieve API key from secure storage",e),null}}async hasApiKey(){return await this.getApiKey()?!0:await this.getAuthenticationHeader()!==null}async promptForAuthentication(){let e=await m.window.showQuickPick([{label:"$(key) OAuth (Browser)",description:"Authenticate using OAuth2 with browser (Recommended)",value:"oauth"},{label:"$(key) API Key",description:"Enter API key directly",value:"apikey"},{label:"$(circle-slash) Cancel",description:"Cancel authentication",value:"cancel"}],{placeHolder:"Choose authentication method"});return!e||e.value==="cancel"?null:e.value==="oauth"?await this.authenticateWithOAuthFlow():await this.promptForApiKeyEntry()}async authenticateWithOAuthFlow(){if(!await this.authenticateOAuth())return null;let t=await this.getApiKey();if(t)return t;let o=await this.getAuthenticationHeader();return o?.startsWith("Bearer ")?o.replace("Bearer ",""):null}async promptForApiKeyEntry(){let e=await m.window.showInputBox({prompt:"Enter your L0 Memory API Key",placeHolder:"Get your API key from api.lanonasis.com",password:!0,ignoreFocusOut:!0,validateInput:t=>!t||t.trim().length===0?"API key is required":t.length<20?"API key seems too short":null});return e?(await this.storeApiKey(e,"apiKey"),await this.context.secrets.delete(r.AUTH_TOKEN_KEY),await this.context.secrets.delete(r.REFRESH_TOKEN_KEY),this.log("API key stored securely"),e):null}async storeApiKeyDirect(e){await this.storeApiKey(e,"apiKey"),await this.context.secrets.delete(r.AUTH_TOKEN_KEY),await this.context.secrets.delete(r.REFRESH_TOKEN_KEY),this.log("API key stored from webview")}async authenticateOAuth(){try{let t=m.workspace.getConfiguration("lzero").get("authUrl")||"https://auth.lanonasis.com",o="vscode-extension";this.log("Starting Device Code authentication flow...");let n=await fetch(`${t}/oauth/device`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({client_id:o,scope:"memories:read memories:write memories:delete profile"})});if(!n.ok){let f=await n.text();throw new Error(`Failed to request device code: ${n.status} ${f}`)}let i=await n.json();this.log(`Device code received. User code: ${i.user_code}`);let a=await m.window.showInformationMessage(`Enter this code in your browser: ${i.user_code}`,{modal:!0},"Open Browser","Copy Code");if(a==="Open Browser")await m.env.openExternal(m.Uri.parse(i.verification_uri_complete));else if(a==="Copy Code")await m.env.clipboard.writeText(i.user_code),await m.env.openExternal(m.Uri.parse(i.verification_uri)),m.window.showInformationMessage("Code copied! Paste it in the browser window.");else return this.log("User cancelled device code flow"),!1;let l=Math.max((i.interval||5)*1e3,1e3),d=l,p=3e4,g=Date.now()+i.expires_in*1e3,A="urn:ietf:params:oauth:grant-type:device_code";return await m.window.withProgress({location:m.ProgressLocation.Notification,title:"Waiting for authorization...",cancellable:!0},async(f,h)=>{for(;Date.now()<g;){if(h.isCancellationRequested)return this.log("User cancelled device code polling"),!1;await new Promise(k=>setTimeout(k,d));try{let c=await(await fetch(`${t}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:new URLSearchParams({grant_type:A,device_code:i.device_code,client_id:o}).toString()})).json();if(c.error==="authorization_pending"){f.report({message:"Waiting for you to authorize in browser..."}),d=l;continue}if(c.error==="slow_down"){d=Math.min(d*2,p),await new Promise(u=>setTimeout(u,d));continue}if(c.error==="access_denied")return this.log("User denied authorization"),m.window.showWarningMessage("Authorization was denied."),!1;if(c.error==="expired_token")return this.log("Device code expired"),m.window.showWarningMessage("Authorization timed out. Please try again."),!1;if(c.error)throw new Error(c.error_description||c.error);if(c.access_token){await this.storeApiKey(c.access_token,"oauth"),c.refresh_token&&await this.context.secrets.store(r.REFRESH_TOKEN_KEY,c.refresh_token);let u={access_token:c.access_token,expires_at:Date.now()+(c.expires_in?c.expires_in*1e3:36e5)};return await this.context.secrets.store(r.AUTH_TOKEN_KEY,JSON.stringify(u)),this.log("Device code authentication successful!"),m.window.showInformationMessage("\u2713 Authentication successful!"),!0}}catch(k){this.logError("Token polling error",k),d=Math.min(d*2,p)}}return this.log("Device code expired"),m.window.showWarningMessage("Authorization timed out. Please try again."),!1})}catch(e){return this.logError("Device code authentication failed",e),m.env.uiKind===m.UIKind.Web?!1:(this.log("Falling back to PKCE redirect flow..."),await this.authenticateOAuthPKCE())}}async authenticateOAuthPKCE(){if(m.env.uiKind===m.UIKind.Web)return this.log("PKCE flow not supported in web environment"),!1;for(let e of r.CALLBACK_PORTS)try{return await this.tryPKCEWithPort(e)}catch(t){let o=t instanceof Error?t.message:String(t);if(o.includes("EADDRINUSE")||o.includes("already in use")){this.log(`Port ${e} is in use, trying next port...`);continue}throw t}throw this.log("All callback ports are in use"),new Error("Unable to start OAuth callback server - all ports are in use. Please close some applications and try again.")}async tryPKCEWithPort(e){return new Promise((t,o)=>{let n;try{let a=m.workspace.getConfiguration("lzero").get("authUrl")||"https://auth.lanonasis.com",l="vscode-extension",d=`http://localhost:${e}/callback`,p=this.generateCodeVerifier(),g=this.generateState();(async()=>{let f=await this.generateCodeChallenge(p);await this.context.secrets.store("lzero.oauth_code_verifier",p),await this.context.secrets.store("lzero.oauth_state",g);let h=new URL("/oauth/authorize",a);h.searchParams.set("client_id",l),h.searchParams.set("response_type","code"),h.searchParams.set("redirect_uri",d),h.searchParams.set("scope","memories:read memories:write memories:delete profile"),h.searchParams.set("code_challenge",f),h.searchParams.set("code_challenge_method","S256"),h.searchParams.set("state",g);let c=this.getNodeHttp().createServer(async(u,w)=>{try{if(!u.url){w.writeHead(400,{"Content-Type":"text/plain"}),w.end("Missing URL");return}let P=new URL(u.url,`http://localhost:${e}`);if(P.pathname==="/callback"){let S=P.searchParams.get("code"),re=P.searchParams.get("state"),z=P.searchParams.get("error"),ie=await this.context.secrets.get("lzero.oauth_state");if(re!==ie){w.writeHead(400,{"Content-Type":"text/html"}),w.end("<h1>Invalid state parameter</h1>"),c.close(),n&&clearTimeout(n),o(new Error("Invalid state parameter"));return}if(z){w.writeHead(400,{"Content-Type":"text/html"}),w.end(`<h1>OAuth Error: ${z}</h1>`),c.close(),n&&clearTimeout(n),o(new Error(`OAuth error: ${z}`));return}if(S){let F=await this.exchangeCodeForToken(S,p,d,a);await this.storeApiKey(F.access_token,"oauth"),F.refresh_token&&await this.context.secrets.store(r.REFRESH_TOKEN_KEY,F.refresh_token),w.writeHead(200,{"Content-Type":"text/html"}),w.end(`
                                  <html>
                                    <head><title>Authentication Success</title></head>
                                    <body>
                                      <h1 style="color: green;">\u2713 Authentication Successful!</h1>
                                      <p>You can close this window and return to VS Code.</p>
                                      <script>setTimeout(() => window.close(), 2000);<\/script>
                                    </body>
                                  </html>
                                `),await this.context.secrets.delete("lzero.oauth_code_verifier"),await this.context.secrets.delete("lzero.oauth_state"),c.close(),n&&clearTimeout(n),t(!0)}}else w.writeHead(404,{"Content-Type":"text/plain"}),w.end("Not found")}catch(P){w.writeHead(500,{"Content-Type":"text/html"}),w.end(`<h1>Error: ${P instanceof Error?P.message:"Unknown error"}</h1>`),c.close(),n&&clearTimeout(n),o(P)}});c.on("error",u=>{n&&clearTimeout(n),u.code==="EADDRINUSE"?o(new Error(`Port ${e} is already in use. Please close any applications using this port and try again.`)):o(new Error(`Failed to start OAuth callback server: ${u.message}`))}),c.listen(e,"localhost",()=>{this.outputChannel.appendLine(`OAuth callback server listening on port ${e}`),m.env.openExternal(m.Uri.parse(h.toString()))}),n=setTimeout(()=>{c.close(),o(new Error("OAuth authentication timeout"))},r.OAUTH_TIMEOUT_MS)})().catch(f=>{n&&clearTimeout(n),o(f)})}catch(i){n&&clearTimeout(n),o(i)}})}async getAuthenticationHeader(){let e=await this.getStoredCredentials();return e?.type==="oauth"?`Bearer ${e.token}`:null}async getStoredCredentials(){let e=await this.context.secrets.get(r.AUTH_TOKEN_KEY);if(e)try{let o=JSON.parse(e);if(o?.access_token){if(this.isTokenValid(o))return{type:"oauth",token:o.access_token};this.log("Access token expired, attempting refresh...");let n=await this.refreshAccessToken();return n?{type:"oauth",token:n}:(this.log("Token refresh failed, clearing expired credentials"),await this.deleteApiKey(),null)}}catch(o){this.logError("Failed to parse stored OAuth token",o)}let t=await this.getApiKey();if(t){let o=await this.context.secrets.get(r.CREDENTIAL_TYPE_KEY);return{type:o==="oauth"||o==="apiKey"?o:this.looksLikeJwt(t)?"oauth":"apiKey",token:t}}return null}async refreshAccessToken(){try{let e=await this.context.secrets.get(r.REFRESH_TOKEN_KEY);if(!e)return this.log("No refresh token available"),null;let o=m.workspace.getConfiguration("lzero").get("authUrl")||"https://auth.lanonasis.com",n=new URL("/oauth/token",o);this.log(`Refreshing token via ${n.toString()}`);let i=new URLSearchParams({grant_type:"refresh_token",client_id:"vscode-extension",refresh_token:e}),a=await fetch(n.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:i.toString()});if(!a.ok){let p=await a.text();return this.logError(`Token refresh failed: ${a.status}`,p),(a.status===400||a.status===401)&&await this.context.secrets.delete(r.REFRESH_TOKEN_KEY),null}let l=await a.json(),d={access_token:l.access_token,expires_at:Date.now()+(l.expires_in?l.expires_in*1e3:36e5)};return await this.context.secrets.store(r.AUTH_TOKEN_KEY,JSON.stringify(d)),await this.storeApiKey(l.access_token,"oauth"),l.refresh_token&&(await this.context.secrets.store(r.REFRESH_TOKEN_KEY,l.refresh_token),this.log("Refresh token rotated")),this.log("Access token refreshed successfully"),l.access_token}catch(e){return this.logError("Token refresh error",e),null}}async deleteApiKey(){await this.context.secrets.delete(r.API_KEY_KEY),await this.context.secrets.delete(r.API_KEY_RAW_KEY),await this.context.secrets.delete(r.AUTH_TOKEN_KEY),await this.context.secrets.delete(r.REFRESH_TOKEN_KEY),await this.context.secrets.delete(r.CREDENTIAL_TYPE_KEY),this.log("API key removed from secure storage")}async storeApiKey(e,t){if(t==="oauth"){await this.context.secrets.store(r.API_KEY_RAW_KEY,e),await this.context.secrets.store(r.API_KEY_KEY,e),await this.context.secrets.store(r.CREDENTIAL_TYPE_KEY,t);return}await this.context.secrets.store(r.API_KEY_RAW_KEY,e),await this.context.secrets.store(r.API_KEY_KEY,e),await this.context.secrets.store(r.CREDENTIAL_TYPE_KEY,t)}async migrateLegacySecrets(){if(this.migrationCompleted)return;if(await this.hasApiKey()){this.migrationCompleted=!0;return}let t=await this.context.secrets.get("lanonasis.apiKey"),o=await this.context.secrets.get("lanonasis.tokens");if(o)try{let n=JSON.parse(o);n.access_token&&(await this.storeApiKey(n.access_token,"oauth"),this.log("Migrated OAuth token from legacy storage"))}catch(n){this.logError("Failed to migrate legacy tokens",n)}else t&&(await this.storeApiKey(t,"apiKey"),this.log("Migrated API key from legacy storage"));this.migrationCompleted=!0}async exchangeCodeForToken(e,t,o,n){let i=new URL("/oauth/token",n),a=new URLSearchParams({grant_type:"authorization_code",client_id:"vscode-extension",code:e,redirect_uri:o,code_verifier:t}),l=await fetch(i.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:a.toString()});if(!l.ok){let g=await l.text();throw new Error(`Token exchange failed: ${l.status} ${g}`)}let d=await l.json(),p={access_token:d.access_token,expires_at:Date.now()+(d.expires_in?d.expires_in*1e3:36e5)};return await this.context.secrets.store(r.AUTH_TOKEN_KEY,JSON.stringify(p)),{access_token:d.access_token,refresh_token:d.refresh_token}}isTokenValid(e){return e.expires_at?Date.now()<e.expires_at-6e4:!0}looksLikeJwt(e){let t=e.split(".");if(t.length!==3)return!1;let o=/^[A-Za-z0-9-_]+$/;return t.every(n=>o.test(n))}generateCodeVerifier(){let e=this.getRandomBytes(32);return this.base64UrlEncode(e)}async generateCodeChallenge(e){let t=this.getWebCrypto(),o=new TextEncoder().encode(e),n=await t.subtle.digest("SHA-256",o);return this.base64UrlEncode(new Uint8Array(n))}generateState(){let e=this.getRandomBytes(16);return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}getWebCrypto(){if(globalThis.crypto)return globalThis.crypto;throw new Error("WebCrypto is not available in this environment")}getRandomBytes(e){let t=this.getWebCrypto(),o=new Uint8Array(e);return t.getRandomValues(o),o}base64UrlEncode(e){let t;if(typeof Buffer<"u")t=Buffer.from(e).toString("base64");else{let o="";for(let n of e)o+=String.fromCharCode(n);t=btoa(o)}return t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}getNodeHttp(){return this.getNodeRequire()("http")}getNodeRequire(){if(typeof __non_webpack_require__=="function")return __non_webpack_require__;if(typeof require<"u")return require;if(typeof module<"u"&&typeof module.require=="function")return module.require.bind(module);throw new Error("Node require not available in this environment")}log(e){let t=new Date().toISOString();this.outputChannel.appendLine(`[${t}] [SecureApiKeyService] ${e}`)}logError(e,t){let o=t instanceof Error?t.message:String(t);this.log(`${e}: ${o}`),console.error(e,t)}};var ge=3e4,x=class{constructor(e,t,o){this.secureApiKeyService=e;this.output=t;this.edgeFunctionsUrl=o}async fetchWithTimeout(e,t,o=ge){let n=new AbortController,i=setTimeout(()=>n.abort(),o);try{return await fetch(e,{...t,signal:n.signal})}catch(a){throw a instanceof Error&&a.name==="AbortError"?new Error(`Request timed out after ${o}ms`):a}finally{clearTimeout(i)}}async isAuthenticated(){return await this.secureApiKeyService.hasApiKey()}async getAuthHeaders(){let e=await this.secureApiKeyService.getStoredCredentials();if(!e)throw new Error("Not authenticated");return e.type==="oauth"?{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}:{"X-API-Key":e.token,"Content-Type":"application/json"}}async testConnection(){let e=await this.getAuthHeaders(),t=await this.fetchWithTimeout(`${this.edgeFunctionsUrl}/functions/v1/system-health`,{method:"GET",headers:e},1e4);if(!t.ok){let o=await t.text();throw new Error(`Health check failed (${t.status}): ${o}`)}}async listMemories(e=100){let t=await this.getAuthHeaders(),o=await this.fetchWithTimeout(`${this.edgeFunctionsUrl}/functions/v1/memory-list?limit=${e}`,{method:"GET",headers:t});if(!o.ok){let a=await o.text();throw new Error(`List memories failed (${o.status}): ${a}`)}let n=await o.json();return n.data?.memories||n.memories||n.data||n||[]}async searchMemories(e,t={}){let o=await this.getAuthHeaders(),n=await this.fetchWithTimeout(`${this.edgeFunctionsUrl}/functions/v1/memory-search`,{method:"POST",headers:o,body:JSON.stringify({query:e,limit:t.limit??10,threshold:t.threshold??.7})});if(!n.ok){let l=await n.text();throw new Error(`Search memories failed (${n.status}): ${l}`)}let i=await n.json();return i.data?.results||i.results||i.data||[]}async createMemory(e){let t=await this.getAuthHeaders(),o=await this.fetchWithTimeout(`${this.edgeFunctionsUrl}/functions/v1/memory-create`,{method:"POST",headers:t,body:JSON.stringify(e)});if(!o.ok){let i=await o.text();throw new Error(`Create memory failed (${o.status}): ${i}`)}let n=await o.json();return n.data||n.memory||n}async updateMemory(e,t){let o=await this.getAuthHeaders(),n=await this.fetchWithTimeout(`${this.edgeFunctionsUrl}/functions/v1/memory-update`,{method:"POST",headers:o,body:JSON.stringify({id:e,...t})});if(!n.ok){let a=await n.text();throw new Error(`Update memory failed (${n.status}): ${a}`)}let i=await n.json();return i.data||i.memory||i}async deleteMemory(e){let t=await this.getAuthHeaders(),o=await this.fetchWithTimeout(`${this.edgeFunctionsUrl}/functions/v1/memory-delete`,{method:"POST",headers:t,body:JSON.stringify({id:e})});if(!o.ok){let n=await o.text();throw new Error(`Delete memory failed (${o.status}): ${n}`)}}async getMemory(e){let t=await this.getAuthHeaders(),o=await this.fetchWithTimeout(`${this.edgeFunctionsUrl}/functions/v1/memory-get?id=${encodeURIComponent(e)}`,{method:"GET",headers:t});if(!o.ok){let i=await o.text();throw new Error(`Get memory failed (${o.status}): ${i}`)}let n=await o.json();return n.data||n.memory||n}};var H=C(require("vscode")),Q=3e4,$=class{constructor(e,t){this.secureApiKeyService=e;this.output=t;this.baseUrl="https://api.lanonasis.com";this.userInfoCache=null;this.userInfoCacheExpiry=0;this.config=H.workspace.getConfiguration("lzero"),this.updateConfig()}async fetchWithTimeout(e,t,o=Q){let n=new AbortController,i=setTimeout(()=>n.abort(),o);try{return await fetch(e,{...t,signal:n.signal})}catch(a){throw a instanceof Error&&a.name==="AbortError"?new Error(`Request timed out after ${o}ms`):a}finally{clearTimeout(i)}}updateConfig(){let e=this.config.get("useGateway",!1),t=this.config.get("apiUrl","https://api.lanonasis.com"),o=this.config.get("gatewayUrl","https://api.lanonasis.com");this.baseUrl=this.sanitizeBaseUrl(e?o:t)}refreshConfig(){this.config=H.workspace.getConfiguration("lzero"),this.updateConfig()}async makeRequest(e,t={},o=Q){let n=await this.resolveCredentials(),i=e.startsWith("/")?e:`/${e}`,a=`${this.baseUrl}${i}`,l=n.type==="oauth"?{Authorization:`Bearer ${n.token}`}:{"X-API-Key":n.token},d=await this.fetchWithTimeout(a,{...t,headers:{"Content-Type":"application/json",...l,...t.headers}},o);if(!d.ok){let p=await d.text();throw new Error(`API request failed: ${d.status} ${d.statusText} - ${p}`)}return d.json()}sanitizeBaseUrl(e){if(!e)return"https://api.lanonasis.com";let t=e.trim();return t=t.replace(/\/+$/,""),t=t.replace(/\/api\/v1$/i,"").replace(/\/api$/i,""),t||"https://api.lanonasis.com"}async resolveCredentials(){let e=await this.secureApiKeyService.getStoredCredentials();if(!e){let t=await this.secureApiKeyService.getApiKeyOrPrompt();if(!t)throw new Error("API key not configured. Please configure your API key to use L0 Memory services.");e=await this.secureApiKeyService.getStoredCredentials(),e||(e={type:this.looksLikeJwt(t)?"oauth":"apiKey",token:t})}return e}looksLikeJwt(e){let t=e.split(".");if(t.length!==3)return!1;let o=/^[A-Za-z0-9-_]+$/;return t.every(n=>o.test(n))}async getProjects(){return this.makeRequest("/api/v1/projects")}async getProject(e){return this.makeRequest(`/api/v1/projects/${e}`)}async createProject(e){return this.makeRequest("/api/v1/projects",{method:"POST",body:JSON.stringify(e)})}async updateProject(e,t){return this.makeRequest(`/api/v1/projects/${e}`,{method:"PUT",body:JSON.stringify(t)})}async deleteProject(e){await this.makeRequest(`/api/v1/projects/${e}`,{method:"DELETE"})}async getApiKeys(e){let t=e?`/api/v1/projects/${e}/api-keys`:"/api/v1/auth/api-keys",o=await this.makeRequest(t);return o&&typeof o=="object"&&"data"in o&&Array.isArray(o.data)?o.data:Array.isArray(o)?o:[]}async getApiKey(e){return this.makeRequest(`/api/v1/auth/api-keys/${e}`)}async createApiKey(e){return this.makeRequest("/api/v1/auth/api-keys",{method:"POST",body:JSON.stringify(e)})}async updateApiKey(e,t){return this.makeRequest(`/api/v1/auth/api-keys/${e}`,{method:"PUT",body:JSON.stringify(t)})}async deleteApiKey(e){await this.makeRequest(`/api/v1/auth/api-keys/${e}`,{method:"DELETE"})}async rotateApiKey(e){return this.makeRequest(`/api/v1/auth/api-keys/${e}/rotate`,{method:"POST"})}async testConnection(){try{let e=await this.resolveCredentials();if(e.type==="oauth"){let t=await this.fetchWithTimeout(`${this.baseUrl}/oauth/introspect`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Bearer ${e.token}`},body:new URLSearchParams({token:e.token})},1e4);if(!t.ok){let n=await t.text();return this.log(`OAuth introspection failed: ${t.status} ${t.statusText} - ${n}`),!1}return(await t.json()).active===!0}return await this.makeRequest("/health",{},1e4),!0}catch(e){let t=e instanceof Error?e.message:String(e);return this.log(`Test connection failed: ${t}`),!1}}async getUserInfo(e=!1){let t=Date.now();if(!e&&this.userInfoCache&&this.userInfoCacheExpiry>t)return this.userInfoCache;let o=[{endpoint:"/api/v1/auth/me",method:"GET"},{endpoint:"/api/v1/auth/session",method:"GET"},{endpoint:"/v1/auth/me",method:"GET"},{endpoint:"/v1/auth/session",method:"GET"}],n;for(let{endpoint:i,method:a}of o)try{let l=await this.makeRequest(i,{method:a},1e4),d=this.normalizeUserInfo(l);if(d)return this.userInfoCache=d,this.userInfoCacheExpiry=t+300*1e3,this.log(`User info retrieved from ${i}`),d}catch(l){n=l;let d=String(l);if(!(d.includes("404")||d.includes("405")||d.includes("Method Not Allowed")))break}if(this.userInfoCache=null,this.userInfoCacheExpiry=0,n)throw n instanceof Error?n:new Error(String(n));return null}clearUserInfoCache(){this.userInfoCache=null,this.userInfoCacheExpiry=0}normalizeUserInfo(e){if(!e||typeof e!="object")return null;let t=e,o=this.readUserFields(t);if(o)return o;let n=t.data;if(n&&typeof n=="object"){let l=this.readUserFields(n);if(l)return l}let i=t.session;if(i&&typeof i=="object"){let l=this.readUserFields(i);if(l)return l;let d=i.user;if(d&&typeof d=="object"){let p=this.readUserFields(d);if(p)return p}}let a=t.user;if(a&&typeof a=="object"){let l=this.readUserFields(a);if(l)return l}return null}readUserFields(e){let t=typeof e.id=="string"?e.id:typeof e.user_id=="string"?e.user_id:void 0,o=typeof e.email=="string"?e.email:typeof e.user_email=="string"?e.user_email:void 0,n=typeof e.name=="string"?e.name:typeof e.full_name=="string"?e.full_name:typeof e.username=="string"?e.username:void 0;return!t&&!o&&!n?null:{id:t||"unknown",email:o||"unknown",name:n}}log(e){this.output&&this.output.appendLine(`[ApiKeyService] ${e}`)}};var v=C(require("vscode")),L=class extends v.TreeItem{constructor(t,o){super(t.title,o);this.memory=t;this.tooltip=`${t.title}

Type: ${t.memory_type}
Created: ${new Date(t.created_at).toLocaleDateString()}

${t.content.substring(0,200)}${t.content.length>200?"...":""}`,this.description=t.memory_type,this.contextValue="memory",this.iconPath=this.getIconForMemoryType(t.memory_type),this.command={command:"lzeroMemory.openMemory",title:"Open Memory",arguments:[t]}}getIconForMemoryType(t){switch(t){case"conversation":return new v.ThemeIcon("comment-discussion");case"knowledge":return new v.ThemeIcon("book");case"project":return new v.ThemeIcon("project");case"context":return new v.ThemeIcon("info");case"reference":return new v.ThemeIcon("references");case"personal":return new v.ThemeIcon("account");case"workflow":return new v.ThemeIcon("settings");default:return new v.ThemeIcon("file")}}},E=class extends v.TreeItem{constructor(t,o,n){super(t,n);this.memoryType=t;this.memories=o;this.tooltip=`${t} (${o.length} memories)`,this.description=`${o.length} memories`,this.contextValue="memoryType",this.iconPath=new v.ThemeIcon("folder")}},R=class{constructor(e){this.memoryService=e;this._onDidChangeTreeData=new v.EventEmitter;this.onDidChangeTreeData=this._onDidChangeTreeData.event;this.memories=[];this.loading=!1;this.authenticated=!1;this.setAuthenticated(!1)}async loadMemories(){if(!this.authenticated){this.memories=[],this.loading=!1,this._onDidChangeTreeData.fire();return}try{this.loading=!0,this.memories=await this.memoryService.listMemories(100)}catch(e){this.memories=[],e instanceof Error&&e.message.includes("Not authenticated")||v.window.showErrorMessage(`Failed to load memories: ${e instanceof Error?e.message:"Unknown error"}`)}finally{this.loading=!1,this._onDidChangeTreeData.fire()}}refresh(){if(!this.authenticated){this.clear();return}this.loadMemories()}async setAuthenticated(e){this.authenticated=e,e?this.loadMemories():this.clear()}clear(){this.loading=!1,this.memories=[],this._onDidChangeTreeData.fire()}getTreeItem(e){return e}getChildren(e){return this.authenticated?this.loading?Promise.resolve([]):e?e instanceof E?Promise.resolve(e.memories.map(t=>new L(t,v.TreeItemCollapsibleState.None))):Promise.resolve([]):Promise.resolve(this.getMemoryTypeGroups()):Promise.resolve([])}getMemoryTypeGroups(){let e=["conversation","knowledge","project","context","reference","personal","workflow"],t=[];for(let o of e){let n=this.memories.filter(i=>i.memory_type===o);n.length>0&&t.push(new E(o,n,v.TreeItemCollapsibleState.Collapsed))}return t}getParent(e){if(!this.authenticated)return null;if(e instanceof L){let t=e.memory.memory_type,o=this.memories.filter(n=>n.memory_type===t);return new E(t,o,v.TreeItemCollapsibleState.Collapsed)}return null}};var y=C(require("vscode")),q=class extends y.TreeItem{constructor(e,t){if(super(e.name,t),this.apiKey=e,this.tooltip=`${e.name}
Type: ${e.keyType}
Environment: ${e.environment}
Access Level: ${e.accessLevel}`,this.description=`${e.environment} \u2022 ${e.keyType}`,this.contextValue="apiKey",this.iconPath=this.getIconForKeyType(e.keyType),e.expiresAt){let o=new Date(e.expiresAt),n=new Date,i=Math.floor((o.getTime()-n.getTime())/(1e3*60*60*24));i<=7&&(this.description+=` \u26A0\uFE0F Expires in ${i} days`)}}getIconForKeyType(e){let t={api_key:"key",database_url:"database",oauth_token:"account",certificate:"certificate",ssh_key:"terminal",webhook_secret:"webhook",encryption_key:"shield"};return new y.ThemeIcon(t[e]||"key")}},O=class extends y.TreeItem{constructor(e,t){super(e.name,t),this.project=e,this.tooltip=`${e.name}
${e.description||"No description"}
Organization: ${e.organizationId}`,this.description=e.description?e.description.substring(0,50)+"...":"No description",this.contextValue="project",this.iconPath=new y.ThemeIcon("folder")}},U=class{constructor(e,t){this.apiKeyService=e;this.output=t;this._onDidChangeTreeData=new y.EventEmitter;this.onDidChangeTreeData=this._onDidChangeTreeData.event;this.projects=[];this.apiKeys={};this.authenticated=!1}refresh(e=!1){e&&this.clearCache(),this._onDidChangeTreeData.fire()}setAuthenticated(e){this.authenticated=e,e?(this.clear(),this.refresh()):this.clear()}clear(){this.clearCache(),this._onDidChangeTreeData.fire()}getTreeItem(e){return e}async getChildren(e){if(!this.authenticated){let t=new y.TreeItem("Not authenticated",y.TreeItemCollapsibleState.None);return t.description="Click to authenticate",t.iconPath=new y.ThemeIcon("key"),t.contextValue="notAuthenticated",t.command={command:"lzeroMemory.authenticate",title:"Authenticate",arguments:["oauth"]},[t]}try{if(!e){if(this.projects=await this.apiKeyService.getProjects(),this.projects.length===0){let t=new y.TreeItem("No projects found",y.TreeItemCollapsibleState.None);return t.description="Click + to create a project",t.iconPath=new y.ThemeIcon("info"),t.contextValue="empty",[t]}return this.projects.map(t=>new O(t,y.TreeItemCollapsibleState.Collapsed))}if(e instanceof O){let t=e.project.id;if(this.apiKeys[t]||(this.apiKeys[t]=await this.apiKeyService.getApiKeys(t)),this.apiKeys[t].length===0){let o=new y.TreeItem("No API keys in this project",y.TreeItemCollapsibleState.None);return o.description="Right-click project to create a key",o.iconPath=new y.ThemeIcon("info"),o.contextValue="empty",[o]}return this.apiKeys[t].map(o=>new q(o,y.TreeItemCollapsibleState.None))}}catch(t){let o=t instanceof Error?t.message:String(t);this.output.appendLine(`[ApiKeyTreeProvider] Error loading API keys: ${o}`);let n=t instanceof Error?t.message:"Unknown error";if(n.includes("401")||n.includes("No token")||n.includes("AUTH_TOKEN_MISSING")){let a=new y.TreeItem("Authentication required",y.TreeItemCollapsibleState.None);return a.description="Click to authenticate",a.iconPath=new y.ThemeIcon("warning"),a.contextValue="authRequired",a.command={command:"lzeroMemory.authenticate",title:"Authenticate",arguments:["oauth"]},a.tooltip=`Authentication error: ${n}`,[a]}if(n.includes("405")||n.includes("404")||n.includes("Not Found")){let a=new y.TreeItem("API Key Management",y.TreeItemCollapsibleState.None);return a.description="Not available on this server",a.iconPath=new y.ThemeIcon("info"),a.contextValue="notAvailable",a.tooltip="The API key management endpoints are not available on the current server.",[a]}let i=new y.TreeItem("Error loading data",y.TreeItemCollapsibleState.None);return i.description=n.length>50?n.substring(0,50)+"...":n,i.iconPath=new y.ThemeIcon("error"),i.contextValue="error",i.tooltip=n,[i]}return[]}async addProject(e){this.projects.push(e),this.refresh()}async updateProject(e){let t=this.projects.findIndex(o=>o.id===e.id);t!==-1&&(this.projects[t]=e,this.refresh())}async removeProject(e){this.projects=this.projects.filter(t=>t.id!==e),delete this.apiKeys[e],this.refresh()}async addApiKey(e,t){this.apiKeys[e]||(this.apiKeys[e]=[]),this.apiKeys[e].push(t),this.refresh()}async updateApiKey(e,t){if(this.apiKeys[e]){let o=this.apiKeys[e].findIndex(n=>n.id===t.id);o!==-1&&(this.apiKeys[e][o]=t,this.refresh())}}async removeApiKey(e,t){this.apiKeys[e]&&(this.apiKeys[e]=this.apiKeys[e].filter(o=>o.id!==t),this.refresh())}clearCache(){this.projects=[],this.apiKeys={}}};var j=C(require("vscode"));async function J(r,e,t,o){let n=[];o.appendLine("=================================================="),o.appendLine("Starting L0 Memory Extension Diagnostics"),o.appendLine(`Timestamp: ${new Date().toISOString()}`),o.appendLine(`==================================================
`),n.push(await fe(r,o)),n.push(await we(o)),n.push(await ve(o)),n.push(await Ae(e,o)),n.push(await ke(t,o)),n.push(await Pe(r,o));let i=Se(n);return o.appendLine(`
==================================================`),o.appendLine(`Overall Health: ${i.toUpperCase()}`),o.appendLine("=================================================="),{overall:i,results:n,timestamp:new Date}}async function fe(r,e){e.appendLine("[1/6] Checking Extension Context...");try{if(!r)return{category:"Extension Context",status:"error",message:"Extension context is not available",action:"Reload VS Code"};let t=r.globalStorageUri?.fsPath,o=r.storageUri?.fsPath;return e.appendLine(`  \u2713 Extension ID: ${r.extension.id}`),e.appendLine(`  \u2713 Extension Path: ${r.extensionPath}`),e.appendLine(`  \u2713 Global Storage: ${t||"N/A"}`),e.appendLine(`  \u2713 Workspace Storage: ${o||"N/A"}`),{category:"Extension Context",status:"success",message:"Extension context is properly initialized"}}catch(t){return e.appendLine(`  \u2717 Error: ${t instanceof Error?t.message:String(t)}`),{category:"Extension Context",status:"error",message:"Failed to check extension context",details:t instanceof Error?t.message:String(t)}}}async function we(r){r.appendLine(`
[2/6] Checking VS Code Version...`);try{let e=j.version,t="1.93.0";r.appendLine(`  \u2713 Current Version: ${e}`),r.appendLine(`  \u2713 Required Version: ${t}+`);let[o,n]=e.split(".").map(Number),[i,a]=t.split(".").map(Number);return o>i||o===i&&n>=a?{category:"VS Code Version",status:"success",message:`VS Code ${e} meets minimum requirements`}:{category:"VS Code Version",status:"warning",message:`VS Code ${e} is below recommended version ${t}`,action:"Update VS Code"}}catch(e){return r.appendLine(`  \u2717 Error: ${e instanceof Error?e.message:String(e)}`),{category:"VS Code Version",status:"error",message:"Failed to check VS Code version",details:e instanceof Error?e.message:String(e)}}}async function ve(r){r.appendLine(`
[3/6] Checking Configuration...`);try{let e=j.workspace.getConfiguration("lzero"),t=e.get("apiUrl"),o=e.get("gatewayUrl"),n=e.get("useGateway"),i=e.get("enableApiKeyManagement");r.appendLine(`  \u2713 API URL: ${t}`),r.appendLine(`  \u2713 Gateway URL: ${o}`),r.appendLine(`  \u2713 Use Gateway: ${n}`),r.appendLine(`  \u2713 API Key Mgmt: ${i}`);let a=[];return t||a.push("API URL not configured"),n&&!o&&a.push("Gateway mode enabled but Gateway URL not configured"),a.length>0?{category:"Configuration",status:"warning",message:"Configuration issues detected",details:a.join("; "),action:"Check Settings"}:{category:"Configuration",status:"success",message:"Configuration is valid"}}catch(e){return r.appendLine(`  \u2717 Error: ${e instanceof Error?e.message:String(e)}`),{category:"Configuration",status:"error",message:"Failed to check configuration",details:e instanceof Error?e.message:String(e)}}}async function Ae(r,e){e.appendLine(`
[4/6] Checking Authentication...`);try{if(await r.hasApiKey()){e.appendLine("  \u2713 API key is stored securely");try{let o=await r.getApiKey();return o&&o.length>0?(e.appendLine(`  \u2713 API key length: ${o.length} characters`),e.appendLine(`  \u2713 API key prefix: ${o.substring(0,8)}...`),{category:"Authentication",status:"success",message:"Authenticated with valid API key"}):{category:"Authentication",status:"warning",message:"API key exists but appears empty",action:"Re-authenticate"}}catch(o){return{category:"Authentication",status:"warning",message:"API key exists but could not be retrieved",details:o instanceof Error?o.message:String(o),action:"Re-authenticate"}}}return e.appendLine("  \u2139 No API key configured"),{category:"Authentication",status:"info",message:"Not authenticated",action:"Authenticate"}}catch(t){return e.appendLine(`  \u2717 Error: ${t instanceof Error?t.message:String(t)}`),{category:"Authentication",status:"error",message:"Failed to check authentication status",details:t instanceof Error?t.message:String(t)}}}async function ke(r,e){e.appendLine(`
[5/6] Checking Network Connectivity...`);try{if(!await r.isAuthenticated())return e.appendLine("  \u2139 Skipping (not authenticated)"),{category:"Network Connectivity",status:"info",message:"Skipped - not authenticated"};e.appendLine("  \u23F3 Testing connection...");let o=Date.now();await r.testConnection();let n=Date.now()-o;return e.appendLine(`  \u2713 Connection successful (${n}ms)`),{category:"Network Connectivity",status:"success",message:`Connected successfully in ${n}ms`}}catch(t){return e.appendLine(`  \u2717 Connection failed: ${t instanceof Error?t.message:String(t)}`),{category:"Network Connectivity",status:"error",message:"Unable to connect to L0 Memory services",details:t instanceof Error?t.message:String(t),action:"Check internet connection"}}}async function Pe(r,e){e.appendLine(`
[6/6] Checking Storage...`);try{if(await r.globalState.update("lzero.diagnosticTest",Date.now()),!r.globalState.get("lzero.diagnosticTest"))return e.appendLine("  \u2717 Global state write/read failed"),{category:"Storage",status:"error",message:"Storage system is not working properly",action:"Reload VS Code"};e.appendLine("  \u2713 Global state is accessible");let o=r.globalState.keys();e.appendLine(`  \u2713 Stored keys: ${o.length}`);let n=r.globalState.get("lzero.firstTime");return e.appendLine(`  \u2713 First time flag: ${n}`),{category:"Storage",status:"success",message:"Storage system is working properly"}}catch(t){return e.appendLine(`  \u2717 Error: ${t instanceof Error?t.message:String(t)}`),{category:"Storage",status:"error",message:"Storage system check failed",details:t instanceof Error?t.message:String(t)}}}function Se(r){let e=r.some(o=>o.status==="error"),t=r.some(o=>o.status==="warning");return e?"critical":t?"degraded":"healthy"}function G(r){let e={healthy:"\u2705",degraded:"\u26A0\uFE0F",critical:"\u274C"},t={success:"\u2705",warning:"\u26A0\uFE0F",error:"\u274C",info:"\u2139\uFE0F"},o=`# L0 Memory Extension Diagnostics

`;o+=`**Overall Health:** ${e[r.overall]} ${r.overall.toUpperCase()}
`,o+=`**Timestamp:** ${r.timestamp.toLocaleString()}

`,o+=`---

`;for(let n of r.results)o+=`## ${t[n.status]} ${n.category}

`,o+=`**Status:** ${n.status.toUpperCase()}

`,o+=`**Message:** ${n.message}

`,n.details&&(o+=`**Details:** ${n.details}

`),n.action&&(o+=`**Recommended Action:** ${n.action}

`),o+=`---

`;return o}var D=process.env.SUPABASE_URL||"https://mxtsdgkwzjzlttpotole.supabase.co",Ce=()=>s.workspace.getConfiguration("lzero").get("apiUrl")||D,W=()=>{let e=s.workspace.getConfiguration("lzero").get("apiUrl")||D;return e.includes("supabase.co")?e.replace(/\/functions\/v1\/?$/,""):e.includes("/functions/v1")?e.replace(/\/functions\/v1\/?$/,""):D},Te=()=>s.workspace.getConfiguration("lzero").get("dashboardUrl")||"https://lanonasis.com/dashboard",be=()=>(s.workspace.getConfiguration("lzero").get("apiUrl")||D).replace(/\/api\/v1\/?$/,"").replace(/\/functions\/v1\/?$/,""),Ee=["lano_","lns_"];function Ie(r){return Ee.some(e=>r.startsWith(e))}function Ke(r){let e=r.split(".");if(e.length<2)return null;let t=e[1].replace(/-/g,"+").replace(/_/g,"/"),o=t+"=".repeat((4-t.length%4)%4);try{let n="";if(typeof Buffer<"u")n=Buffer.from(o,"base64").toString("utf8");else if(typeof atob=="function"){let i=atob(o);if(typeof TextDecoder<"u"){let a=Uint8Array.from(i,l=>l.charCodeAt(0));n=new TextDecoder().decode(a)}else n=i}else return null;return JSON.parse(n)}catch{return null}}function X(r){if(!r||!r.includes("."))return null;let e=Ke(r);if(!e)return null;let t=typeof e.email=="string"?e.email:typeof e.user_email=="string"?e.user_email:typeof e.upn=="string"?e.upn:void 0,o=typeof e.given_name=="string"?e.given_name:void 0,n=typeof e.family_name=="string"?e.family_name:void 0,i=[o,n].filter(Boolean).join(" "),a=typeof e.name=="string"?e.name:typeof e.preferred_username=="string"?e.preferred_username:typeof e.nickname=="string"?e.nickname:i||void 0,l=typeof e.sub=="string"?e.sub:void 0;return!t&&!a&&!l?null:{id:l,name:a,email:t}}var Y=null,N=class{constructor(e,t,o,n,i){this.context=e;this.output=t;this.secureApiKeyService=o;this.apiKeyService=n;this.cache=i}static{this.viewType="lzero.memorySidebar"}resolveWebviewView(e,t,o){this.view=e;let n=e.webview;n.options={enableScripts:!0,localResourceRoots:[s.Uri.joinPath(this.context.extensionUri,"media")]},this.output.appendLine("[LanOnasis] Initializing sidebar webview"),n.html=this.getWebviewHtml(n),n.onDidReceiveMessage(i=>{if(!(!i||typeof i!="object")){if(i.type==="lanonasis:webview-ready"){this.output.appendLine("[LanOnasis] Webview ready"),n.postMessage({type:"lanonasis:host-ready"});let a=this.cache.getMemories(),l=this.cache.getStatus();n.postMessage({type:"lanonasis:cache:data",payload:{memories:a,status:l}}),this.sendConfigToWebview(n);return}if(i.type==="lanonasis:request-auth"){this.handleOAuthLogin(n);return}if(i.type==="lanonasis:submit-api-key"){let a=i.payload?.apiKey;a&&this.handleApiKeySubmit(n,a);return}if(i.type==="lanonasis:logout"){this.handleLogout(n);return}if(i.type==="lanonasis:open-settings"){s.commands.executeCommand("workbench.action.openSettings","lzero");return}if(i.type==="lanonasis:open-dashboard"){let a=i.payload?.section,l=Te(),d=a?`${l}#${a}`:l;s.env.openExternal(s.Uri.parse(d));return}if(i.type==="lanonasis:clipboard:read"){s.env.clipboard.readText().then(a=>{n.postMessage({type:"lanonasis:clipboard:read:result",payload:{text:a}})});return}if(i.type==="lanonasis:clipboard:write"){let a=i.payload?.text;typeof a=="string"&&s.env.clipboard.writeText(a);return}if(i.type==="lanonasis:cache:get"){let a=this.cache.getMemories(),l=this.cache.getStatus();n.postMessage({type:"lanonasis:cache:data",payload:{memories:a,status:l}});return}if(i.type==="lanonasis:cache:search"){let a=i.payload?.query;if(a){let l=this.cache.semanticSearchLocal(a);n.postMessage({type:"lanonasis:cache:search:result",payload:{results:l,query:a}})}return}if(i.type==="lanonasis:cache:add"){let a=i.payload?.memory;a&&this.cache.addLocal(a).then(l=>{n.postMessage({type:"lanonasis:cache:added",payload:{memory:l}})});return}if(i.type==="lanonasis:cache:update"){let a=i.payload?.id,l=i.payload?.updates;a&&l&&this.cache.queueUpdate(a,l).then(()=>{let d=this.cache.getMemoryById(a);n.postMessage({type:"lanonasis:cache:updated",payload:{memory:d,status:this.cache.getStatus()}})});return}if(i.type==="lanonasis:cache:delete"){let a=i.payload?.id;a&&this.cache.queueDelete(a).then(()=>{n.postMessage({type:"lanonasis:cache:deleted",payload:{id:a,status:this.cache.getStatus()}})});return}if(i.type==="lanonasis:cache:clear"){this.cache.clearAll().then(()=>{n.postMessage({type:"lanonasis:cache:cleared",payload:{status:this.cache.getStatus()}})});return}if(i.type==="lanonasis:cache:sync"){this.syncMemories(n);return}if(i.type==="lanonasis:ai:search"){let a=i.payload?.query;a&&this.handleAISearch(n,a);return}}})}async syncMemories(e){this.cache.setSyncing(!0),e.postMessage({type:"lanonasis:sync:start"});try{let t=await this.getEdgeAuthHeaders();if(!t){e.postMessage({type:"lanonasis:sync:error",payload:{error:"Not authenticated"}});return}let o=W(),n=this.cache.getPendingQueue(),i={success:0,failed:0};for(let p of n)try{if(p._pending==="create"){let g=new AbortController,A=setTimeout(()=>g.abort(),3e4);try{let f=await fetch(`${o}/functions/v1/memory-create`,{method:"POST",headers:t,signal:g.signal,body:JSON.stringify({title:p.title,content:p.content,memory_type:p.memory_type,tags:p.tags})});if(f.ok){let h=await f.json(),k=h.data||h.memory||h;await this.cache.markSynced(p._localId||p.id,k),i.success++,this.output.appendLine(`[LanOnasis] Synced new memory: ${p.title}`)}else i.failed++,this.output.appendLine(`[LanOnasis] Failed to sync memory: ${p.title} (${f.status})`)}finally{clearTimeout(A)}}else if(p._pending==="update"){let g=new AbortController,A=setTimeout(()=>g.abort(),3e4);try{let f=await fetch(`${o}/functions/v1/memory-update`,{method:"POST",headers:t,signal:g.signal,body:JSON.stringify({id:p.id,title:p.title,content:p.content,memory_type:p.memory_type,tags:p.tags})});if(f.ok){let h=await f.json(),k=h.data||h.memory||h;await this.cache.markSynced(p.id,k),i.success++}else i.failed++}finally{clearTimeout(A)}}else if(p._pending==="delete"){let g=new AbortController,A=setTimeout(()=>g.abort(),3e4);try{(await fetch(`${o}/functions/v1/memory-delete`,{method:"POST",headers:t,signal:g.signal,body:JSON.stringify({id:p.id})})).ok?(await this.cache.removePending(p.id),i.success++):i.failed++}finally{clearTimeout(A)}}}catch(g){i.failed++,this.output.appendLine(`[LanOnasis] Error syncing pending item: ${g}`)}n.length>0&&this.output.appendLine(`[LanOnasis] Sync results: ${i.success} succeeded, ${i.failed} failed`);let a=await fetch(`${o}/functions/v1/memory-list?limit=100`,{headers:t});if(!a.ok)throw new Error(`API error: ${a.status}`);let l=await a.json(),d=l.data?.memories||l.memories||l.data||l||[];await this.cache.updateFromApi(d),this.cache.setOnline(!0),e.postMessage({type:"lanonasis:sync:complete",payload:{memories:d,status:this.cache.getStatus(),syncResults:i}})}catch(t){let o=String(t),n=o.includes("fetch")||o.includes("network")||o.includes("ECONNREFUSED")||o.includes("ETIMEDOUT");n&&this.cache.setOnline(!1),this.output.appendLine(`[LanOnasis] Sync error: ${t}`),e.postMessage({type:"lanonasis:sync:error",payload:{error:o,isNetworkError:n}})}finally{this.cache.setSyncing(!1)}}async handleAISearch(e,t){try{let o=this.cache.semanticSearchLocal(t);e.postMessage({type:"lanonasis:ai:search:local",payload:{results:o,query:t}});let n=await this.getStoredApiKey(),i=await this.getEdgeAuthHeaders();if(i){let a=W(),l=await fetch(`${a}/functions/v1/memory-search`,{method:"POST",headers:i,body:JSON.stringify({query:t,limit:10,threshold:.7})});if(l.ok){let d=await l.json(),p=d.data?.results||d.results||d.data||[];e.postMessage({type:"lanonasis:ai:search:api",payload:{results:p,query:t}})}}}catch(o){this.output.appendLine(`[LanOnasis] AI search error: ${o}`)}}async getStoredApiKey(){try{return(await this.secureApiKeyService.getStoredCredentials())?.token}catch(e){this.output.appendLine(`[LanOnasis] Failed to get credentials: ${e}`);return}}async getEdgeAuthHeaders(){try{let e=await this.secureApiKeyService.getStoredCredentials();return e?e.type==="oauth"?{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"}:{"X-API-Key":e.token,"Content-Type":"application/json"}:null}catch(e){return this.output.appendLine(`[LanOnasis] Failed to build auth headers: ${e}`),null}}async sendConfigToWebview(e){let t=s.workspace.getConfiguration("lzero"),o=s.workspace.getConfiguration("lanonasis"),n=be(),i,a=null;try{let l=await this.secureApiKeyService.getStoredCredentials();if(l?.token){if(i=l.token,a=X(l.token),!a)try{let d=await this.apiKeyService.getUserInfo();d&&(a={id:d.id,name:d.name,email:d.email})}catch(d){this.output.appendLine("[LanOnasis] Failed to load user profile: "+String(d))}this.output.appendLine("[LanOnasis] Found stored credentials")}}catch(l){this.output.appendLine("[LanOnasis] Token error: "+String(l))}e.postMessage({type:"lanonasis:config:init",payload:{apiUrl:n,apiKey:i,user:a}})}async handleOAuthLogin(e){try{let t=await this.secureApiKeyService.authenticateWithOAuthFlow();if(!t)throw new Error("No tokens received");let o=X(t);if(!o)try{let n=await this.apiKeyService.getUserInfo();n&&(o={id:n.id,name:n.name,email:n.email})}catch(n){this.output.appendLine("[LanOnasis] Failed to load user profile: "+String(n))}e.postMessage({type:"lanonasis:auth:result",payload:{success:!0}}),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:t,user:o}}),await s.window.showInformationMessage("LanOnasis: Connected via OAuth!")}catch(t){let o=t instanceof Error?t.message:String(t);this.output.appendLine("[LanOnasis] OAuth error: "+o),e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:o}})}}async handleApiKeySubmit(e,t){try{if(!t||!Ie(t)){e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:"Invalid API key format"}});return}await this.secureApiKeyService.storeApiKeyDirect(t);let o=null;try{let n=await this.apiKeyService.getUserInfo();n&&(o={id:n.id,name:n.name,email:n.email})}catch(n){this.output.appendLine("[LanOnasis] Failed to load user profile: "+String(n))}e.postMessage({type:"lanonasis:auth:result",payload:{success:!0}}),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:t,user:o}}),await s.window.showInformationMessage("LanOnasis: Connected!")}catch(o){let n=o instanceof Error?o.message:String(o);e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:n}})}}async handleLogout(e){try{await this.secureApiKeyService.deleteApiKey(),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:null,user:null}}),await s.window.showInformationMessage("LanOnasis: Logged out")}catch(t){this.output.appendLine("[LanOnasis] Logout error: "+String(t))}}postMessage(e){this.view&&this.view.webview.postMessage(e)}getWebviewHtml(e){let t=Me(),o=e.asWebviewUri(s.Uri.joinPath(this.context.extensionUri,"media","sidebar-react.js")),n=e.asWebviewUri(s.Uri.joinPath(this.context.extensionUri,"media","lzero-memory.css"));return'<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta http-equiv="Content-Security-Policy" content="'+["default-src 'none'","img-src "+e.cspSource+" https: data:","style-src "+e.cspSource+" 'unsafe-inline'","font-src "+e.cspSource+" https: data:","script-src 'nonce-"+t+"' 'wasm-unsafe-eval'","connect-src https: wss: http://localhost:*"].join("; ")+'"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="stylesheet" href="'+n+'"/><title>LanOnasis Memory</title><style>body{background:var(--vscode-sideBar-background,#252526);color:var(--vscode-sideBar-foreground,#ccc);font-family:var(--vscode-font-family,sans-serif);margin:0;padding:0}#loading{padding:20px;text-align:center}#error{padding:20px;color:#f48771;display:none;white-space:pre-wrap;font-size:12px}</style></head><body><div id="loading">Loading L0 Memory...</div><div id="error"></div><div id="root"></div><script nonce="'+t+'">var errors=[];window.onerror=function(m,u,l){errors.push(m+" at "+u+":"+l);document.getElementById("error").style.display="block";document.getElementById("error").textContent="JS Error:\\n"+errors.join("\\n");document.getElementById("loading").style.display="none";return false};window.addEventListener("unhandledrejection",function(e){errors.push("Promise: "+(e.reason?.message||e.reason||"Unknown"));document.getElementById("error").style.display="block";document.getElementById("error").textContent="Promise Error:\\n"+errors.join("\\n");document.getElementById("loading").style.display="none"});<\/script><script nonce="'+t+'" type="module" src="'+o+`" onerror="document.getElementById('error').textContent='Failed to load script';document.getElementById('error').style.display='block';document.getElementById('loading').style.display='none';"><\/script><script nonce="`+t+'">var observer=new MutationObserver(function(){if(document.getElementById("root").children.length>0){document.getElementById("loading").style.display="none";observer.disconnect()}});observer.observe(document.getElementById("root"),{childList:true});setTimeout(function(){if(document.getElementById("root").children.length===0){document.getElementById("error").textContent="React failed to mount";document.getElementById("error").style.display="block";document.getElementById("loading").style.display="none"}},5000);<\/script></body></html>'}};function Me(){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(let t=0;t<32;t++)e+=r.charAt(Math.floor(Math.random()*r.length));return e}function Z(r,e){let t=r.extension?.packageJSON?.contributes?.views;return!t||typeof t!="object"?!1:Object.values(t).some(o=>Array.isArray(o)&&o.some(n=>n?.id===e))}async function _e(r){let e=s.window.createOutputChannel("LanOnasis Memory");e.appendLine("[LanOnasis] Extension activating...");let t=new _(r,e);try{await t.initialize(),e.appendLine("[LanOnasis] SecureApiKeyService initialized successfully")}catch(c){e.appendLine(`[LanOnasis] SecureApiKeyService initialization warning: ${c}`)}let o=new x(t,e,W()),n=new $(t,e),i=s.workspace.getConfiguration("lzero").get("retainContextWhenHidden",!1),a=new K(r,e);Y=a;let l=new N(r,e,t,n,a),d=new R(o),p=new U(n,e),g=Z(r,"lzeroMemories"),A=Z(r,"lzeroApiKeys");g?r.subscriptions.push(s.window.registerTreeDataProvider("lzeroMemories",d)):e.appendLine("[LanOnasis] View id lzeroMemories is not registered. Skipping tree provider."),A?r.subscriptions.push(s.window.registerTreeDataProvider("lzeroApiKeys",p)):e.appendLine("[LanOnasis] View id lzeroApiKeys is not registered. Skipping tree provider."),s.commands.executeCommand("setContext","lzero.enableApiKeyManagement",s.workspace.getConfiguration("lzero").get("enableApiKeyManagement",!0)),s.commands.executeCommand("setContext","lzero.authenticated",!1);let f=async c=>{await s.commands.executeCommand("setContext","lzero.authenticated",c),await d.setAuthenticated(c),p.setAuthenticated(c)},h=async()=>{try{return(await t.getStoredCredentials())?.token}catch(c){e.appendLine(`[LanOnasis] Chat: Failed to get credentials: ${c}`);return}};new M(r,e,a,Ce(),h).register(),r.subscriptions.push(s.window.registerWebviewViewProvider(N.viewType,l,{webviewOptions:{retainContextWhenHidden:i}})),r.subscriptions.push(s.commands.registerCommand("lzeroMemory.authenticate",async c=>{try{let u=null;c==="oauth"?u=await t.authenticateWithOAuthFlow():c==="apikey"?u=await t.promptForApiKeyEntry():u=await t.promptForAuthentication(),u&&(await f(!0),await s.window.showInformationMessage("L0 Memory: Authenticated!"))}catch(u){let w=u instanceof Error?u.message:String(u);await s.window.showErrorMessage("L0 Memory: Auth failed - "+w)}})),r.subscriptions.push(s.commands.registerCommand("lzeroMemory.createMemoryFromSelection",async()=>{let c=s.window.activeTextEditor;if(!c){await s.window.showInformationMessage("No active editor");return}let u=c.document.getText(c.selection);if(!u){await s.window.showInformationMessage("No text selected");return}l.postMessage({type:"lanonasis:inject-chat",payload:{text:u}}),await s.commands.executeCommand("lzero.memorySidebar.focus")})),r.subscriptions.push(s.commands.registerCommand("lzeroMemory.syncMemories",async()=>{l.postMessage({type:"lanonasis:cache:sync"}),await s.window.showInformationMessage("LanOnasis: Syncing memories...")})),r.subscriptions.push(s.commands.registerCommand("lzeroMemory.searchMemories",async()=>{let c=await s.window.showInputBox({prompt:"Search your memories",placeHolder:"e.g., OAuth implementation, regex pattern..."});if(c){let u=a.semanticSearchLocal(c);if(u.length===0){await s.window.showInformationMessage(`No memories found for "${c}"`);return}let w=u.map(S=>({label:S.title,description:S.memory_type,detail:S.content.slice(0,100)+(S.content.length>100?"...":""),memory:S})),P=await s.window.showQuickPick(w,{placeHolder:`Found ${u.length} memories`,matchOnDescription:!0,matchOnDetail:!0});P&&(await s.env.clipboard.writeText(P.memory.content),await s.window.showInformationMessage(`Copied "${P.label}" to clipboard`))}})),r.subscriptions.push(s.commands.registerCommand("lzeroMemory.openMemory",c=>{De(c)})),r.subscriptions.push(s.commands.registerCommand("lzeroMemory.manageApiKeys",async()=>{await $e(n)}),s.commands.registerCommand("lzeroMemory.createProject",async()=>{await B(n,p)}),s.commands.registerCommand("lzeroMemory.viewProjects",async()=>{await te(n)}),s.commands.registerCommand("lzeroMemory.refreshApiKeys",async()=>{p.refresh(!0)}),s.commands.registerCommand("lzeroMemory.viewProjectDetails",async c=>{c&&c.project&&await ne(c.project,n)}),s.commands.registerCommand("lzeroMemory.viewApiKeyDetails",async c=>{c&&c.apiKey&&await oe(c.apiKey)}),s.commands.registerCommand("lzeroMemory.createApiKey",async c=>{c&&c.project?await Re(c.project,n,p):await ee(n,p)}),s.commands.registerCommand("lzeroMemory.rotateApiKey",async c=>{c&&c.apiKey&&await Oe(c.apiKey,n,p)}),s.commands.registerCommand("lzeroMemory.deleteApiKey",async c=>{c&&c.apiKey&&await Ue(c.apiKey,n,p)}),s.commands.registerCommand("lzeroMemory.deleteProject",async c=>{c&&c.project&&await je(c.project,n,p)})),r.subscriptions.push(s.commands.registerCommand("lzeroMemory.checkApiKeyStatus",async()=>{try{let c=await t.hasApiKey(),u=c?"\u2705 Configured and stored securely":"\u274C Not configured";c?s.window.showInformationMessage(`API Key Status: ${u}`,"Test Connection","View Security Info").then(async w=>{w==="Test Connection"?s.commands.executeCommand("lzeroMemory.testConnection"):w==="View Security Info"&&s.env.openExternal(s.Uri.parse("https://docs.lanonasis.com/security/api-keys"))}):s.window.showInformationMessage(`API Key Status: ${u}`,"Connect in Browser","Enter API Key").then(w=>{w==="Connect in Browser"?s.commands.executeCommand("lzeroMemory.authenticate","oauth"):w==="Enter API Key"&&s.commands.executeCommand("lzeroMemory.authenticate","apikey")})}catch(c){let u=c instanceof Error?c.message:String(c);s.window.showErrorMessage(`Failed to check API key status: ${u}`)}}),s.commands.registerCommand("lzeroMemory.clearApiKey",async()=>{try{if(!await t.hasApiKey()){s.window.showInformationMessage("No API key is currently configured.");return}await s.window.showWarningMessage("Are you sure you want to clear your API key? This will require re-authentication.",{modal:!0},"Clear API Key")==="Clear API Key"&&(await t.deleteApiKey(),await f(!1),s.window.showInformationMessage("API key cleared successfully."))}catch(c){let u=c instanceof Error?c.message:String(c);s.window.showErrorMessage(`Failed to clear API key: ${u}`)}}),s.commands.registerCommand("lzeroMemory.testConnection",async()=>{try{if(!await t.hasApiKey()){s.window.showWarningMessage("\u274C No API key configured.");return}await o.testConnection(),s.window.showInformationMessage("\u2705 Connection test successful!")}catch(c){let u=c instanceof Error?c.message:String(c);s.window.showErrorMessage(`Connection test failed: ${u}`)}}),s.commands.registerCommand("lzeroMemory.runDiagnostics",async()=>{try{e.show(),e.appendLine(`Running comprehensive diagnostics...
`);let c=await J(r,t,o,e),u=G(c),w=await s.workspace.openTextDocument({content:u,language:"markdown"});await s.window.showTextDocument(w)}catch(c){let u=c instanceof Error?c.message:String(c);s.window.showErrorMessage(`Diagnostics failed: ${u}`),e.appendLine(`[Diagnostics] Fatal error: ${u}`)}}),s.commands.registerCommand("lzeroMemory.showLogs",()=>{e.show()})),r.subscriptions.push({dispose:()=>a.stopConnectivityCheck()});try{let c=await t.hasApiKey();await f(c)}catch(c){e.appendLine(`[LanOnasis] Failed to check auth state: ${c instanceof Error?c.message:String(c)}`)}e.appendLine("[LanOnasis] Extension activated")}function xe(){Y?.stopConnectivityCheck(),Y=null}async function $e(r){let e=[{label:"$(key) View API Keys",description:"View all API keys across projects",command:"view"},{label:"$(add) Create API Key",description:"Create a new API key",command:"create"},{label:"$(folder) Manage Projects",description:"Create and manage API key projects",command:"projects"},{label:"$(refresh) Refresh",description:"Refresh API key data",command:"refresh"}],t=await s.window.showQuickPick(e,{placeHolder:"Choose an API key management action"});if(t)switch(t.command){case"view":await Le(r);break;case"create":await ee(r);break;case"projects":await te(r);break;case"refresh":s.commands.executeCommand("lzeroMemory.refreshApiKeys");break}}async function Le(r){try{s.window.withProgress({location:s.ProgressLocation.Notification,title:"Loading API keys...",cancellable:!1},async()=>{let e=await r.getApiKeys();if(e.length===0){s.window.showInformationMessage("No API keys found. Create your first API key to get started.");return}let t=e.map(n=>({label:n.name,description:`${n.environment} \u2022 ${n.keyType} \u2022 ${n.accessLevel}`,detail:`Project: ${n.projectId} | Created: ${new Date(n.createdAt).toLocaleDateString()}`,apiKey:n})),o=await s.window.showQuickPick(t,{placeHolder:`Select an API key (${e.length} found)`});o&&await oe(o.apiKey)})}catch(e){s.window.showErrorMessage(`Failed to load API keys: ${e instanceof Error?e.message:"Unknown error"}`)}}async function ee(r,e){try{let t=await r.getProjects();if(t.length===0){await s.window.showInformationMessage("No projects found. You need to create a project first.","Create Project","Cancel")==="Create Project"&&await B(r,void 0);return}let o=t.map(h=>({label:h.name,description:h.description||"No description",project:h})),n=await s.window.showQuickPick(o,{placeHolder:"Select a project for the API key"});if(!n)return;let i=await s.window.showInputBox({prompt:"API Key Name",placeHolder:"Enter a name for your API key"});if(!i)return;let a=await s.window.showInputBox({prompt:"API Key Value",placeHolder:"Enter the API key value",password:!0});if(!a)return;let l=[{label:"API Key",value:"api_key"},{label:"Database URL",value:"database_url"},{label:"OAuth Token",value:"oauth_token"},{label:"Certificate",value:"certificate"},{label:"SSH Key",value:"ssh_key"},{label:"Webhook Secret",value:"webhook_secret"},{label:"Encryption Key",value:"encryption_key"}],d=await s.window.showQuickPick(l,{placeHolder:"Select key type"});if(!d)return;let g=s.workspace.getConfiguration("lzero").get("defaultEnvironment","development"),A=[{label:"Development",value:"development",picked:g==="development"},{label:"Staging",value:"staging",picked:g==="staging"},{label:"Production",value:"production",picked:g==="production"}],f=await s.window.showQuickPick(A,{placeHolder:"Select environment"});if(!f)return;await s.window.withProgress({location:s.ProgressLocation.Notification,title:"Creating API key...",cancellable:!1},async()=>{await r.createApiKey({name:i,value:a,keyType:d.value,environment:f.value,accessLevel:"team",projectId:n.project.id})}),s.window.showInformationMessage(`API key "${i}" created successfully`),s.commands.executeCommand("lzeroMemory.refreshApiKeys")}catch(t){s.window.showErrorMessage(`Failed to create API key: ${t instanceof Error?t.message:"Unknown error"}`)}}async function B(r,e){try{let t=await s.window.showInputBox({prompt:"Project Name",placeHolder:"Enter a name for your project"});if(!t)return;let o=await s.window.showInputBox({prompt:"Project Description (optional)",placeHolder:"Enter a description for your project"}),n=s.workspace.getConfiguration("lzero"),i=n.get("organizationId");if(!i){let a=await s.window.showInputBox({prompt:"Organization ID",placeHolder:"Enter your organization ID"});if(!a)return;await n.update("organizationId",a,s.ConfigurationTarget.Global),i=a}await s.window.withProgress({location:s.ProgressLocation.Notification,title:"Creating project...",cancellable:!1},async()=>{let a=await r.createProject({name:t,description:o,organizationId:i});e&&await e.addProject(a)}),s.window.showInformationMessage(`Project "${t}" created successfully`),s.commands.executeCommand("lzeroMemory.refreshApiKeys")}catch(t){s.window.showErrorMessage(`Failed to create project: ${t instanceof Error?t.message:"Unknown error"}`)}}async function te(r){try{s.window.withProgress({location:s.ProgressLocation.Notification,title:"Loading projects...",cancellable:!1},async()=>{let e=await r.getProjects();if(e.length===0){await s.window.showInformationMessage("No projects found. Create your first project to get started.","Create Project","Cancel")==="Create Project"&&await B(r,void 0);return}let t=e.map(n=>({label:n.name,description:n.description||"No description",detail:`Organization: ${n.organizationId} | Created: ${new Date(n.createdAt).toLocaleDateString()}`,project:n})),o=await s.window.showQuickPick(t,{placeHolder:`Select a project (${e.length} found)`});o&&await ne(o.project,r)})}catch(e){s.window.showErrorMessage(`Failed to load projects: ${e instanceof Error?e.message:"Unknown error"}`)}}async function oe(r){let e=`# API Key: ${r.name}

**Type:** ${r.keyType}
**Environment:** ${r.environment}
**Access Level:** ${r.accessLevel}
**Project ID:** ${r.projectId}
**Created:** ${new Date(r.createdAt).toLocaleString()}
${r.expiresAt?`**Expires:** ${new Date(r.expiresAt).toLocaleString()}`:"**Expires:** Never"}

## Tags
${r.tags.length>0?r.tags.map(t=>`- ${t}`).join(`
`):"No tags"}

## Metadata

\`\`\`json
${JSON.stringify(r.metadata,null,2)}
\`\`\`
`;s.workspace.openTextDocument({content:e,language:"markdown"}).then(t=>{s.window.showTextDocument(t)})}async function ne(r,e){try{let t=await e.getApiKeys(r.id),o=`# Project: ${r.name}

**Description:** ${r.description||"No description"}
**Organization ID:** ${r.organizationId}
**Created:** ${new Date(r.createdAt).toLocaleString()}
**Team Members:** ${r.teamMembers.length}

## API Keys (${t.length})
${t.length>0?t.map(n=>`- **${n.name}** (${n.keyType}, ${n.environment})`).join(`
`):"No API keys found in this project"}

## Settings

\`\`\`json
${JSON.stringify(r.settings,null,2)}
\`\`\`
`;s.workspace.openTextDocument({content:o,language:"markdown"}).then(n=>{s.window.showTextDocument(n)})}catch(t){s.window.showErrorMessage(`Failed to load project details: ${t instanceof Error?t.message:"Unknown error"}`)}}async function Re(r,e,t){try{let o=await s.window.showInputBox({prompt:"API Key Name",placeHolder:"Enter a name for your API key"});if(!o)return;let n=await s.window.showInputBox({prompt:"API Key Value",placeHolder:"Enter the API key value",password:!0});if(!n)return;let i=[{label:"API Key",value:"api_key"},{label:"Database URL",value:"database_url"},{label:"OAuth Token",value:"oauth_token"},{label:"Certificate",value:"certificate"},{label:"SSH Key",value:"ssh_key"},{label:"Webhook Secret",value:"webhook_secret"},{label:"Encryption Key",value:"encryption_key"}],a=await s.window.showQuickPick(i,{placeHolder:"Select key type"});if(!a)return;let l=[{label:"Development",description:"For development use"},{label:"Staging",description:"For staging/testing"},{label:"Production",description:"For production use"}],d=await s.window.showQuickPick(l,{placeHolder:"Select environment"});if(!d)return;let p=[{label:"Public",description:"Publicly accessible"},{label:"Authenticated",description:"Requires authentication"},{label:"Team",description:"Team members only"},{label:"Admin",description:"Administrators only"},{label:"Enterprise",description:"Enterprise level access"}],g=await s.window.showQuickPick(p,{placeHolder:"Select access level"});if(!g)return;let A={name:o,value:n,keyType:a.value,environment:d.label.toLowerCase(),accessLevel:g.label.toLowerCase(),projectId:r.id};await s.window.withProgress({location:s.ProgressLocation.Notification,title:"Creating API key...",cancellable:!1},async()=>{let f=await e.createApiKey(A);s.window.showInformationMessage(`API key "${f.name}" created successfully!`),t&&await t.addApiKey(r.id,f)})}catch(o){s.window.showErrorMessage(`Failed to create API key: ${o instanceof Error?o.message:"Unknown error"}`)}}async function Oe(r,e,t){try{if(await s.window.showWarningMessage(`Are you sure you want to rotate API key "${r.name}"? The old key will be invalidated.`,{modal:!0},"Rotate Key")!=="Rotate Key")return;await s.window.withProgress({location:s.ProgressLocation.Notification,title:"Rotating API key...",cancellable:!1},async()=>{let n=await e.rotateApiKey(r.id);s.window.showInformationMessage(`API key "${n.name}" rotated successfully!`),t&&await t.updateApiKey(r.projectId,n)})}catch(o){s.window.showErrorMessage(`Failed to rotate API key: ${o instanceof Error?o.message:"Unknown error"}`)}}async function Ue(r,e,t){try{if(await s.window.showWarningMessage(`Are you sure you want to delete API key "${r.name}"? This action cannot be undone.`,{modal:!0},"Delete")!=="Delete")return;await s.window.withProgress({location:s.ProgressLocation.Notification,title:"Deleting API key...",cancellable:!1},async()=>{await e.deleteApiKey(r.id),s.window.showInformationMessage(`API key "${r.name}" deleted successfully.`),t&&await t.removeApiKey(r.projectId,r.id)})}catch(o){s.window.showErrorMessage(`Failed to delete API key: ${o instanceof Error?o.message:"Unknown error"}`)}}async function je(r,e,t){try{if(await s.window.showWarningMessage(`Are you sure you want to delete project "${r.name}"? All API keys in this project will also be deleted. This action cannot be undone.`,{modal:!0},"Delete")!=="Delete")return;await s.window.withProgress({location:s.ProgressLocation.Notification,title:"Deleting project...",cancellable:!1},async()=>{await e.deleteProject(r.id),s.window.showInformationMessage(`Project "${r.name}" deleted successfully.`),t&&await t.removeProject(r.id)})}catch(o){s.window.showErrorMessage(`Failed to delete project: ${o instanceof Error?o.message:"Unknown error"}`)}}function De(r){let e=`# ${r.title}

**Type:** ${r.memory_type}
**Created:** ${new Date(r.created_at).toLocaleString()}

---

${r.content}`;s.workspace.openTextDocument({content:e,language:"markdown"}).then(t=>{s.window.showTextDocument(t)})}
