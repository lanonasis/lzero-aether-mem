"use strict";var $=Object.create;var C=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var j=(a,e)=>{for(var t in e)C(a,t,{get:e[t],enumerable:!0})},T=(a,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of K(e))!D.call(a,s)&&s!==t&&C(a,s,{get:()=>e[s],enumerable:!(n=N(e,s))||n.enumerable});return a};var I=(a,e,t)=>(t=a!=null?$(B(a)):{},T(e||!a||!a.__esModule?C(t,"default",{value:a,enumerable:!0}):t,a)),F=a=>T(C({},"__esModule",{value:!0}),a);var te={};j(te,{activate:()=>Z,deactivate:()=>ee});module.exports=F(te);var c=I(require("vscode"));var E=typeof globalThis<"u"&&typeof globalThis.crypto<"u"&&typeof globalThis.crypto.getRandomValues=="function";function Q(a){let e=new Uint8Array(a);if(E)globalThis.crypto.getRandomValues(e);else for(let t=0;t<a;t++)e[t]=Math.floor(Math.random()*256);return e}function L(a=32){let e=Q(Math.ceil(a*.75));return O(e).slice(0,a)}async function x(a){let t=new TextEncoder().encode(a);if(E&&globalThis.crypto.subtle){let o=await globalThis.crypto.subtle.digest("SHA-256",t);return O(new Uint8Array(o))}let n=0,s=a;for(let o=0;o<s.length;o++){let r=s.charCodeAt(o);n=(n<<5)-n+r,n=n&n}let i=new Uint8Array(32);for(let o=0;o<32;o++)i[o]=n>>o%4*8&255,n=n*31+o&4294967295;return O(i)}function O(a){let e="";for(let n=0;n<a.length;n++)e+=String.fromCharCode(a[n]);let t;return typeof btoa=="function"?t=btoa(e):t=Buffer.from(a).toString("base64"),t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}var W="https://lanonasis.supabase.co",H=`${W}/functions/v1/system-health`,v={MEMORIES:"lanonasis.memories.cache",PENDING_QUEUE:"lanonasis.memories.pending",LAST_SYNC:"lanonasis.memories.lastSync"},S=class{constructor(e,t){this.context=e;this.output=t;this.memories=[];this.pendingQueue=[];this.lastSyncAt=null;this.isSyncing=!1;this.isOnline=!0;this.connectivityCheckInterval=null;this.loadFromStorage(),this.setupNetworkListener()}loadFromStorage(){try{let e=this.context.globalState.get(v.MEMORIES,[]),t=this.context.globalState.get(v.PENDING_QUEUE,[]),n=this.context.globalState.get(v.LAST_SYNC,null);this.memories=e,this.pendingQueue=t,this.lastSyncAt=n,this.output.appendLine(`[MemoryCache] Loaded ${this.memories.length} cached memories, ${this.pendingQueue.length} pending`)}catch(e){this.output.appendLine(`[MemoryCache] Load error: ${e}`)}}async saveToStorage(){try{await this.context.globalState.update(v.MEMORIES,this.memories),await this.context.globalState.update(v.PENDING_QUEUE,this.pendingQueue),await this.context.globalState.update(v.LAST_SYNC,this.lastSyncAt)}catch(e){this.output.appendLine(`[MemoryCache] Save error: ${e}`)}}setupNetworkListener(){this.isOnline=!0,this.startConnectivityCheck()}startConnectivityCheck(){this.connectivityCheckInterval||(this.connectivityCheckInterval=setInterval(async()=>{try{let e=new AbortController,t=setTimeout(()=>e.abort(),5e3),n=await fetch(H,{method:"GET",signal:e.signal});clearTimeout(t);let s=!this.isOnline;this.isOnline=n.ok,s&&this.isOnline&&this.output.appendLine("[MemoryCache] Network restored - online")}catch{this.isOnline&&this.output.appendLine("[MemoryCache] Network check failed - marking offline"),this.isOnline=!1}},3e4))}stopConnectivityCheck(){this.connectivityCheckInterval&&(clearInterval(this.connectivityCheckInterval),this.connectivityCheckInterval=null)}getStatus(){return{isOnline:this.isOnline,lastSyncAt:this.lastSyncAt,pendingCount:this.pendingQueue.length,isSyncing:this.isSyncing}}getMemories(){return[...this.memories]}getPendingQueue(){return[...this.pendingQueue]}getMemoryById(e){return this.memories.find(t=>t.id===e||t._localId===e)}async clearAll(){this.memories=[],this.pendingQueue=[],this.lastSyncAt=null,await this.saveToStorage()}async updateFromApi(e){this.memories=e.map(t=>({...t,_cachedAt:Date.now()})),this.lastSyncAt=Date.now(),this.isOnline=!0,await this.saveToStorage(),this.output.appendLine(`[MemoryCache] Updated cache with ${e.length} memories from API`)}async addLocal(e){let t=`local_${Date.now()}_${Math.random().toString(36).slice(2)}`,n=new Date().toISOString(),s={...e,id:t,created_at:n,updated_at:n,_pending:"create",_localId:t,_cachedAt:Date.now()};return this.memories.unshift(s),this.pendingQueue.push(s),await this.saveToStorage(),this.output.appendLine(`[MemoryCache] Added local memory: ${s.title}`),s}async markSynced(e,t){let n=this.memories.findIndex(s=>s.id===e||s._localId===e);n!==-1&&(this.memories[n]={...t,_pending:void 0,_localId:void 0,_cachedAt:Date.now()}),this.pendingQueue=this.pendingQueue.filter(s=>s._localId!==e&&s.id!==e),await this.saveToStorage()}async removePending(e){this.pendingQueue=this.pendingQueue.filter(t=>t.id!==e&&t._localId!==e),this.memories=this.memories.filter(t=>t.id!==e),await this.saveToStorage()}async queueUpdate(e,t){let n=this.memories.findIndex(o=>o.id===e);if(n===-1){this.output.appendLine(`[MemoryCache] queueUpdate: memory not found for id ${e}`);return}let s=this.memories[n]._pending;this.memories[n]={...this.memories[n],...t,updated_at:new Date().toISOString(),_pending:s==="create"?"create":"update",_cachedAt:Date.now()};let i=this.pendingQueue.findIndex(o=>o.id===e);i!==-1?this.pendingQueue[i]=this.memories[n]:this.pendingQueue.push(this.memories[n]),await this.saveToStorage()}async queueDelete(e){let t=this.memories.find(n=>n.id===e);if(t){if(t._localId&&t._pending==="create")this.memories=this.memories.filter(n=>n.id!==e),this.pendingQueue=this.pendingQueue.filter(n=>n.id!==e);else{let n={...t,_pending:"delete"};this.memories=this.memories.filter(i=>i.id!==e);let s=this.pendingQueue.findIndex(i=>i.id===e);s!==-1?this.pendingQueue[s]=n:this.pendingQueue.push(n)}await this.saveToStorage()}}searchLocal(e){let t=e.toLowerCase();return this.memories.filter(n=>n.title.toLowerCase().includes(t)||n.content.toLowerCase().includes(t)||n.tags.some(s=>s.toLowerCase().includes(t)))}semanticSearchLocal(e){let t=e.toLowerCase(),n=[/find\s+(?:my\s+)?(.+)/i,/search\s+(?:for\s+)?(.+)/i,/show\s+(?:me\s+)?(.+)/i,/get\s+(?:my\s+)?(.+)/i,/recall\s+(.+)/i,/what\s+(?:was|were|is|are)\s+(?:my\s+)?(.+)/i,/where\s+(?:is|are|did)\s+(?:my\s+)?(.+)/i],s=t;for(let l of n){let d=t.match(l);if(d){s=d[1]||d[2]||t;break}}let i=["the","a","an","my","that","this","about","notes","note","memory","memories"],o=s.split(/\s+/).filter(l=>l.length>2&&!i.includes(l));return o.length===0?this.memories.slice(0,5):this.memories.map(l=>{let d=0,p=l.title.toLowerCase(),u=l.content.toLowerCase(),y=l.tags.map(h=>h.toLowerCase());for(let h of o)p.includes(h)&&(d+=3),u.includes(h)&&(d+=1),y.some(g=>g.includes(h))&&(d+=2);return{memory:l,score:d}}).filter(l=>l.score>0).sort((l,d)=>d.score-l.score).slice(0,10).map(l=>l.memory)}setOnline(e){this.isOnline=e}setSyncing(e){this.isSyncing=e}};var w=I(require("vscode")),z="lanonasis.memory",b=class{constructor(e,t,n,s,i){this.context=e;this.output=t;this.cache=n;this.apiUrl=s;this.getApiKey=i}register(){if(!w.chat?.createChatParticipant){this.output.appendLine("[ChatParticipant] Chat API not available in this VS Code version");return}try{this.participant=w.chat.createChatParticipant(z,this.handleRequest.bind(this)),this.participant.iconPath=w.Uri.joinPath(this.context.extensionUri,"media","icon.png"),this.participant.followupProvider={provideFollowups:this.provideFollowups.bind(this)},this.context.subscriptions.push(this.participant),this.output.appendLine("[ChatParticipant] Registered @memory chat participant")}catch(e){this.output.appendLine(`[ChatParticipant] Registration failed: ${e}`)}}async handleRequest(e,t,n,s){let i=e.prompt.trim(),o=e.command;if(this.output.appendLine(`[ChatParticipant] Request: "${i}", command: "${o||"none"}"`),o)switch(o){case"save":return this.handleCreate(i||"Untitled memory",n);case"find":let l=await this.parseIntent(i||"");return this.handleSearch({...l,query:i},n,s);case"list":return this.handleList(n);default:break}let r=await this.parseIntent(i);switch(r.action){case"search":return this.handleSearch(r,n,s);case"create":return this.handleCreate(i,n);case"list":return this.handleList(n);default:return this.handleHelp(n)}}async parseIntent(e){let t=e.toLowerCase().trim();if(t==="help"||t==="?"||t.includes("how do i")||t.includes("what can you"))return{memories:[],action:"help"};if(t==="list"||t==="show all"||t==="all memories"||/^(list|show)\s*(all|my)?\s*memories?$/i.test(t))return{memories:this.cache.getMemories().slice(0,10),action:"list"};let n=[/^save\s+(.+)/i,/^create\s+(?:a\s+)?(?:memory|note)\s*:?\s*(.+)/i,/^remember\s+(.+)/i,/^store\s+(.+)/i,/^\/save\s+(.+)/i];for(let i of n){let o=e.match(i);if(o&&o[1])return this.output.appendLine(`[ChatParticipant] Detected create intent: "${o[1]}"`),{memories:[],action:"create",query:e}}let s=this.cache.semanticSearchLocal(e);return s.length===0?{memories:await this.searchApi(e),action:"search",query:e}:{memories:s,action:"search",query:e}}async searchApi(e){try{let t=await this.getApiKey();if(!t)return[];let n=await fetch(`${this.apiUrl}/functions/v1/memory-search`,{method:"POST",headers:{"X-API-Key":t,"Content-Type":"application/json"},body:JSON.stringify({query:e,limit:5,threshold:.7})});if(!n.ok)return[];let s=await n.json();return s.data?.results||s.results||s.data||s||[]}catch(t){return this.output.appendLine(`[ChatParticipant] API search error: ${t}`),[]}}async handleSearch(e,t,n){if(n.isCancellationRequested)return{metadata:{action:"cancelled"}};if(e.memories.length===0)return t.markdown(`No memories found for "${e.query}".

`),t.markdown("\u{1F4A1} *Try creating a new memory with:* `@memory save [your content]`"),{metadata:{action:"search",found:0}};t.markdown(`## \u{1F9E0} Found ${e.memories.length} relevant memories

`);for(let s of e.memories){let i=s._pending?" *(pending sync)*":"";t.markdown(`### ${s.title}${i}
`),t.markdown(`${s.content.slice(0,200)}${s.content.length>200?"...":""}

`),s.tags.length>0&&t.markdown(`\u{1F3F7}\uFE0F ${s.tags.map(o=>`\`${o}\``).join(" ")}

`),t.markdown(`---

`)}return{metadata:{action:"search",found:e.memories.length}}}async handleCreate(e,t){let n=e.replace(/^(save|create|remember|store)\s*(a\s+)?(memory|note)?\s*:?\s*/i,"").trim();if(!n)return t.markdown(`Please provide content to save. Example:

`),t.markdown("`@memory save OAuth uses PKCE flow for mobile apps`"),{metadata:{action:"create",success:!1}};let s=n.slice(0,50)+(n.length>50?"...":""),i=await this.cache.addLocal({title:s,content:n,memory_type:"knowledge",tags:[]});return t.markdown(`## \u2705 Memory saved

`),t.markdown(`**${i.title}**

`),t.markdown(`${i.content}

`),t.markdown("*Memory will sync when online.*"),this.syncToApi(i),{metadata:{action:"create",success:!0,id:i.id}}}async syncToApi(e){try{let t=await this.getApiKey();if(!t)return;let n=await fetch(`${this.apiUrl}/functions/v1/memory-create`,{method:"POST",headers:{"X-API-Key":t,"Content-Type":"application/json"},body:JSON.stringify({title:e.title,content:e.content,memory_type:e.memory_type,tags:e.tags})});if(n.ok){let s=await n.json(),i=s.data||s.memory||s;await this.cache.markSynced(e.id,i),this.output.appendLine(`[ChatParticipant] Memory synced: ${e.title}`)}}catch(t){this.output.appendLine(`[ChatParticipant] Sync error: ${t}`)}}handleList(e){let t=this.cache.getMemories().slice(0,10),n=this.cache.getStatus();if(e.markdown(`## \u{1F9E0} Your Memories

`),n.pendingCount>0&&e.markdown(`\u23F3 *${n.pendingCount} memories pending sync*

`),t.length===0)return e.markdown(`No memories yet. Create one with:

`),e.markdown("`@memory save [your content]`"),{metadata:{action:"list",count:0}};for(let s of t){let i=s._pending?" \u{1F504}":"";e.markdown(`- **${s.title}**${i}
`)}return e.markdown(`
*Showing ${t.length} most recent memories*`),{metadata:{action:"list",count:t.length}}}handleHelp(e){return e.markdown(`## \u{1F9E0} L0 Memory Assistant

`),e.markdown(`I help you store and recall your development context.

`),e.markdown(`### Commands

`),e.markdown(`| Command | Description |
`),e.markdown(`|---------|-------------|
`),e.markdown("| `@memory find [query]` | Search your memories |\n"),e.markdown("| `@memory save [content]` | Save a new memory |\n"),e.markdown("| `@memory list` | Show recent memories |\n"),e.markdown("| `@memory help` | Show this help |\n\n"),e.markdown(`### Examples

`),e.markdown("- `@memory find OAuth implementation`\n"),e.markdown("- `@memory what was that regex pattern?`\n"),e.markdown("- `@memory save Use PKCE flow for mobile OAuth`\n"),{metadata:{action:"help"}}}provideFollowups(e,t,n){switch(e.metadata?.action){case"search":return[{prompt:"list",label:"\u{1F4CB} Show all memories"},{prompt:"save ",label:"\u{1F4BE} Save a new memory"}];case"create":return[{prompt:"list",label:"\u{1F4CB} Show all memories"},{prompt:"find ",label:"\u{1F50D} Search memories"}];case"list":return[{prompt:"find ",label:"\u{1F50D} Search memories"},{prompt:"save ",label:"\u{1F4BE} Save a new memory"}];default:return[{prompt:"find ",label:"\u{1F50D} Search memories"},{prompt:"list",label:"\u{1F4CB} Show all memories"}]}}};var m={API_KEY:"lanonasis.apiKey",OAUTH_TOKENS:"lanonasis.tokens"},R="https://lanonasis.supabase.co",M=()=>c.workspace.getConfiguration("lzero").get("apiUrl")||R,J=()=>c.workspace.getConfiguration("lzero").get("dashboardUrl")||"https://lanonasis.com/dashboard",q=()=>(c.workspace.getConfiguration("lzero").get("apiUrl")||R).replace(/\/api\/v1\/?$/,"").replace(/\/functions\/v1\/?$/,""),Y=["lano_","lns_"];function V(a){return Y.some(e=>a.startsWith(e))}function G(a){let e=a.split(".");if(e.length<2)return null;let t=e[1].replace(/-/g,"+").replace(/_/g,"/"),n=t+"=".repeat((4-t.length%4)%4);try{let s="";if(typeof Buffer<"u")s=Buffer.from(n,"base64").toString("utf8");else if(typeof atob=="function"){let i=atob(n);if(typeof TextDecoder<"u"){let o=Uint8Array.from(i,r=>r.charCodeAt(0));s=new TextDecoder().decode(o)}else s=i}else return null;return JSON.parse(s)}catch{return null}}function U(a){if(!a||!a.includes("."))return null;let e=G(a);if(!e)return null;let t=typeof e.email=="string"?e.email:typeof e.user_email=="string"?e.user_email:typeof e.upn=="string"?e.upn:void 0,n=typeof e.given_name=="string"?e.given_name:void 0,s=typeof e.family_name=="string"?e.family_name:void 0,i=[n,s].filter(Boolean).join(" "),o=typeof e.name=="string"?e.name:typeof e.preferred_username=="string"?e.preferred_username:typeof e.nickname=="string"?e.nickname:i||void 0,r=typeof e.sub=="string"?e.sub:void 0;return!t&&!o&&!r?null:{id:r,name:o,email:t}}var f={clientId:"vscode-extension",authBaseUrl:"https://auth.lanonasis.com",redirectUri:"vscode://lanonasis.lzero-memory/callback",scope:"memories:read memories:write memories:delete profile"},_=null,P=class{constructor(e){this.output=e;this.pendingAuth=null}async generateCodeChallenge(e){return x(e)}buildAuthorizationUrl(e,t){let n=new URLSearchParams({client_id:f.clientId,response_type:"code",redirect_uri:f.redirectUri,scope:f.scope,code_challenge:e,code_challenge_method:"S256",state:t});return f.authBaseUrl+"/oauth/authorize?"+n.toString()}async exchangeCodeForTokens(e,t){let n=await fetch(f.authBaseUrl+"/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({grant_type:"authorization_code",code:e,client_id:f.clientId,redirect_uri:f.redirectUri,code_verifier:t})}),s=await n.json();if(!n.ok)throw new Error(s.error_description||s.error||"Token exchange failed");return s}handleCallback(e){if(!this.pendingAuth){this.output.appendLine("[LanOnasis] Received OAuth callback but no pending auth");return}let t=new URLSearchParams(e.query),n=t.get("code"),s=t.get("state"),i=t.get("error");if(i){let o=t.get("error_description")||i;this.pendingAuth.reject(new Error(o)),this.pendingAuth=null;return}if(s!==this.pendingAuth.state){this.pendingAuth.reject(new Error("State mismatch")),this.pendingAuth=null;return}if(!n){this.pendingAuth.reject(new Error("No authorization code received")),this.pendingAuth=null;return}this.pendingAuth.resolve(n)}async authenticate(){let e=L(43),t=await this.generateCodeChallenge(e),n=L(32),s=this.buildAuthorizationUrl(t,n),i=new Promise((d,p)=>{this.pendingAuth={codeVerifier:e,state:n,resolve:d,reject:p},setTimeout(()=>{this.pendingAuth&&(this.pendingAuth.reject(new Error("OAuth flow timed out")),this.pendingAuth=null)},300*1e3)});if(this.output.appendLine("[LanOnasis] Opening browser for OAuth..."),!await c.env.openExternal(c.Uri.parse(s)))throw this.pendingAuth=null,new Error("Failed to open browser");let r=await i;this.output.appendLine("[LanOnasis] Exchanging code for tokens...");let l=await this.exchangeCodeForTokens(r,e);return this.pendingAuth=null,l}},k=class{constructor(e,t,n,s){this.context=e;this.output=t;this.oauthFlow=n;this.cache=s}static{this.viewType="lzero.memorySidebar"}resolveWebviewView(e,t,n){this.view=e;let s=e.webview;s.options={enableScripts:!0,localResourceRoots:[c.Uri.joinPath(this.context.extensionUri,"media")]},this.output.appendLine("[LanOnasis] Initializing sidebar webview"),s.html=this.getWebviewHtml(s),s.onDidReceiveMessage(i=>{if(!(!i||typeof i!="object")){if(i.type==="lanonasis:webview-ready"){this.output.appendLine("[LanOnasis] Webview ready"),s.postMessage({type:"lanonasis:host-ready"});let o=this.cache.getMemories(),r=this.cache.getStatus();s.postMessage({type:"lanonasis:cache:data",payload:{memories:o,status:r}}),this.sendConfigToWebview(s);return}if(i.type==="lanonasis:request-auth"){this.handleOAuthLogin(s);return}if(i.type==="lanonasis:submit-api-key"){let o=i.payload?.apiKey;o&&this.handleApiKeySubmit(s,o);return}if(i.type==="lanonasis:logout"){this.handleLogout(s);return}if(i.type==="lanonasis:open-settings"){c.commands.executeCommand("workbench.action.openSettings","lzero");return}if(i.type==="lanonasis:open-dashboard"){let o=i.payload?.section,r=J(),l=o?`${r}#${o}`:r;c.env.openExternal(c.Uri.parse(l));return}if(i.type==="lanonasis:clipboard:read"){c.env.clipboard.readText().then(o=>{s.postMessage({type:"lanonasis:clipboard:read:result",payload:{text:o}})});return}if(i.type==="lanonasis:clipboard:write"){let o=i.payload?.text;typeof o=="string"&&c.env.clipboard.writeText(o);return}if(i.type==="lanonasis:cache:get"){let o=this.cache.getMemories(),r=this.cache.getStatus();s.postMessage({type:"lanonasis:cache:data",payload:{memories:o,status:r}});return}if(i.type==="lanonasis:cache:search"){let o=i.payload?.query;if(o){let r=this.cache.semanticSearchLocal(o);s.postMessage({type:"lanonasis:cache:search:result",payload:{results:r,query:o}})}return}if(i.type==="lanonasis:cache:add"){let o=i.payload?.memory;o&&this.cache.addLocal(o).then(r=>{s.postMessage({type:"lanonasis:cache:added",payload:{memory:r}})});return}if(i.type==="lanonasis:cache:update"){let o=i.payload?.id,r=i.payload?.updates;o&&r&&this.cache.queueUpdate(o,r).then(()=>{let l=this.cache.getMemoryById(o);s.postMessage({type:"lanonasis:cache:updated",payload:{memory:l,status:this.cache.getStatus()}})});return}if(i.type==="lanonasis:cache:delete"){let o=i.payload?.id;o&&this.cache.queueDelete(o).then(()=>{s.postMessage({type:"lanonasis:cache:deleted",payload:{id:o,status:this.cache.getStatus()}})});return}if(i.type==="lanonasis:cache:clear"){this.cache.clearAll().then(()=>{s.postMessage({type:"lanonasis:cache:cleared",payload:{status:this.cache.getStatus()}})});return}if(i.type==="lanonasis:cache:sync"){this.syncMemories(s);return}if(i.type==="lanonasis:ai:search"){let o=i.payload?.query;o&&this.handleAISearch(s,o);return}}})}async syncMemories(e){this.cache.setSyncing(!0),e.postMessage({type:"lanonasis:sync:start"});try{let t=await this.getStoredApiKey();if(!t){e.postMessage({type:"lanonasis:sync:error",payload:{error:"Not authenticated"}});return}let n=M(),s={"X-API-Key":t,"Content-Type":"application/json"},i=this.cache.getPendingQueue(),o={success:0,failed:0};for(let p of i)try{if(p._pending==="create"){let u=new AbortController,y=setTimeout(()=>u.abort(),3e4);try{let h=await fetch(`${n}/functions/v1/memory-create`,{method:"POST",headers:s,signal:u.signal,body:JSON.stringify({title:p.title,content:p.content,memory_type:p.memory_type,tags:p.tags})});if(h.ok){let g=await h.json(),A=g.data||g.memory||g;await this.cache.markSynced(p._localId||p.id,A),o.success++,this.output.appendLine(`[LanOnasis] Synced new memory: ${p.title}`)}else o.failed++,this.output.appendLine(`[LanOnasis] Failed to sync memory: ${p.title} (${h.status})`)}finally{clearTimeout(y)}}else if(p._pending==="update"){let u=new AbortController,y=setTimeout(()=>u.abort(),3e4);try{let h=await fetch(`${n}/functions/v1/memory-update`,{method:"POST",headers:s,signal:u.signal,body:JSON.stringify({id:p.id,title:p.title,content:p.content,memory_type:p.memory_type,tags:p.tags})});if(h.ok){let g=await h.json(),A=g.data||g.memory||g;await this.cache.markSynced(p.id,A),o.success++}else o.failed++}finally{clearTimeout(y)}}else if(p._pending==="delete"){let u=new AbortController,y=setTimeout(()=>u.abort(),3e4);try{(await fetch(`${n}/functions/v1/memory-delete`,{method:"POST",headers:s,signal:u.signal,body:JSON.stringify({id:p.id})})).ok?(await this.cache.removePending(p.id),o.success++):o.failed++}finally{clearTimeout(y)}}}catch(u){o.failed++,this.output.appendLine(`[LanOnasis] Error syncing pending item: ${u}`)}i.length>0&&this.output.appendLine(`[LanOnasis] Sync results: ${o.success} succeeded, ${o.failed} failed`);let r=await fetch(`${n}/functions/v1/memory-list?limit=100`,{headers:s});if(!r.ok)throw new Error(`API error: ${r.status}`);let l=await r.json(),d=l.data?.memories||l.memories||l.data||l||[];await this.cache.updateFromApi(d),this.cache.setOnline(!0),e.postMessage({type:"lanonasis:sync:complete",payload:{memories:d,status:this.cache.getStatus(),syncResults:o}})}catch(t){let n=String(t),s=n.includes("fetch")||n.includes("network")||n.includes("ECONNREFUSED")||n.includes("ETIMEDOUT");s&&this.cache.setOnline(!1),this.output.appendLine(`[LanOnasis] Sync error: ${t}`),e.postMessage({type:"lanonasis:sync:error",payload:{error:n,isNetworkError:s}})}finally{this.cache.setSyncing(!1)}}async handleAISearch(e,t){try{let n=this.cache.semanticSearchLocal(t);e.postMessage({type:"lanonasis:ai:search:local",payload:{results:n,query:t}});let s=await this.getStoredApiKey();if(s){let i=M(),o=await fetch(`${i}/functions/v1/memory-search`,{method:"POST",headers:{"X-API-Key":s,"Content-Type":"application/json"},body:JSON.stringify({query:t,limit:10,threshold:.7})});if(o.ok){let r=await o.json(),l=r.data?.results||r.results||r.data||[];e.postMessage({type:"lanonasis:ai:search:api",payload:{results:l,query:t}})}}}catch(n){this.output.appendLine(`[LanOnasis] AI search error: ${n}`)}}async getStoredApiKey(){try{let e=await this.context.secrets.get(m.OAUTH_TOKENS);if(e){let t=JSON.parse(e),s=(t.issued_at??Date.now())+t.expires_in*1e3;if(Date.now()<=s-300*1e3)return t.access_token;this.output.appendLine("[LanOnasis] OAuth token expired")}}catch(e){this.output.appendLine(`[LanOnasis] Failed to parse OAuth tokens: ${e}`)}try{return await this.context.secrets.get(m.API_KEY)}catch(e){this.output.appendLine(`[LanOnasis] Failed to get API key: ${e}`)}}async sendConfigToWebview(e){let t=c.workspace.getConfiguration("lzero"),n=c.workspace.getConfiguration("lanonasis"),s=q(),i,o=null;try{let r=await this.context.secrets.get(m.OAUTH_TOKENS);if(r){let l=JSON.parse(r);if(l.scope&&(l.scope.includes("memory:")||l.scope.includes("api_keys:manage")))this.output.appendLine("[LanOnasis] Clearing cached tokens with old scopes"),await this.context.secrets.delete(m.OAUTH_TOKENS);else{let u=(l.issued_at??Date.now())+l.expires_in*1e3;Date.now()<=u-300*1e3&&(i=l.access_token,o=U(l.access_token),this.output.appendLine("[LanOnasis] Found valid OAuth token"))}}}catch(r){this.output.appendLine("[LanOnasis] Token error: "+String(r))}if(!i)try{let r=await this.context.secrets.get(m.API_KEY);r&&(i=r,this.output.appendLine("[LanOnasis] Found API key"))}catch(r){this.output.appendLine("[LanOnasis] API key error: "+String(r))}e.postMessage({type:"lanonasis:config:init",payload:{apiUrl:s,apiKey:i,user:o}})}async handleOAuthLogin(e){try{let t=await this.oauthFlow.authenticate();if(!t?.access_token)throw new Error("No tokens received");let n={...t,issued_at:Date.now()};await this.context.secrets.store(m.OAUTH_TOKENS,JSON.stringify(n)),e.postMessage({type:"lanonasis:auth:result",payload:{success:!0}}),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:t.access_token,user:U(t.access_token)}}),await c.window.showInformationMessage("LanOnasis: Connected via OAuth!")}catch(t){let n=t instanceof Error?t.message:String(t);this.output.appendLine("[LanOnasis] OAuth error: "+n),e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:n}})}}async handleApiKeySubmit(e,t){try{if(!t||!V(t)){e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:"Invalid API key format"}});return}await this.context.secrets.store(m.API_KEY,t),e.postMessage({type:"lanonasis:auth:result",payload:{success:!0}}),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:t,user:null}}),await c.window.showInformationMessage("LanOnasis: Connected!")}catch(n){let s=n instanceof Error?n.message:String(n);e.postMessage({type:"lanonasis:auth:result",payload:{success:!1,error:s}})}}async handleLogout(e){try{await this.context.secrets.delete(m.API_KEY),await this.context.secrets.delete(m.OAUTH_TOKENS),e.postMessage({type:"lanonasis:config:update",payload:{apiKey:null,user:null}}),await c.window.showInformationMessage("LanOnasis: Logged out")}catch(t){this.output.appendLine("[LanOnasis] Logout error: "+String(t))}}postMessage(e){this.view&&this.view.webview.postMessage(e)}getWebviewHtml(e){let t=X(),n=e.asWebviewUri(c.Uri.joinPath(this.context.extensionUri,"media","sidebar-react.js")),s=e.asWebviewUri(c.Uri.joinPath(this.context.extensionUri,"media","lzero-memory.css"));return'<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta http-equiv="Content-Security-Policy" content="'+["default-src 'none'","img-src "+e.cspSource+" https: data:","style-src "+e.cspSource+" 'unsafe-inline'","font-src "+e.cspSource+" https: data:","script-src 'nonce-"+t+"' 'wasm-unsafe-eval'","connect-src https: wss: http://localhost:*"].join("; ")+'"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="stylesheet" href="'+s+'"/><title>LanOnasis Memory</title><style>body{background:var(--vscode-sideBar-background,#252526);color:var(--vscode-sideBar-foreground,#ccc);font-family:var(--vscode-font-family,sans-serif);margin:0;padding:0}#loading{padding:20px;text-align:center}#error{padding:20px;color:#f48771;display:none;white-space:pre-wrap;font-size:12px}</style></head><body><div id="loading">Loading L0 Memory...</div><div id="error"></div><div id="root"></div><script nonce="'+t+'">var errors=[];window.onerror=function(m,u,l){errors.push(m+" at "+u+":"+l);document.getElementById("error").style.display="block";document.getElementById("error").textContent="JS Error:\\n"+errors.join("\\n");document.getElementById("loading").style.display="none";return false};window.addEventListener("unhandledrejection",function(e){errors.push("Promise: "+(e.reason?.message||e.reason||"Unknown"));document.getElementById("error").style.display="block";document.getElementById("error").textContent="Promise Error:\\n"+errors.join("\\n");document.getElementById("loading").style.display="none"});<\/script><script nonce="'+t+'" type="module" src="'+n+`" onerror="document.getElementById('error').textContent='Failed to load script';document.getElementById('error').style.display='block';document.getElementById('loading').style.display='none';"><\/script><script nonce="`+t+'">var observer=new MutationObserver(function(){if(document.getElementById("root").children.length>0){document.getElementById("loading").style.display="none";observer.disconnect()}});observer.observe(document.getElementById("root"),{childList:true});setTimeout(function(){if(document.getElementById("root").children.length===0){document.getElementById("error").textContent="React failed to mount";document.getElementById("error").style.display="block";document.getElementById("loading").style.display="none"}},5000);<\/script></body></html>'}};function X(){let a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(let t=0;t<32;t++)e+=a.charAt(Math.floor(Math.random()*a.length));return e}function Z(a){let e=c.window.createOutputChannel("LanOnasis Memory");e.appendLine("[LanOnasis] Extension activating...");let t=c.workspace.getConfiguration("lzero").get("retainContextWhenHidden",!1),n=new S(a,e);_=n;let s=new P(e),i=c.window.registerUriHandler({handleUri(d){e.appendLine("[LanOnasis] URI callback: "+d.path),d.path==="/callback"&&s.handleCallback(d)}});a.subscriptions.push(i);let o=new k(a,e,s,n),r=async()=>{try{let d=await a.secrets.get(m.OAUTH_TOKENS);if(d)return JSON.parse(d).access_token}catch(d){e.appendLine(`[LanOnasis] Chat: Failed to get OAuth token: ${d}`)}try{return await a.secrets.get(m.API_KEY)}catch(d){e.appendLine(`[LanOnasis] Chat: Failed to get API key: ${d}`)}};new b(a,e,n,M(),r).register(),a.subscriptions.push(c.window.registerWebviewViewProvider(k.viewType,o,{webviewOptions:{retainContextWhenHidden:t}})),a.subscriptions.push(c.commands.registerCommand("lzeroMemory.authenticate",async()=>{try{let d=await s.authenticate();d.access_token&&(await a.secrets.store(m.OAUTH_TOKENS,JSON.stringify({...d,issued_at:Date.now()})),await c.window.showInformationMessage("LanOnasis: Authenticated!"))}catch(d){let p=d instanceof Error?d.message:String(d);await c.window.showErrorMessage("LanOnasis: Auth failed - "+p)}})),a.subscriptions.push(c.commands.registerCommand("lzeroMemory.createMemoryFromSelection",async()=>{let d=c.window.activeTextEditor;if(!d){await c.window.showInformationMessage("No active editor");return}let p=d.document.getText(d.selection);if(!p){await c.window.showInformationMessage("No text selected");return}o.postMessage({type:"lanonasis:inject-chat",payload:{text:p}}),await c.commands.executeCommand("lzero.memorySidebar.focus")})),a.subscriptions.push(c.commands.registerCommand("lzeroMemory.syncMemories",async()=>{o.postMessage({type:"lanonasis:cache:sync"}),await c.window.showInformationMessage("LanOnasis: Syncing memories...")})),a.subscriptions.push(c.commands.registerCommand("lzeroMemory.searchMemories",async()=>{let d=await c.window.showInputBox({prompt:"Search your memories",placeHolder:"e.g., OAuth implementation, regex pattern..."});if(d){let p=n.semanticSearchLocal(d);if(p.length===0){await c.window.showInformationMessage(`No memories found for "${d}"`);return}let u=p.map(h=>({label:h.title,description:h.memory_type,detail:h.content.slice(0,100)+(h.content.length>100?"...":""),memory:h})),y=await c.window.showQuickPick(u,{placeHolder:`Found ${p.length} memories`,matchOnDescription:!0,matchOnDetail:!0});y&&(await c.env.clipboard.writeText(y.memory.content),await c.window.showInformationMessage(`Copied "${y.label}" to clipboard`))}})),a.subscriptions.push({dispose:()=>n.stopConnectivityCheck()}),e.appendLine("[LanOnasis] Extension activated")}function ee(){_?.stopConnectivityCheck(),_=null}
